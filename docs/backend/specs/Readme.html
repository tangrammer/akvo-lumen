<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2018-06-20 Wed 16:03 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>akvo-lumen specs</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="tangrammer" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="https://www.pirilampo.org/styles/readtheorg/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="https://www.pirilampo.org/styles/readtheorg/css/readtheorg.css"/>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script type="text/javascript" src="https://www.pirilampo.org/styles/lib/js/jquery.stickytableheaders.min.js"></script>
<script type="text/javascript" src="https://www.pirilampo.org/styles/readtheorg/js/readtheorg.js"></script>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2018 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">akvo-lumen specs</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org4556153">1. Welcome to specs generated with LP&#xa0;&#xa0;&#xa0;<span class="tag"><span class="index">index</span></span></a>
<ul>
<li><a href="#orge626784">1.1. specs</a>
<ul>
<li><a href="#orgc188a5c">1.1.1. <span class="todo TODO">TODO</span> core</a></li>
</ul>
</li>
<li><a href="#org8bb04ab">1.2. aggregation&#xa0;&#xa0;&#xa0;<span class="tag"><span class="aggregation">aggregation</span></span></a>
<ul>
<li><a href="#orgdec18f6">1.2.1. aggregation domain&#xa0;&#xa0;&#xa0;<span class="tag"><span class="aggregation">aggregation</span></span></a></li>
<li><a href="#org87ae949">1.2.2. aggregation.spec ns&#xa0;&#xa0;&#xa0;<span class="tag"><span class="ns">ns</span></span></a></li>
<li><a href="#orgdf5ff26">1.2.3. filter specs</a></li>
<li><a href="#org9f09655">1.2.4. aggregation.query</a></li>
<li><a href="#org4454000">1.2.5. a.pivot.row.s</a></li>
<li><a href="#org50a95ee">1.2.6. utils</a></li>
<li><a href="#org87e69c6">1.2.7. pivot</a></li>
<li><a href="#org15f1516">1.2.8. pie</a></li>
<li><a href="#org88b1037">1.2.9. endpoint</a></li>
<li><a href="#orgba5ff7d">1.2.10. lib</a></li>
<li><a href="#org668a2f8">1.2.11. testing&#xa0;&#xa0;&#xa0;<span class="tag"><span class="tests">tests</span></span></a></li>
<li><a href="#org17e0885">1.2.12. <span class="todo TODO">TODO</span> RENAME type to column-type and columnName to column-name</a></li>
<li><a href="#org26156d6">1.2.13. database &#x2026; tenant aggregation tables&#xa0;&#xa0;&#xa0;<span class="tag"><span class="sql">sql</span></span></a></li>
</ul>
</li>
<li><a href="#orge0b8e79">1.3. visualisation&#xa0;&#xa0;&#xa0;<span class="tag"><span class="visualisation">visualisation</span></span></a>
<ul>
<li><a href="#org48877b7">1.3.1. glossary</a></li>
<li><a href="#orgd968aef">1.3.2. visualisation maps domain&#xa0;&#xa0;&#xa0;<span class="tag"><span class="visualisation">visualisation</span></span></a></li>
<li><a href="#orgab7f68b">1.3.3. visualisation layer legend</a></li>
<li><a href="#orgacdeb3b">1.3.4. visualisation layer spec</a></li>
<li><a href="#org4474496">1.3.5. visualisation layer</a></li>
<li><a href="#org66621ca">1.3.6. visualisation ns&#xa0;&#xa0;&#xa0;<span class="tag"><span class="ns">ns</span></span></a></li>
<li><a href="#org828739b">1.3.7. data sample</a></li>
<li><a href="#org8f8ff2e">1.3.8. db</a></li>
<li><a href="#orgc68928f">1.3.9. <span class="todo TODO">TODO</span> keep working with libs/maps</a></li>
</ul>
</li>
<li><a href="#org4902016">1.4. components&#xa0;&#xa0;&#xa0;<span class="tag"><span class="components">components</span></span></a>
<ul>
<li><a href="#org003ae84">1.4.1. specs.components</a></li>
</ul>
</li>
<li><a href="#org4d9020c">1.5. config&#xa0;&#xa0;&#xa0;<span class="tag"><span class="config">config</span></span></a>
<ul>
<li><a href="#orgefa7fe8">1.5.1. specs.config</a></li>
</ul>
</li>
<li><a href="#orgdaac2a9">1.6. db&#xa0;&#xa0;&#xa0;<span class="tag"><span class="db">db</span></span></a>
<ul>
<li><a href="#org7e55d00">1.6.1. specs.db</a></li>
</ul>
</li>
<li><a href="#orged87778">1.7. endpoints&#xa0;&#xa0;&#xa0;<span class="tag"><span class="endpoints">endpoints</span></span></a>
<ul>
<li><a href="#orgc26f5ce">1.7.1. specs.endpoints</a></li>
</ul>
</li>
<li><a href="#org48dc5e2">1.8. imports&#xa0;&#xa0;&#xa0;<span class="tag"><span class="imports">imports</span></span></a>
<ul>
<li><a href="#org9d1c492">1.8.1. specs.imports</a></li>
</ul>
</li>
<li><a href="#org8cfdae5">1.9. libs&#xa0;&#xa0;&#xa0;<span class="tag"><span class="libs">libs</span></span></a>
<ul>
<li><a href="#org7b51de6">1.9.1. specs.libs</a></li>
</ul>
</li>
<li><a href="#org0cffe99">1.10. transformations&#xa0;&#xa0;&#xa0;<span class="tag"><span class="transformations">transformations</span></span></a>
<ul>
<li><a href="#org34333d9">1.10.1. <span class="done DONE">DONE</span> multimethod transformation/transformation</a></li>
<li><a href="#orgb69f096">1.10.2. specs</a></li>
<li><a href="#org6dbc774">1.10.3. funs</a></li>
<li><a href="#org9768a4f">1.10.4. derive</a></li>
<li><a href="#org26b4dc1">1.10.5. js-engine</a></li>
<li><a href="#org94e6ecc">1.10.6. data sample</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org9657543">2. <span class="todo TODO">TODO</span> specs problems to confront with</a>
<ul>
<li><a href="#org13276df">2.1. <span class="todo TODO">TODO</span> sort maps and connect to CIDER</a></li>
<li><a href="#orgb9b33b8">2.2. <span class="todo TODO">TODO</span> visual diff of clojure data</a></li>
</ul>
</li>
<li><a href="#org8472d57">3. tools&#xa0;&#xa0;&#xa0;<span class="tag"><span class="index">index</span></span></a>
<ul>
<li><a href="#org1507368">3.1. dev</a>
<ul>
<li><a href="#org681accd">3.1.1. dev tasks</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org3b6275d">4. learning LP</a>
<ul>
<li><a href="#org98b693a">4.1. tagging by domain, keep generic/abstract</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-org4556153" class="outline-2">
<h2 id="org4556153"><span class="section-number-2">1</span> Welcome to specs generated with LP&#xa0;&#xa0;&#xa0;<span class="tag"><span class="index">index</span></span></h2>
<div class="outline-text-2" id="text-1">
<p>
This is the first interaction with <a href="https://clojure.org/guides/spec">clojure core.spec</a>
thus is a fresh topic at lumen codebase we're trying <b>Literate Programming (LP)</b> independent approach to write the specs
</p>

<p>
Main idea of <b>LP</b> is that you write the code having a closer actitude of documenting a development process instead of writing as a super start cryptic haker that only a machine could follow
</p>

<p>
The tools used for using <b>LP</b> are <a href="https://www.gnu.org/software/emacs/">Emacs</a>, <a href="https://orgmode.org/">orgmode</a> and <a href="https://orgmode.org/worg/org-contrib/babel/">babel</a>
</p>


<p>
Following you'll find the main topics covered in lumen
</p>
</div>

<div id="outline-container-orge626784" class="outline-3">
<h3 id="orge626784"><span class="section-number-3">1.1</span> specs</h3>
<div class="outline-text-3" id="text-1-1">
</div>
<div id="outline-container-orgc188a5c" class="outline-4">
<h4 id="orgc188a5c"><span class="section-number-4">1.1.1</span> <span class="todo TODO">TODO</span> core</h4>
<div class="outline-text-4" id="text-1-1-1">
<p>
Here common utilities for defining lumen specs
</p>
<ul class="org-ul">
<li class="off"><code>[&#xa0;]</code> <p>
think about having generator in <code>prod</code> side &#x2026; <code>sample</code> functionality
</p></li>
</ul>
</div>

<ol class="org-ol">
<li><a id="org782bafb"></a>lumen.core specs<br />
<div class="outline-text-5" id="text-1-1-1-1">
<p>
base specs to be reused in other specs
</p>

<p>
also included a function <code>sample</code> to generate sample data having a spec
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #707183;">(</span><span style="color: #0000FF;">ns</span> <span style="color: #6434A3;">akvo.lumen.specs.core</span>
  <span style="color: #7388D6;">(</span><span style="color: #D0372D;">:require</span> <span style="color: #909183;">[</span>clojure.spec.alpha <span style="color: #D0372D;">:as</span> s<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>clojure.spec.gen.alpha <span style="color: #D0372D;">:as</span> gen<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>akvo.lumen.util <span style="color: #D0372D;">:refer</span> <span style="color: #709870;">(</span>squuid<span style="color: #709870;">)</span><span style="color: #909183;">]</span><span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #D0372D;">:import</span> javax.sql.DataSource<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">defn</span> <span style="color: #006699;">exception?</span> <span style="color: #7388D6;">[</span>e<span style="color: #7388D6;">]</span>
  <span style="color: #7388D6;">(</span>instance? java.lang.Exception e<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">defn</span> <span style="color: #006699;">db-connection?</span> <span style="color: #7388D6;">[</span>o<span style="color: #7388D6;">]</span>
  <span style="color: #7388D6;">(</span>satisfies? javax.sql.DataSource o<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::any</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/with-gen
               <span style="color: #909183;">(</span>constantly <span style="color: #D0372D;">true</span><span style="color: #909183;">)</span>
               #<span style="color: #909183;">(</span><span style="color: #6434A3;">s</span>/gen #<span style="color: #709870;">{</span><span style="color: #907373;">{}</span><span style="color: #709870;">}</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">defn</span> <span style="color: #006699;">str-uuid?</span> <span style="color: #7388D6;">[</span>v<span style="color: #7388D6;">]</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">when</span> <span style="color: #909183;">(</span>some? v<span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span>uuid? <span style="color: #709870;">(</span>read-string <span style="color: #907373;">(</span>format <span style="color: #008000;">"#uuid </span><span style="color: #000000; font-weight: bold;">\"</span><span style="color: #008000;">%s</span><span style="color: #000000; font-weight: bold;">\"</span><span style="color: #008000;">"</span> v<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::str-uuid</span>
  <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/with-gen
    str-uuid?
    #<span style="color: #909183;">(</span><span style="color: #6434A3;">s</span>/gen <span style="color: #709870;">(</span>reduce <span style="color: #907373;">(</span><span style="color: #0000FF;">fn</span> <span style="color: #6276BA;">[</span>c _<span style="color: #6276BA;">]</span> <span style="color: #6276BA;">(</span>conj c <span style="color: #858580;">(</span>str <span style="color: #80A880;">(</span>squuid<span style="color: #80A880;">)</span><span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span> #<span style="color: #907373;">{}</span> <span style="color: #907373;">(</span>range 100<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>


<span style="color: #707183;">(</span><span style="color: #0000FF;">defn</span> <span style="color: #006699;">str-int?</span> <span style="color: #7388D6;">[</span>v<span style="color: #7388D6;">]</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">when</span> <span style="color: #909183;">(</span>some? v<span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #0000FF;">try</span>
      <span style="color: #709870;">(</span>int? <span style="color: #907373;">(</span>read-string v<span style="color: #907373;">)</span><span style="color: #709870;">)</span>
      <span style="color: #709870;">(</span><span style="color: #0000FF;">catch</span> Exception e <span style="color: #907373;">(</span>println <span style="color: #6276BA;">(</span>format  <span style="color: #008000;">"cant parse %s as int"</span> v<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::str-int</span>
  <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/with-gen
    str-int?
    #<span style="color: #909183;">(</span><span style="color: #6434A3;">s</span>/gen <span style="color: #709870;">(</span>set <span style="color: #907373;">(</span>map str <span style="color: #6276BA;">(</span>repeatedly 100 <span style="color: #858580;">(</span>partial rand-int 100<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::date-int</span> int?<span style="color: #707183;">)</span> <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">TODO: improve it </span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::string-nullable</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/or <span style="color: #D0372D;">:s</span> string? <span style="color: #D0372D;">:n</span> nil?<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::int-nullable</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/or <span style="color: #D0372D;">:s</span> int? <span style="color: #D0372D;">:n</span> nil?<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">defn</span> <span style="color: #006699;">sample</span>
  <span style="color: #7388D6;">(</span><span style="color: #909183;">[</span>spec<span style="color: #909183;">]</span>
   <span style="color: #909183;">(</span><span style="color: #6434A3;">gen</span>/generate <span style="color: #709870;">(</span><span style="color: #6434A3;">s</span>/gen spec<span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #909183;">[</span>m spec<span style="color: #909183;">]</span>
   <span style="color: #909183;">(</span>assoc m <span style="color: #709870;">(</span>keyword <span style="color: #907373;">(</span>str <span style="color: #6276BA;">(</span>namespace spec<span style="color: #6276BA;">)</span> <span style="color: #008000;">"/"</span> <span style="color: #6276BA;">(</span>name spec<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span> <span style="color: #709870;">(</span>sample spec<span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">defn</span> <span style="color: #006699;">sample-all</span> <span style="color: #7388D6;">[</span>specs<span style="color: #7388D6;">]</span>
  <span style="color: #7388D6;">(</span>reduce sample <span style="color: #909183;">{}</span> specs<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>
</div>


<ol class="org-ol">
<li><a id="org37375d8"></a>samples<br />
<div class="outline-text-6" id="text-1-1-1-1-1">
<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #707183;">(</span><span style="color: #0000FF;">in-ns</span> 'akvo.lumen.specs.core<span style="color: #707183;">)</span>

<span style="color: #707183;">[</span><span style="color: #D0372D;">::int-nullable</span> <span style="color: #7388D6;">(</span>sample <span style="color: #D0372D;">::int-nullable</span><span style="color: #7388D6;">)</span><span style="color: #707183;">]</span>
</pre>
</div>

<pre class="example">
[:akvo.lumen.specs.core/int-nullable nil]

</pre>
<ul class="org-ul">
<li class="off"><code>[&#xa0;]</code> testing <code>:ret</code> <a href="https://groups.google.com/forum/#!topic/clojure/JU6EmjtbRiQ">https://groups.google.com/forum/#!topic/clojure/JU6EmjtbRiQ</a> is not possible (using raw clojure.spec)
<ul class="org-ul">
<li><a href="https://github.com/jeaye/orchestra">https://github.com/jeaye/orchestra</a> option to test <code>:ret</code></li>
</ul></li>
</ul>
</div>
</li>
</ol>
</li>
</ol>
</div>
</div>

<div id="outline-container-org8bb04ab" class="outline-3">
<h3 id="org8bb04ab"><span class="section-number-3">1.2</span> aggregation&#xa0;&#xa0;&#xa0;<span class="tag"><span class="aggregation">aggregation</span></span></h3>
<div class="outline-text-3" id="text-1-2">
</div>

<div id="outline-container-orgdec18f6" class="outline-4">
<h4 id="orgdec18f6"><span class="section-number-4">1.2.1</span> aggregation domain&#xa0;&#xa0;&#xa0;<span class="tag"><span class="aggregation">aggregation</span></span></h4>
<div class="outline-text-4" id="text-1-2-1">
<p>
So what do we currently have in aggregation functionality &#x2026;
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-right">107</td>
<td class="org-left">../src/akvo/lumen/lib/aggregation/filter.clj</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-right">24</td>
<td class="org-left">../src/akvo/lumen/lib/aggregation/pie.clj</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-right">160</td>
<td class="org-left">../src/akvo/lumen/lib/aggregation/pivot.clj</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-right">10</td>
<td class="org-left">../src/akvo/lumen/lib/aggregation/utils.clj</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-right">301</td>
<td class="org-left">total</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-right">&#x2026;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#x2026;</td>
</tr>

<tr>
<td class="org-right">46</td>
<td class="org-left">../src/akvo/lumen/lib/aggregation.clj</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>

<p>
<b>=&gt; filter , pie, pivot, utils</b>
</p>

<p>
besides that we have a main ns <code>lib.aggregation</code> that just dispatch to pie or pivot nss
</p>


<blockquote>
<p>
A,B
a1,b1
a1,b1
a1,b1
a1,b2
a2,b1
a2,b1
a2,b2
a2,b2
</p>
</blockquote>
</div>
</div>
<div id="outline-container-org87ae949" class="outline-4">
<h4 id="org87ae949"><span class="section-number-4">1.2.2</span> aggregation.spec ns&#xa0;&#xa0;&#xa0;<span class="tag"><span class="ns">ns</span></span></h4>
<div class="outline-text-4" id="text-1-2-2">
<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #707183;">(</span><span style="color: #0000FF;">ns</span> <span style="color: #6434A3;">akvo.lumen.specs.aggregation</span>
  <span style="color: #7388D6;">(</span><span style="color: #D0372D;">:require</span> <span style="color: #909183;">[</span>akvo.lumen.component.tenant-manager <span style="color: #D0372D;">:as</span> tenant-manager<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>akvo.lumen.lib <span style="color: #D0372D;">:as</span> lib<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>akvo.lumen.lib.aggregation <span style="color: #D0372D;">:as</span> lib.aggregation<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>akvo.lumen.lib.aggregation.filter <span style="color: #D0372D;">:as</span> l.aggregation.filter<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>akvo.lumen.lib.aggregation.pie <span style="color: #D0372D;">:as</span> l.aggregation.pie<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>akvo.lumen.lib.aggregation.pivot <span style="color: #D0372D;">:as</span> l.aggregation.pivot<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>akvo.lumen.lib.aggregation.utils <span style="color: #D0372D;">:as</span> l.aggregation.utils<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>akvo.lumen.specs.aggregation.pivot.row <span style="color: #D0372D;">:as</span> a.pivot.row.s<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>akvo.lumen.specs.aggregation.query <span style="color: #D0372D;">:as</span> aggregation.query.s<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>akvo.lumen.specs.core <span style="color: #D0372D;">:as</span> lumen.s<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>akvo.lumen.specs.dataset <span style="color: #D0372D;">:as</span> dataset.s<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>akvo.lumen.specs.dataset.column <span style="color: #D0372D;">:as</span> dataset.column.s<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>akvo.lumen.specs.db <span style="color: #D0372D;">:as</span> db.s<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>akvo.lumen.specs.libs<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>clojure.spec.alpha <span style="color: #D0372D;">:as</span> s<span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgdf5ff26" class="outline-4">
<h4 id="orgdf5ff26"><span class="section-number-4">1.2.3</span> filter specs</h4>
<div class="outline-text-4" id="text-1-2-3">
<div class="org-src-container">
<pre class="src src-clojure">

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::l.aggregation.filter/filter</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/keys <span style="color: #D0372D;">:req-un</span> <span style="color: #909183;">[</span><span style="color: #D0372D;">::</span><span style="color: #6434A3;">aggregation.query.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">operation</span>
                                                      <span style="color: #D0372D;">::</span><span style="color: #6434A3;">aggregation.query.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">strategy</span>
                                                      <span style="color: #D0372D;">::</span><span style="color: #6434A3;">aggregation.query.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">value</span>
                                                      <span style="color: #D0372D;">::</span><span style="color: #6434A3;">dataset.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">column</span><span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>


<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::l.aggregation.filter/categoryColumn</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">dataset.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">column</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::l.aggregation.filter/rowColumn</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">dataset.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">column</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::l.aggregation.filter/valueColumn</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">dataset.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">column</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::l.aggregation.filter/aggregation</span> string?<span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::l.aggregation.filter/filters</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/coll-of <span style="color: #D0372D;">::</span><span style="color: #6434A3;">l.aggregation.filter</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">filter</span> <span style="color: #D0372D;">:gen-max</span> 3<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/fdef <span style="color: #6434A3;">l.aggregation.filter</span>/sql-str
  <span style="color: #D0372D;">:args</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/cat
         <span style="color: #D0372D;">:columns</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">dataset.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">columns</span>
         <span style="color: #D0372D;">:filters</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">aggregation.query.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">filters</span><span style="color: #7388D6;">)</span>
  <span style="color: #D0372D;">:ret</span> string?<span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/fdef <span style="color: #6434A3;">l.aggregation.filter</span>/find-column
  <span style="color: #D0372D;">:args</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/cat
         <span style="color: #D0372D;">:columns</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">dataset.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">columns</span>
         <span style="color: #D0372D;">:column-name</span> string?<span style="color: #7388D6;">)</span>
  <span style="color: #D0372D;">:ret</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">dataset.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">column</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/fdef <span style="color: #6434A3;">l.aggregation.filter</span>/filter-sql
  <span style="color: #D0372D;">:args</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/cat
         <span style="color: #D0372D;">:filter</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">l.aggregation.filter</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">filter</span><span style="color: #7388D6;">)</span>
  <span style="color: #D0372D;">:ret</span> string?<span style="color: #707183;">)</span>


<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::l.aggregation.filter/comparison-op</span> #<span style="color: #7388D6;">{</span><span style="color: #008000;">"&gt;"</span> <span style="color: #008000;">"&lt;="</span><span style="color: #7388D6;">}</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/fdef <span style="color: #6434A3;">l.aggregation.filter</span>/comparison
  <span style="color: #D0372D;">:args</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/cat
         <span style="color: #D0372D;">:op</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">l.aggregation.filter</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">comparison-op</span>
         <span style="color: #D0372D;">:column-type</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">dataset.column.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">type</span>
         <span style="color: #D0372D;">:column-name</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">dataset.column.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">columnName</span>
         <span style="color: #D0372D;">:value</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">aggregation.query.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">value</span><span style="color: #7388D6;">)</span>
  <span style="color: #D0372D;">:ret</span> string?<span style="color: #707183;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org9f09655" class="outline-4">
<h4 id="org9f09655"><span class="section-number-4">1.2.4</span> aggregation.query</h4>
<div class="outline-text-4" id="text-1-2-4">
<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #707183;">(</span><span style="color: #0000FF;">ns</span> <span style="color: #6434A3;">akvo.lumen.specs.aggregation.query</span>
  <span style="color: #7388D6;">(</span><span style="color: #D0372D;">:require</span> <span style="color: #909183;">[</span>akvo.lumen.specs.core <span style="color: #D0372D;">:as</span> lumen.s<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>clojure.spec.alpha <span style="color: #D0372D;">:as</span> s<span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::operation</span> #<span style="color: #7388D6;">{</span><span style="color: #008000;">"keep"</span>  <span style="color: #008000;">"remove"</span><span style="color: #7388D6;">}</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::strategy</span> #<span style="color: #7388D6;">{</span><span style="color: #008000;">"isHigher"</span> <span style="color: #008000;">"isLower"</span> <span style="color: #008000;">"is"</span> <span style="color: #008000;">"isEmpty"</span><span style="color: #7388D6;">}</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::value</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">lumen.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">string-nullable</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::column</span> string?<span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::filter</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/keys <span style="color: #D0372D;">:req-un</span> <span style="color: #909183;">[</span><span style="color: #D0372D;">::operation</span>
                                 <span style="color: #D0372D;">::strategy</span>
                                 <span style="color: #D0372D;">::value</span>
                                 <span style="color: #D0372D;">::column</span><span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::filters</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/or <span style="color: #D0372D;">:col</span> <span style="color: #909183;">(</span><span style="color: #6434A3;">s</span>/coll-of <span style="color: #D0372D;">::filter</span> <span style="color: #D0372D;">:gen-max</span> 3<span style="color: #909183;">)</span>
                       <span style="color: #D0372D;">:nil</span> nil?<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::aggregation</span> #<span style="color: #7388D6;">{</span><span style="color: #008000;">"mean"</span> <span style="color: #008000;">"sum"</span> <span style="color: #008000;">"min"</span> <span style="color: #008000;">"max"</span> <span style="color: #008000;">"count"</span><span style="color: #7388D6;">}</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::categoryColumn</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/or <span style="color: #D0372D;">:c</span> <span style="color: #D0372D;">::column</span> <span style="color: #D0372D;">:n</span> nil?<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::rowColumn</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/or <span style="color: #D0372D;">:c</span> <span style="color: #D0372D;">::column</span> <span style="color: #D0372D;">:n</span> nil?<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::valueColumn</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/or <span style="color: #D0372D;">:c</span> <span style="color: #D0372D;">::column</span> <span style="color: #D0372D;">:n</span> nil?<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org4454000" class="outline-4">
<h4 id="org4454000"><span class="section-number-4">1.2.5</span> a.pivot.row.s</h4>
<div class="outline-text-4" id="text-1-2-5">
<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #707183;">(</span><span style="color: #0000FF;">ns</span> <span style="color: #6434A3;">akvo.lumen.specs.aggregation.pivot.row</span>
  <span style="color: #7388D6;">(</span><span style="color: #D0372D;">:require</span> <span style="color: #909183;">[</span>akvo.lumen.specs.core <span style="color: #D0372D;">:as</span> lumen.s<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>clojure.spec.alpha <span style="color: #D0372D;">:as</span> s<span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::type</span> string?<span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::title</span> string?<span style="color: #707183;">)</span>

</pre>
</div>
</div>
</div>

<div id="outline-container-org50a95ee" class="outline-4">
<h4 id="org50a95ee"><span class="section-number-4">1.2.6</span> utils</h4>
<div class="outline-text-4" id="text-1-2-6">
<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/fdef <span style="color: #6434A3;">l.aggregation.utils</span>/find-column
  <span style="color: #D0372D;">:args</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/cat <span style="color: #D0372D;">:columns</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">dataset.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">columns</span>
               <span style="color: #D0372D;">:column-name</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">lumen.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">string-nullable</span><span style="color: #7388D6;">)</span>
  <span style="color: #D0372D;">:ret</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">dataset.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">column</span><span style="color: #707183;">)</span>

</pre>
</div>
</div>
</div>

<div id="outline-container-org87e69c6" class="outline-4">
<h4 id="org87e69c6"><span class="section-number-4">1.2.7</span> pivot</h4>
<div class="outline-text-4" id="text-1-2-7">
<p>
<a href="file:///Users/tangrammer/git/akvo/akvo-lumen/backend/src/akvo/lumen/lib/aggregation/pivot.clj#MissingReference">pivot-ns</a>
<a href="file:///Users/tangrammer/git/akvo/akvo-lumen/backend/test/akvo/lumen/lib/pivot_test.clj#MissingReference">getting into pivot using tests</a>
<a href="file:///Users/tangrammer/git/akvo/akvo-lumen/backend/test/resources/pivot.csv#MissingReference">data-pivot-tests</a>
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::l.aggregation.pivot/category-column</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">dataset.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">column</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::l.aggregation.pivot/row-column</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">dataset.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">column</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::l.aggregation.pivot/value-column</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">dataset.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">column</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::l.aggregation.pivot/aggregation</span> #<span style="color: #7388D6;">{</span><span style="color: #008000;">"avg"</span> <span style="color: #008000;">"sum"</span> <span style="color: #008000;">"min"</span> <span style="color: #008000;">"max"</span> <span style="color: #008000;">"count"</span><span style="color: #7388D6;">}</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::l.aggregation.pivot/query</span>
  <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/keys <span style="color: #D0372D;">:req-un</span> <span style="color: #909183;">[</span><span style="color: #D0372D;">::</span><span style="color: #6434A3;">aggregation.query.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">aggregation</span><span style="color: #909183;">]</span>
          <span style="color: #D0372D;">:opt-un</span> <span style="color: #909183;">[</span><span style="color: #D0372D;">::</span><span style="color: #6434A3;">aggregation.query.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">filters</span>
                   <span style="color: #D0372D;">::</span><span style="color: #6434A3;">aggregation.query.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">categoryColumn</span>
                   <span style="color: #D0372D;">::</span><span style="color: #6434A3;">aggregation.query.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">rowColumn</span>
                   <span style="color: #D0372D;">::</span><span style="color: #6434A3;">aggregation.query.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">valueColumn</span><span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::l.aggregation.pivot/query-built</span>
  <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/keys <span style="color: #D0372D;">:req-un</span> <span style="color: #909183;">[</span><span style="color: #D0372D;">::</span><span style="color: #6434A3;">l.aggregation.pivot</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">aggregation</span><span style="color: #909183;">]</span>
          <span style="color: #D0372D;">:opt-un</span> <span style="color: #909183;">[</span><span style="color: #D0372D;">::</span><span style="color: #6434A3;">l.aggregation.pivot</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">category-column</span>
                   <span style="color: #D0372D;">::</span><span style="color: #6434A3;">aggregation.query.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">filters</span>
                   <span style="color: #D0372D;">::</span><span style="color: #6434A3;">l.aggregation.pivot</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">row-column</span>
                   <span style="color: #D0372D;">::</span><span style="color: #6434A3;">l.aggregation.pivot</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">value-column</span><span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/fdef <span style="color: #6434A3;">l.aggregation.pivot</span>/build-query
  <span style="color: #D0372D;">:args</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/cat
         <span style="color: #D0372D;">:columns</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">dataset.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">columns</span>
         <span style="color: #D0372D;">:query</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">l.aggregation.pivot</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">query</span><span style="color: #7388D6;">)</span>
  <span style="color: #D0372D;">:ret</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">l.aggregation.pivot</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">query-built</span><span style="color: #707183;">)</span>


<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::l.aggregation.pivot/row</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/keys <span style="color: #D0372D;">:req-un</span> <span style="color: #909183;">[</span><span style="color: #D0372D;">::</span><span style="color: #6434A3;">a.pivot.row.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">type</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">a.pivot.row.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">title</span><span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::l.aggregation.pivot/rows</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/coll-of <span style="color: #D0372D;">::</span><span style="color: #6434A3;">l.aggregation.pivot</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">row</span> <span style="color: #D0372D;">:gen-max</span> 3<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::l.aggregation.pivot/columns</span> pos-int?<span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::l.aggregation.pivot/apply-query-ret</span>
  <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/keys <span style="color: #D0372D;">:req-un</span> <span style="color: #909183;">[</span><span style="color: #D0372D;">::</span><span style="color: #6434A3;">l.aggregation.pivot</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">rows</span>
                   <span style="color: #D0372D;">::</span><span style="color: #6434A3;">l.aggregation.pivot</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">columns</span><span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/fdef <span style="color: #6434A3;">l.aggregation.pivot</span>/apply-query
  <span style="color: #D0372D;">:args</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/cat
         <span style="color: #D0372D;">:conn</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">db.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">tenant-connection</span>
         <span style="color: #D0372D;">:dataset</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">dataset.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">dataset</span>
         <span style="color: #D0372D;">:query</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">l.aggregation.pivot</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">query-built</span>
         <span style="color: #D0372D;">:filter-str</span> string?<span style="color: #7388D6;">)</span>
  <span style="color: #D0372D;">:ret</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">l.aggregation.pivot</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">apply-query-ret</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/fdef <span style="color: #6434A3;">l.aggregation.pivot</span>/apply-pivot
  <span style="color: #D0372D;">:args</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/cat
         <span style="color: #D0372D;">:conn</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">db.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">tenant-connection</span>
         <span style="color: #D0372D;">:dataset</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">dataset.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">dataset</span>
         <span style="color: #D0372D;">:query</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">l.aggregation.pivot</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">query-built</span>
         <span style="color: #D0372D;">:filter-str</span> string?<span style="color: #7388D6;">)</span>
  <span style="color: #D0372D;">:ret</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">l.aggregation.pivot</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">apply-query-ret</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/fdef <span style="color: #6434A3;">l.aggregation.pivot</span>/apply-empty-query
  <span style="color: #D0372D;">:args</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/cat
         <span style="color: #D0372D;">:conn</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">db.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">tenant-connection</span>
         <span style="color: #D0372D;">:dataset</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">dataset.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">dataset</span>
         <span style="color: #D0372D;">:filter-str</span> string?<span style="color: #7388D6;">)</span>
  <span style="color: #D0372D;">:ret</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">l.aggregation.pivot</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">apply-query-ret</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/fdef <span style="color: #6434A3;">l.aggregation.pivot</span>/apply-empty-category-query
  <span style="color: #D0372D;">:args</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/cat
         <span style="color: #D0372D;">:conn</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">db.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">tenant-connection</span>
         <span style="color: #D0372D;">:dataset</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">dataset.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">dataset</span>
         <span style="color: #D0372D;">:query</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">l.aggregation.pivot</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">query-built</span>
         <span style="color: #D0372D;">:filter-str</span> string?<span style="color: #7388D6;">)</span>
  <span style="color: #D0372D;">:ret</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">l.aggregation.pivot</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">apply-query-ret</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/fdef <span style="color: #6434A3;">l.aggregation.pivot</span>/apply-empty-row-query
  <span style="color: #D0372D;">:args</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/cat
         <span style="color: #D0372D;">:conn</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">db.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">tenant-connection</span>
         <span style="color: #D0372D;">:dataset</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">dataset.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">dataset</span>
         <span style="color: #D0372D;">:query</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">l.aggregation.pivot</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">query-built</span>
         <span style="color: #D0372D;">:filter-str</span> string?<span style="color: #7388D6;">)</span>
  <span style="color: #D0372D;">:ret</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">l.aggregation.pivot</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">apply-query-ret</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/fdef <span style="color: #6434A3;">l.aggregation.pivot</span>/apply-empty-value-query
  <span style="color: #D0372D;">:args</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/cat
         <span style="color: #D0372D;">:conn</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">db.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">tenant-connection</span>
         <span style="color: #D0372D;">:dataset</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">dataset.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">dataset</span>
         <span style="color: #D0372D;">:query</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">l.aggregation.pivot</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">query-built</span>
         <span style="color: #D0372D;">:filter-str</span> string?<span style="color: #7388D6;">)</span>
  <span style="color: #D0372D;">:ret</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">l.aggregation.pivot</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">apply-query-ret</span><span style="color: #707183;">)</span>







</pre>
</div>
</div>
</div>

<div id="outline-container-org15f1516" class="outline-4">
<h4 id="org15f1516"><span class="section-number-4">1.2.8</span> pie</h4>
<div class="outline-text-4" id="text-1-2-8">
<p>
<a href="file:///Users/tangrammer/git/akvo/akvo-lumen/backend/test/akvo/lumen/lib/pie_test.clj#MissingReference">getting into pie using tests</a>
<a href="file:///Users/tangrammer/git/akvo/akvo-lumen/backend/test/resources/pie.csv#MissingReference">data-pie-tests</a> 
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::l.aggregation.pie/bucketColumn</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">aggregation.query.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">column</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::l.aggregation.pie/query</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/keys <span style="color: #D0372D;">:req-un</span> <span style="color: #909183;">[</span><span style="color: #D0372D;">::</span><span style="color: #6434A3;">l.aggregation.pie</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">bucketColumn</span><span style="color: #909183;">]</span>
                                       <span style="color: #D0372D;">:opt-un</span> <span style="color: #909183;">[</span><span style="color: #D0372D;">::</span><span style="color: #6434A3;">aggregation.query.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">filters</span><span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>
</div>
</div>




<div id="outline-container-org88b1037" class="outline-4">
<h4 id="org88b1037"><span class="section-number-4">1.2.9</span> endpoint</h4>
<div class="outline-text-4" id="text-1-2-9">
<p>
Once that endpoint is initialised in system/start, it receives 
</p>

<p>
<code>"/api/aggregation"</code> <code>{:keys [tenant query-params] :as request}</code>
</p>

<p>
also in the url we expect following params
</p>

<p>
<code>"/:dataset-id/:visualisation-type"</code>
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #707183;">(</span>require '<span style="color: #7388D6;">[</span>akvo.lumen.endpoint.aggregation <span style="color: #D0372D;">:as</span> e.aggregation<span style="color: #7388D6;">]</span><span style="color: #707183;">)</span>


<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/fdef <span style="color: #6434A3;">e.aggregation</span>/endpoint
    <span style="color: #D0372D;">:args</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/keys <span style="color: #D0372D;">:req-un</span> <span style="color: #909183;">[</span><span style="color: #D0372D;">::</span><span style="color: #6434A3;">tenant-manager</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">tenant-manager</span><span style="color: #909183;">]</span><span style="color: #7388D6;">)</span>
    <span style="color: #D0372D;">:ret</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">lib</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">response</span><span style="color: #707183;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgba5ff7d" class="outline-4">
<h4 id="orgba5ff7d"><span class="section-number-4">1.2.10</span> lib</h4>
<div class="outline-text-4" id="text-1-2-10">
<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::lib.aggregation/visualisation-type</span> #<span style="color: #7388D6;">{</span><span style="color: #008000;">"pivot"</span> <span style="color: #008000;">"pie"</span> <span style="color: #008000;">"donut"</span><span style="color: #7388D6;">}</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">defmulti</span> <span style="color: #006699;">query-type</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">lib.aggregation</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">visualisation-type</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">defmethod</span> <span style="color: #006699;">query-type</span> <span style="color: #008000;">"pivot"</span> <span style="color: #7388D6;">[</span>_<span style="color: #7388D6;">]</span>
  <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/keys <span style="color: #D0372D;">:req</span> <span style="color: #909183;">[</span><span style="color: #D0372D;">::</span><span style="color: #6434A3;">db.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">tenant-connection</span>
                <span style="color: #D0372D;">::</span><span style="color: #6434A3;">dataset.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">dataset</span><span style="color: #909183;">]</span>
          <span style="color: #D0372D;">:req-un</span><span style="color: #909183;">[</span><span style="color: #D0372D;">::</span><span style="color: #6434A3;">l.aggregation.pivot</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">query</span><span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">defmethod</span> <span style="color: #006699;">query-type</span> <span style="color: #008000;">"pie"</span> <span style="color: #7388D6;">[</span>_<span style="color: #7388D6;">]</span>
  <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/keys <span style="color: #D0372D;">:req</span> <span style="color: #909183;">[</span><span style="color: #D0372D;">::</span><span style="color: #6434A3;">db.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">tenant-connection</span>
                <span style="color: #D0372D;">::</span><span style="color: #6434A3;">dataset.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">dataset</span><span style="color: #909183;">]</span>
          <span style="color: #D0372D;">:req-un</span><span style="color: #909183;">[</span><span style="color: #D0372D;">::</span><span style="color: #6434A3;">l.aggregation.pie</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">query</span><span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">defmethod</span> <span style="color: #006699;">query-type</span> <span style="color: #008000;">"donut"</span> <span style="color: #7388D6;">[</span>_<span style="color: #7388D6;">]</span>
  <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/keys <span style="color: #D0372D;">:req</span> <span style="color: #909183;">[</span><span style="color: #D0372D;">::</span><span style="color: #6434A3;">db.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">tenant-connection</span>
                <span style="color: #D0372D;">::</span><span style="color: #6434A3;">dataset.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">dataset</span><span style="color: #909183;">]</span>
          <span style="color: #D0372D;">:req-un</span><span style="color: #909183;">[</span><span style="color: #D0372D;">::</span><span style="color: #6434A3;">l.aggregation.pie</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">query</span><span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/fdef <span style="color: #6434A3;">lib.aggregation</span>/query
  <span style="color: #D0372D;">:args</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/cat
         <span style="color: #D0372D;">:tenant-connection</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">db.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">tenant-connection</span>
         <span style="color: #D0372D;">:dataset-id</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">dataset.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">id</span>
         <span style="color: #D0372D;">:visualisation-type</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">lib.aggregation</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">visualisation-type</span>
         <span style="color: #D0372D;">:query</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">lumen.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">any</span><span style="color: #7388D6;">)</span>
  <span style="color: #D0372D;">:ret</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">lib</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">response</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/fdef <span style="color: #6434A3;">l.aggregation.pie</span>/query
  <span style="color: #D0372D;">:args</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/cat
         <span style="color: #D0372D;">:tenant-connection</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">db.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">tenant-connection</span>
         <span style="color: #D0372D;">:dataset</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">dataset.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">dataset</span>
         <span style="color: #D0372D;">:query</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">l.aggregation.pie</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">query</span><span style="color: #7388D6;">)</span>
  <span style="color: #D0372D;">:ret</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">lib</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">response</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/fdef <span style="color: #6434A3;">l.aggregation.pivot</span>/query
  <span style="color: #D0372D;">:args</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/cat
         <span style="color: #D0372D;">:tenant-connection</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">db.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">tenant-connection</span>
         <span style="color: #D0372D;">:dataset</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">dataset.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">dataset</span>
         <span style="color: #D0372D;">:query</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">l.aggregation.pivot</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">query</span><span style="color: #7388D6;">)</span>
  <span style="color: #D0372D;">:ret</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">lib</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">response</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/fdef <span style="color: #6434A3;">lib.aggregation</span>/query*
  <span style="color: #D0372D;">:args</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/cat <span style="color: #D0372D;">:args</span> <span style="color: #909183;">(</span><span style="color: #6434A3;">s</span>/multi-spec query-type <span style="color: #D0372D;">::</span><span style="color: #6434A3;">lib.aggregation</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">visualisation-type</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span>
  <span style="color: #D0372D;">:ret</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">lib</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">response</span><span style="color: #707183;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org668a2f8" class="outline-4">
<h4 id="org668a2f8"><span class="section-number-4">1.2.11</span> testing&#xa0;&#xa0;&#xa0;<span class="tag"><span class="tests">tests</span></span></h4>
<div class="outline-text-4" id="text-1-2-11">
</div>
<ol class="org-ol">
<li><a id="org84adc32"></a>s/multi-spec<br />
<div class="outline-text-7" id="text-1-2-11-0-0-1">
<p>
dispathing specs based in data props, in this case using <code>:visualisation-type</code>
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #707183;">[</span><span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/valid? <span style="color: #909183;">(</span><span style="color: #6434A3;">s</span>/multi-spec query-type <span style="color: #D0372D;">::</span><span style="color: #6434A3;">lib.aggregation</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">visualisation-type</span><span style="color: #909183;">)</span>
          <span style="color: #909183;">{</span><span style="color: #D0372D;">::</span><span style="color: #6434A3;">db.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">tenant-connection</span> <span style="color: #709870;">(</span><span style="color: #6434A3;">lumen.s</span>/sample <span style="color: #D0372D;">::</span><span style="color: #6434A3;">db.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">tenant-connection</span><span style="color: #709870;">)</span>
           <span style="color: #D0372D;">::</span><span style="color: #6434A3;">db.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">dataset</span> <span style="color: #709870;">(</span><span style="color: #6434A3;">lumen.s</span>/sample <span style="color: #D0372D;">::</span><span style="color: #6434A3;">db.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">dataset</span><span style="color: #709870;">)</span>
           <span style="color: #D0372D;">::</span><span style="color: #6434A3;">lib.aggregation</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">visualisation-type</span> <span style="color: #008000;">"pie"</span>
           <span style="color: #D0372D;">:query</span> <span style="color: #709870;">(</span><span style="color: #6434A3;">lumen.s</span>/sample <span style="color: #D0372D;">::</span><span style="color: #6434A3;">l.aggregation.pie</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">query</span><span style="color: #709870;">)</span><span style="color: #909183;">}</span><span style="color: #7388D6;">)</span>

<span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/valid? <span style="color: #909183;">(</span><span style="color: #6434A3;">s</span>/multi-spec query-type <span style="color: #D0372D;">::</span><span style="color: #6434A3;">lib.aggregation</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">visualisation-type</span><span style="color: #909183;">)</span>
          <span style="color: #909183;">{</span><span style="color: #D0372D;">::</span><span style="color: #6434A3;">db.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">tenant-connection</span> <span style="color: #709870;">(</span><span style="color: #6434A3;">lumen.s</span>/sample <span style="color: #D0372D;">::</span><span style="color: #6434A3;">db.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">tenant-connection</span><span style="color: #709870;">)</span>
           <span style="color: #D0372D;">::</span><span style="color: #6434A3;">db.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">dataset</span> <span style="color: #709870;">(</span><span style="color: #6434A3;">lumen.s</span>/sample <span style="color: #D0372D;">::</span><span style="color: #6434A3;">db.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">dataset</span><span style="color: #709870;">)</span>
           <span style="color: #D0372D;">::</span><span style="color: #6434A3;">lib.aggregation</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">visualisation-type</span> <span style="color: #008000;">"pivot"</span>
           <span style="color: #D0372D;">:query</span> <span style="color: #709870;">(</span><span style="color: #6434A3;">lumen.s</span>/sample <span style="color: #D0372D;">::</span><span style="color: #6434A3;">l.aggregation.pivot</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">query</span><span style="color: #709870;">)</span><span style="color: #909183;">}</span><span style="color: #7388D6;">)</span><span style="color: #707183;">]</span>


<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/explain <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/multi-spec query-type <span style="color: #D0372D;">::</span><span style="color: #6434A3;">lib.aggregation</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">visualisation-type</span><span style="color: #7388D6;">)</span>
          <span style="color: #7388D6;">{</span><span style="color: #D0372D;">:</span><span style="color: #6434A3;">akvo.lumen.specs.db</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">tenant-connection</span>
           <span style="color: #909183;">(</span><span style="color: #6434A3;">lumen.s</span>/sample <span style="color: #D0372D;">::</span><span style="color: #6434A3;">db.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">tenant-connection</span><span style="color: #909183;">)</span>,
           <span style="color: #D0372D;">:</span><span style="color: #6434A3;">akvo.lumen.specs.db</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">dataset</span>
           <span style="color: #909183;">{</span><span style="color: #D0372D;">:table-name</span> <span style="color: #008000;">"ds_b1b3d3bc_771b_4ff7_af80_dc9b6b59921f"</span>,
            <span style="color: #D0372D;">:title</span> <span style="color: #008000;">"pivot"</span>,
            <span style="color: #D0372D;">:created</span> 1528449334810,
            <span style="color: #D0372D;">:modified</span> 1528449334810,
            <span style="color: #D0372D;">:id</span> <span style="color: #008000;">"5b1a4936-7ffd-4f59-9483-f2735d39fb0e"</span>,
            <span style="color: #D0372D;">:updated</span> 1528449334825,
            <span style="color: #D0372D;">:columns</span>
            <span style="color: #709870;">(</span><span style="color: #907373;">{</span><span style="color: #008000;">"sort"</span> <span style="color: #D0372D;">nil</span>,
              <span style="color: #008000;">"type"</span> <span style="color: #008000;">"text"</span>,
              <span style="color: #008000;">"title"</span> <span style="color: #008000;">"A"</span>,
              <span style="color: #008000;">"hidden"</span> <span style="color: #D0372D;">false</span>,
              <span style="color: #008000;">"direction"</span> <span style="color: #D0372D;">nil</span>,
              <span style="color: #008000;">"columnName"</span> <span style="color: #008000;">"c1"</span><span style="color: #907373;">}</span>
             <span style="color: #907373;">{</span><span style="color: #008000;">"sort"</span> <span style="color: #D0372D;">nil</span>,
              <span style="color: #008000;">"type"</span> <span style="color: #008000;">"text"</span>,
              <span style="color: #008000;">"title"</span> <span style="color: #008000;">"B"</span>,
              <span style="color: #008000;">"hidden"</span> <span style="color: #D0372D;">false</span>,
              <span style="color: #008000;">"direction"</span> <span style="color: #D0372D;">nil</span>,
              <span style="color: #008000;">"columnName"</span> <span style="color: #008000;">"c2"</span><span style="color: #907373;">}</span>
             <span style="color: #907373;">{</span><span style="color: #008000;">"sort"</span> <span style="color: #D0372D;">nil</span>,
              <span style="color: #008000;">"type"</span> <span style="color: #008000;">"number"</span>,
              <span style="color: #008000;">"title"</span> <span style="color: #008000;">"C"</span>,
              <span style="color: #008000;">"hidden"</span> <span style="color: #D0372D;">false</span>,
              <span style="color: #008000;">"direction"</span> <span style="color: #D0372D;">nil</span>,
              <span style="color: #008000;">"columnName"</span> <span style="color: #008000;">"c3"</span><span style="color: #907373;">}</span><span style="color: #709870;">)</span>,
            <span style="color: #D0372D;">:transformations</span> <span style="color: #709870;">()</span><span style="color: #909183;">}</span>,
           <span style="color: #D0372D;">:</span><span style="color: #6434A3;">akvo.lumen.lib.aggregation</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">visualisation-type</span> <span style="color: #008000;">"pivot"</span>,
           <span style="color: #D0372D;">:query</span> <span style="color: #909183;">{</span><span style="color: #D0372D;">:aggregation</span> <span style="color: #008000;">"count"</span><span style="color: #909183;">}</span><span style="color: #7388D6;">}</span>
          <span style="color: #707183;">)</span>
</pre>
</div>
</div>
</li>
</ol>


<li><a id="org5a8d672"></a>dataset&#xa0;&#xa0;&#xa0;<span class="tag"><span class="sample">sample</span></span><br />
<div class="outline-text-5" id="text-1-2-11-1">
<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #707183;">{</span><span style="color: #D0372D;">:table-name</span> <span style="color: #008000;">"ds_c5e5dc80_151e_48ff_a4ca_05bb8d74aa7d"</span>,
 <span style="color: #D0372D;">:title</span> <span style="color: #008000;">"pivot"</span>,
 <span style="color: #D0372D;">:created</span> 1528454476862,
 <span style="color: #D0372D;">:modified</span> 1528454476862,
 <span style="color: #D0372D;">:id</span> <span style="color: #008000;">"5b1a5d4c-5c16-495a-a962-062a2df977fd"</span>,
 <span style="color: #D0372D;">:updated</span> 1528454476876,
 <span style="color: #D0372D;">:columns</span>
 <span style="color: #7388D6;">(</span><span style="color: #909183;">{</span><span style="color: #008000;">"sort"</span> <span style="color: #D0372D;">nil</span>,
   <span style="color: #008000;">"type"</span> <span style="color: #008000;">"text"</span>,
   <span style="color: #008000;">"title"</span> <span style="color: #008000;">"A"</span>,
   <span style="color: #008000;">"hidden"</span> <span style="color: #D0372D;">false</span>,
   <span style="color: #008000;">"direction"</span> <span style="color: #D0372D;">nil</span>,
   <span style="color: #008000;">"columnName"</span> <span style="color: #008000;">"c1"</span><span style="color: #909183;">}</span>
  <span style="color: #909183;">{</span><span style="color: #008000;">"sort"</span> <span style="color: #D0372D;">nil</span>,
   <span style="color: #008000;">"type"</span> <span style="color: #008000;">"text"</span>,
   <span style="color: #008000;">"title"</span> <span style="color: #008000;">"B"</span>,
   <span style="color: #008000;">"hidden"</span> <span style="color: #D0372D;">false</span>,
   <span style="color: #008000;">"direction"</span> <span style="color: #D0372D;">nil</span>,
   <span style="color: #008000;">"columnName"</span> <span style="color: #008000;">"c2"</span><span style="color: #909183;">}</span>
  <span style="color: #909183;">{</span><span style="color: #008000;">"sort"</span> <span style="color: #D0372D;">nil</span>,
   <span style="color: #008000;">"type"</span> <span style="color: #008000;">"number"</span>,
   <span style="color: #008000;">"title"</span> <span style="color: #008000;">"C"</span>,
   <span style="color: #008000;">"hidden"</span> <span style="color: #D0372D;">false</span>,
   <span style="color: #008000;">"direction"</span> <span style="color: #D0372D;">nil</span>,
   <span style="color: #008000;">"columnName"</span> <span style="color: #008000;">"c3"</span><span style="color: #909183;">}</span><span style="color: #7388D6;">)</span>,
 <span style="color: #D0372D;">:transformations</span> <span style="color: #7388D6;">()</span><span style="color: #707183;">}</span>


</pre>
</div>
</div>
</li>
</ol>
</div>


<div id="outline-container-org17e0885" class="outline-4">
<h4 id="org17e0885"><span class="section-number-4">1.2.12</span> <span class="todo TODO">TODO</span> RENAME type to column-type and columnName to column-name</h4>
<div class="outline-text-4" id="text-1-2-12">
<p>
<a href="file:///Users/tangrammer/git/akvo/akvo-lumen/backend/src/akvo/lumen/lib/aggregation/filter.clj">aggregation/filter.clj</a>
</p>
</div>
</div>


<div id="outline-container-org26156d6" class="outline-4">
<h4 id="org26156d6"><span class="section-number-4">1.2.13</span> database &#x2026; tenant aggregation tables&#xa0;&#xa0;&#xa0;<span class="tag"><span class="sql">sql</span></span></h4>
<div class="outline-text-4" id="text-1-2-13">
<div class="org-src-container">
<pre class="src src-sql">\d  dataset_version
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Table "public.dataset<sub>version</sub>"</th>
<th scope="col" class="org-left">&#xa0;</th>
<th scope="col" class="org-left">&#xa0;</th>
<th scope="col" class="org-left">&#xa0;</th>
<th scope="col" class="org-left">&#xa0;</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Column</td>
<td class="org-left">Type</td>
<td class="org-left">Collation</td>
<td class="org-left">Nullable</td>
<td class="org-left">Default</td>
</tr>

<tr>
<td class="org-left">id</td>
<td class="org-left">text</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">not null</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">dataset<sub>id</sub></td>
<td class="org-left">text</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">not null</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">job<sub>execution</sub><sub>id</sub></td>
<td class="org-left">text</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">not null</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">transformations</td>
<td class="org-left">jsonb</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">not null</td>
<td class="org-left">'[]'::jsonb</td>
</tr>

<tr>
<td class="org-left">version</td>
<td class="org-left">smallint</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">not null</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">table<sub>name</sub></td>
<td class="org-left">text</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">imported<sub>table</sub><sub>name</sub></td>
<td class="org-left">text</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">not null</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">columns</td>
<td class="org-left">jsonb</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">not null</td>
<td class="org-left">'[]'::jsonb</td>
</tr>

<tr>
<td class="org-left">created</td>
<td class="org-left">timestamp with time zone</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">not null</td>
<td class="org-left">now()</td>
</tr>

<tr>
<td class="org-left">modified</td>
<td class="org-left">timestamp with time zone</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">not null</td>
<td class="org-left">now()</td>
</tr>

<tr>
<td class="org-left">Indexes:</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">"dataset<sub>version</sub><sub>pkey</sub>" PRIMARY KEY, btree (id)</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">"dataset<sub>version</sub><sub>dataset</sub><sub>id</sub><sub>version</sub><sub>key</sub>" UNIQUE CONSTRAINT, btree (dataset<sub>id</sub>, version)</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">"dataset<sub>version</sub><sub>table</sub><sub>name</sub><sub>key</sub>" UNIQUE CONSTRAINT, btree (table<sub>name</sub>)</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Foreign-key constraints:</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">"dataset<sub>version</sub><sub>dataset</sub><sub>id</sub><sub>fkey</sub>" FOREIGN KEY (dataset<sub>id</sub>) REFERENCES dataset(id) ON DELETE CASCADE</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">"dataset<sub>version</sub><sub>job</sub><sub>execution</sub><sub>id</sub><sub>fkey</sub>" FOREIGN KEY (job<sub>execution</sub><sub>id</sub>) REFERENCES job<sub>execution</sub>(id) ON DELETE CASCADE</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Triggers:</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">dataset<sub>version</sub><sub>history</sub> AFTER INSERT OR DELETE OR UPDATE ON dataset<sub>version</sub> FOR EACH ROW EXECUTE PROCEDURE history.log<sub>change</sub>()</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">dataset<sub>version</sub><sub>modified</sub> BEFORE UPDATE ON dataset<sub>version</sub> FOR EACH ROW EXECUTE PROCEDURE update<sub>modified</sub>()</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>


<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Table "public.dataset<sub>version</sub>"</th>
<th scope="col" class="org-left">&#xa0;</th>
<th scope="col" class="org-left">&#xa0;</th>
<th scope="col" class="org-left">&#xa0;</th>
<th scope="col" class="org-left">&#xa0;</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Column</td>
<td class="org-left">Type</td>
<td class="org-left">Collation</td>
<td class="org-left">Nullable</td>
<td class="org-left">Default</td>
</tr>

<tr>
<td class="org-left">id</td>
<td class="org-left">text</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">not null</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">dataset<sub>id</sub></td>
<td class="org-left">text</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">not null</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">job<sub>execution</sub><sub>id</sub></td>
<td class="org-left">text</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">not null</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">transformations</td>
<td class="org-left">jsonb</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">not null</td>
<td class="org-left">'[]'::jsonb</td>
</tr>

<tr>
<td class="org-left">version</td>
<td class="org-left">smallint</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">not null</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">table<sub>name</sub></td>
<td class="org-left">text</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">imported<sub>table</sub><sub>name</sub></td>
<td class="org-left">text</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">not null</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">columns</td>
<td class="org-left">jsonb</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">not null</td>
<td class="org-left">'[]'::jsonb</td>
</tr>

<tr>
<td class="org-left">created</td>
<td class="org-left">timestamp with time zone</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">not null</td>
<td class="org-left">now()</td>
</tr>

<tr>
<td class="org-left">modified</td>
<td class="org-left">timestamp with time zone</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">not null</td>
<td class="org-left">now()</td>
</tr>
</tbody>
</table>


<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Table "public.dataset"</th>
<th scope="col" class="org-left">&#xa0;</th>
<th scope="col" class="org-left">&#xa0;</th>
<th scope="col" class="org-left">&#xa0;</th>
<th scope="col" class="org-left">&#xa0;</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Column</td>
<td class="org-left">Type</td>
<td class="org-left">Collation</td>
<td class="org-left">Nullable</td>
<td class="org-left">Default</td>
</tr>

<tr>
<td class="org-left">id</td>
<td class="org-left">text</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">not null</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">title</td>
<td class="org-left">text</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">not null</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">description</td>
<td class="org-left">text</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">not null</td>
<td class="org-left">''::text</td>
</tr>

<tr>
<td class="org-left">created</td>
<td class="org-left">timestamp with time zone</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">not null</td>
<td class="org-left">now()</td>
</tr>

<tr>
<td class="org-left">modified</td>
<td class="org-left">timestamp with time zone</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">not null</td>
<td class="org-left">now()</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div id="outline-container-orge0b8e79" class="outline-3">
<h3 id="orge0b8e79"><span class="section-number-3">1.3</span> visualisation&#xa0;&#xa0;&#xa0;<span class="tag"><span class="visualisation">visualisation</span></span></h3>
<div class="outline-text-3" id="text-1-3">
</div>

<div id="outline-container-org48877b7" class="outline-4">
<h4 id="org48877b7"><span class="section-number-4">1.3.1</span> glossary</h4>
<div class="outline-text-4" id="text-1-3-1">
<p>
raster graphics <a href="https://en.wikipedia.org/wiki/Raster_graphics#Etymology">https://en.wikipedia.org/wiki/Raster_graphics#Etymology</a>
</p>
</div>
</div>

<div id="outline-container-orgd968aef" class="outline-4">
<h4 id="orgd968aef"><span class="section-number-4">1.3.2</span> visualisation maps domain&#xa0;&#xa0;&#xa0;<span class="tag"><span class="visualisation">visualisation</span></span></h4>
<div class="outline-text-4" id="text-1-3-2">
<p>
So what do we currently have in aggregation functionality &#x2026;
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-right">373</td>
<td class="org-left">../src/akvo/lumen/lib/visualisation/map<sub>config.clj</sub></td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-right">178</td>
<td class="org-left">../src/akvo/lumen/lib/visualisation/map<sub>metadata.clj</sub></td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-right">121</td>
<td class="org-left">../src/akvo/lumen/lib/visualisation/maps.clj</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-right">672</td>
<td class="org-left">total</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-right">&#x2026;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#x2026;</td>
</tr>

<tr>
<td class="org-right">51</td>
<td class="org-left">../src/akvo/lumen/lib/visualisation.clj</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>

<p>
<b>=&gt; filter , pie, pivot, utils</b>
</p>

<p>
besides that we have a main ns <code>lib.visualisation</code> that just dispatch to maps (with config &amp;&amp; metadata in mind)
</p>
</div>
</div>


<div id="outline-container-orgab7f68b" class="outline-4">
<h4 id="orgab7f68b"><span class="section-number-4">1.3.3</span> visualisation layer legend</h4>
<div class="outline-text-4" id="text-1-3-3">
<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #707183;">(</span><span style="color: #0000FF;">ns</span> <span style="color: #6434A3;">akvo.lumen.specs.visualisation.layer.legend</span>
  <span style="color: #7388D6;">(</span><span style="color: #D0372D;">:require</span>
            <span style="color: #909183;">[</span>akvo.lumen.specs.core <span style="color: #D0372D;">:as</span> lumen.s<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>akvo.lumen.specs.libs<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>clojure.spec.alpha <span style="color: #D0372D;">:as</span> s<span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::title</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/or <span style="color: #D0372D;">:v</span> string? <span style="color: #D0372D;">:n</span> nil?<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::visible</span> boolean?<span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::legend</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/keys <span style="color: #D0372D;">:req-un</span> <span style="color: #909183;">[</span><span style="color: #D0372D;">::title</span> <span style="color: #D0372D;">::visible</span><span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

</pre>
</div>

<pre class="example">
nil:akvo.lumen.specs.visualisation.layer.legend/title:akvo.lumen.specs.visualisation.layer.legend/visible:akvo.lumen.specs.visualisation.layer.legend/legend

</pre>
</div>
</div>

<div id="outline-container-orgacdeb3b" class="outline-4">
<h4 id="orgacdeb3b"><span class="section-number-4">1.3.4</span> visualisation layer spec</h4>
<div class="outline-text-4" id="text-1-3-4">
<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #707183;">(</span><span style="color: #0000FF;">ns</span> <span style="color: #6434A3;">akvo.lumen.specs.visualisation.layer.spec</span>
  <span style="color: #7388D6;">(</span><span style="color: #D0372D;">:require</span>
   <span style="color: #909183;">[</span>akvo.lumen.specs.core <span style="color: #D0372D;">:as</span> lumen.s<span style="color: #909183;">]</span>
   <span style="color: #909183;">[</span>akvo.lumen.specs.visualisation.layer <span style="color: #D0372D;">:as</span> visualisation.layer.s<span style="color: #909183;">]</span>
   <span style="color: #909183;">[</span>akvo.lumen.specs.libs<span style="color: #909183;">]</span>
   <span style="color: #909183;">[</span>clojure.spec.alpha <span style="color: #D0372D;">:as</span> s<span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::version</span> int?<span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::baseLayer</span> #<span style="color: #7388D6;">{</span><span style="color: #008000;">"terrain"</span> <span style="color: #008000;">"satellite"</span> <span style="color: #008000;">"street"</span><span style="color: #7388D6;">}</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::layers</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/coll-of <span style="color: #D0372D;">::</span><span style="color: #6434A3;">visualisation.layer.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">layer</span> <span style="color: #D0372D;">:gen-max</span> 3<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::spec</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/keys <span style="color: #D0372D;">:req-un</span> <span style="color: #909183;">[</span><span style="color: #D0372D;">::layers</span>
                               <span style="color: #D0372D;">::version</span>
                               <span style="color: #D0372D;">::baseLayer</span><span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>


</pre>
</div>

<pre class="example">
nil:akvo.lumen.specs.visualisation.layer.spec/version:akvo.lumen.specs.visualisation.layer.spec/baseLayer:akvo.lumen.specs.visualisation.layer.spec/layers:akvo.lumen.specs.visualisation.layer.spec/spec

</pre>
</div>
</div>

<div id="outline-container-org4474496" class="outline-4">
<h4 id="org4474496"><span class="section-number-4">1.3.5</span> visualisation layer</h4>
<div class="outline-text-4" id="text-1-3-5">
<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #707183;">(</span><span style="color: #0000FF;">ns</span> <span style="color: #6434A3;">akvo.lumen.specs.visualisation.layer</span>
  <span style="color: #7388D6;">(</span><span style="color: #D0372D;">:require</span> <span style="color: #909183;">[</span>akvo.lumen.component.tenant-manager <span style="color: #D0372D;">:as</span> tenant-manager<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>akvo.lumen.lib <span style="color: #D0372D;">:as</span> lib<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>akvo.lumen.lib.visualisation <span style="color: #D0372D;">:as</span> lib.visualisation<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>akvo.lumen.lib.visualisation.map-config <span style="color: #D0372D;">:as</span> l.visualisation.map-config<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>akvo.lumen.lib.visualisation.map-metadata <span style="color: #D0372D;">:as</span> l.visualisation.map-metadata<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>akvo.lumen.specs.core <span style="color: #D0372D;">:as</span> lumen.s<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>akvo.lumen.specs.dataset <span style="color: #D0372D;">:as</span> dataset.s<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>akvo.lumen.specs.dataset.column <span style="color: #D0372D;">:as</span> dataset.column.s<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>akvo.lumen.specs.visualisation.layer.legend <span style="color: #D0372D;">:as</span> layer.legend.s<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>akvo.lumen.specs.db <span style="color: #D0372D;">:as</span> db.s<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>akvo.lumen.specs.libs<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>clojure.spec.alpha <span style="color: #D0372D;">:as</span> s<span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::aggregationMethod</span> #<span style="color: #7388D6;">{</span><span style="color: #008000;">"avg"</span><span style="color: #7388D6;">}</span> <span style="color: #707183;">)</span> <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">TODO: check with /Users/tangrammer/git/akvo/akvo-lumen/backend/src/akvo/lumen/specs/aggregation/query.clj::21</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::popup</span>  coll?<span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">def</span> <span style="color: #BA36A5;">example-filter</span> <span style="color: #7388D6;">{</span><span style="color: #D0372D;">:column</span> <span style="color: #008000;">"c2"</span>,
                     <span style="color: #D0372D;">:columnType</span> <span style="color: #008000;">"number"</span>,
                     <span style="color: #D0372D;">:operation</span> <span style="color: #008000;">"keep"</span>,
                     <span style="color: #D0372D;">:origin</span> <span style="color: #008000;">"filterMenu"</span>,
                     <span style="color: #D0372D;">:strategy</span> <span style="color: #008000;">"isLower"</span>,
                     <span style="color: #D0372D;">:value</span> <span style="color: #008000;">"100000"</span><span style="color: #7388D6;">}</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::filters</span> coll?<span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::layerType</span> #<span style="color: #7388D6;">{</span><span style="color: #008000;">"geo-location"</span> <span style="color: #008000;">"geo-shape"</span> <span style="color: #008000;">"raster"</span><span style="color: #7388D6;">}</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::legend</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/keys <span style="color: #D0372D;">:req-un</span> <span style="color: #909183;">[</span><span style="color: #D0372D;">::</span><span style="color: #6434A3;">layer.legend.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">title</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">layer.legend.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">visible</span><span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span> 

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::rasterId</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/or <span style="color: #D0372D;">:v</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">lumen.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">str-uuid</span>
                        <span style="color: #D0372D;">:n</span> nil?<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::pointSize</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/or <span style="color: #D0372D;">:s</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">lumen.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">str-int</span>
                         <span style="color: #D0372D;">:i</span> int?<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::pointColorMapping</span> coll?<span style="color: #707183;">)</span> 
<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::longitude</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/or <span style="color: #D0372D;">:v</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">lumen.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">any</span> <span style="color: #D0372D;">:n</span> nil?<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::latitude</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/or <span style="color: #D0372D;">:v</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">lumen.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">any</span> <span style="color: #D0372D;">:n</span> nil?<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::datasetId</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/or <span style="color: #D0372D;">:v</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">lumen.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">str-uuid</span> <span style="color: #D0372D;">:n</span> nil?<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::title</span> string?<span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::geom</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/or <span style="color: #D0372D;">:v</span> string? <span style="color: #D0372D;">:n</span> nil?<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::pointColorColumn</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/or <span style="color: #D0372D;">:v</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">lumen.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">any</span> <span style="color: #D0372D;">:n</span> nil?<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::visible</span> boolean?<span style="color: #707183;">)</span>




<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::layer</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/keys <span style="color: #D0372D;">:req-un</span> <span style="color: #909183;">[</span><span style="color: #D0372D;">::aggregationMethod</span> 
                                <span style="color: #D0372D;">::popup</span> 
                                <span style="color: #D0372D;">::filters</span> 
                                <span style="color: #D0372D;">::layerType</span> 
                                <span style="color: #D0372D;">::legend</span> 
                                <span style="color: #D0372D;">::pointSize</span> 
                                <span style="color: #D0372D;">::pointColorMapping</span> 
                                <span style="color: #D0372D;">::longitude</span> 
                                <span style="color: #D0372D;">::datasetId</span> 
                                <span style="color: #D0372D;">::title</span> 
                                <span style="color: #D0372D;">::geom</span> 
                                <span style="color: #D0372D;">::pointColorColumn</span> 
                                <span style="color: #D0372D;">::latitude</span> 
                                <span style="color: #D0372D;">::visible</span><span style="color: #909183;">]</span>
                       <span style="color: #D0372D;">:opt-un</span> <span style="color: #909183;">[</span><span style="color: #D0372D;">::rasterId</span><span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>

<pre class="example">
nil#'akvo.lumen.specs.visualisation.layer/data-example:akvo.lumen.specs.visualisation.layer/aggregationMethod:akvo.lumen.specs.visualisation.layer/popup:akvo.lumen.specs.visualisation.layer/filters:akvo.lumen.specs.visualisation.layer/layerType:akvo.lumen.specs.visualisation.layer/legend:akvo.lumen.specs.visualisation.layer/rasterId:akvo.lumen.specs.visualisation.layer/pointSize:akvo.lumen.specs.visualisation.layer/pointColorMapping:akvo.lumen.specs.visualisation.layer/longitude:akvo.lumen.specs.visualisation.layer/latitude:akvo.lumen.specs.visualisation.layer/datasetId:akvo.lumen.specs.visualisation.layer/title:akvo.lumen.specs.visualisation.layer/geom:akvo.lumen.specs.visualisation.layer/pointColorColumn:akvo.lumen.specs.visualisation.layer/visible:akvo.lumen.specs.visualisation.layer/layer

</pre>
</div>
</div>

<div id="outline-container-org66621ca" class="outline-4">
<h4 id="org66621ca"><span class="section-number-4">1.3.6</span> visualisation ns&#xa0;&#xa0;&#xa0;<span class="tag"><span class="ns">ns</span></span></h4>
<div class="outline-text-4" id="text-1-3-6">
<p>
this <a href="file:///Users/tangrammer/git/akvo/akvo-lumen/backend/src/akvo/lumen/lib/visualisation.clj#MissingReference">namespace</a> only communicates with hugsql, so intended functionality doesn't return any kind of vis but storing into db some kind of vis data
</p>
</div>



<ol class="org-ol">
<li><a id="org931e293"></a>spec<br />
<div class="outline-text-5" id="text-1-3-6-1">
<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #707183;">(</span><span style="color: #0000FF;">ns</span> <span style="color: #6434A3;">akvo.lumen.specs.visualisation</span>
  <span style="color: #7388D6;">(</span><span style="color: #D0372D;">:require</span> <span style="color: #909183;">[</span>akvo.lumen.lib.visualisation <span style="color: #D0372D;">:as</span> lib.visualisation<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>akvo.lumen.lib.visualisation.map-config <span style="color: #D0372D;">:as</span> l.visualisation.map-config<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>akvo.lumen.lib.visualisation.map-metadata <span style="color: #D0372D;">:as</span> l.visualisation.map-metadata<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>akvo.lumen.specs.core <span style="color: #D0372D;">:as</span> lumen.s<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>akvo.lumen.specs.dataset <span style="color: #D0372D;">:as</span> dataset.s<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>akvo.lumen.specs.visualisation.layer <span style="color: #D0372D;">:as</span> visualisation.layer.s<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>akvo.lumen.specs.visualisation.layer.legend <span style="color: #D0372D;">:as</span> layer.legend.s<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>akvo.lumen.specs.visualisation.layer.spec <span style="color: #D0372D;">:as</span> layer.spec.s<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>akvo.lumen.specs.db <span style="color: #D0372D;">:as</span> db.s<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>clojure.spec.alpha <span style="color: #D0372D;">:as</span> s<span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::lib.visualisation/type</span> string?<span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::lib.visualisation/name</span> string?<span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::lib.visualisation/visualisationType</span>
  #<span style="color: #7388D6;">{</span><span style="color: #008000;">"map"</span> <span style="color: #008000;">"pivot table"</span> <span style="color: #008000;">"bar"</span> <span style="color: #008000;">"line"</span> <span style="color: #008000;">"area"</span> <span style="color: #008000;">"pie"</span> <span style="color: #008000;">"donut"</span> <span style="color: #008000;">"scatter"</span><span style="color: #7388D6;">}</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::lib.visualisation/datasetId</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">dataset.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">id</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::lib.visualisation/created</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">lumen.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">date-int</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::lib.visualisation/modified</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">lumen.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">date-int</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::lib.visualisation/status</span> #<span style="color: #7388D6;">{</span><span style="color: #008000;">"OK"</span><span style="color: #7388D6;">}</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::lib.visualisation/id</span> string?<span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::lib.visualisation/body</span>
  <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/keys <span style="color: #D0372D;">:req-un</span> <span style="color: #909183;">[</span><span style="color: #D0372D;">::</span><span style="color: #6434A3;">lib.visualisation</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">datasetId</span>
                   <span style="color: #D0372D;">::</span><span style="color: #6434A3;">lib.visualisation</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">name</span>
                   <span style="color: #D0372D;">::</span><span style="color: #6434A3;">lib.visualisation</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">spec</span>
                   <span style="color: #D0372D;">::</span><span style="color: #6434A3;">lib.visualisation</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">type</span>
                   <span style="color: #D0372D;">::</span><span style="color: #6434A3;">lib.visualisation</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">visualisationType</span><span style="color: #909183;">]</span>

          <span style="color: #D0372D;">:opt-un</span> <span style="color: #909183;">[</span><span style="color: #D0372D;">::</span><span style="color: #6434A3;">lib.visualisation</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">created</span>
                   <span style="color: #D0372D;">::</span><span style="color: #6434A3;">lib.visualisation</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">modified</span>
                   <span style="color: #D0372D;">::</span><span style="color: #6434A3;">layer.spec.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">spec</span>
                   <span style="color: #D0372D;">::</span><span style="color: #6434A3;">lib.visualisation</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">status</span>
                   <span style="color: #D0372D;">::</span><span style="color: #6434A3;">lib.visualisation</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">id</span><span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/fdef <span style="color: #6434A3;">lib.visualisation</span>/all
  <span style="color: #D0372D;">:args</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/cat
         <span style="color: #D0372D;">:tenant-conn</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">db.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">tenant-connection</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/fdef <span style="color: #6434A3;">lib.visualisation</span>/create
  <span style="color: #D0372D;">:args</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/cat
         <span style="color: #D0372D;">:tenant-conn</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">db.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">tenant-connection</span>
         <span style="color: #D0372D;">:body</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">lib.visualisation</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">body</span>
         <span style="color: #D0372D;">:jwt-claims</span> map?<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/fdef <span style="color: #6434A3;">lib.visualisation</span>/upsert
  <span style="color: #D0372D;">:args</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/cat
         <span style="color: #D0372D;">:tenant-conn</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">db.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">tenant-connection</span>
         <span style="color: #D0372D;">:body</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">lib.visualisation</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">body</span>
         <span style="color: #D0372D;">:jwt-claims</span> map?<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/fdef <span style="color: #6434A3;">lib.visualisation</span>/fetch
  <span style="color: #D0372D;">:args</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/cat
         <span style="color: #D0372D;">:tenant-conn</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">db.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">tenant-connection</span>
         <span style="color: #D0372D;">:id</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">lib.visualisation</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">id</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/fdef <span style="color: #6434A3;">lib.visualisation</span>/delete
  <span style="color: #D0372D;">:args</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/cat
         <span style="color: #D0372D;">:tenant-conn</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">db.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">tenant-connection</span>
         <span style="color: #D0372D;">:id</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">lib.visualisation</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">id</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>





</pre>
</div>

<pre class="example">
nil:akvo.lumen.lib.visualisation/name:akvo.lumen.lib.visualisation/visualisationType:akvo.lumen.lib.visualisation/type:akvo.lumen.lib.visualisation/datasetId:akvo.lumen.lib.visualisation/created:akvo.lumen.lib.visualisation/modified:akvo.lumen.lib.visualisation/status:akvo.lumen.lib.visualisation/id:akvo.lumen.lib.visualisation/layers:akvo.lumen.lib.visualisation/bodyakvo.lumen.lib.visualisation/allakvo.lumen.lib.visualisation/createakvo.lumen.lib.visualisation/upsertakvo.lumen.lib.visualisation/fetchakvo.lumen.lib.visualisation/delete

</pre>
</div>
</li>

<li><a id="org4092a23"></a>sample data<br />
<div class="outline-text-5" id="text-1-3-6-2">
<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #707183;">(</span><span style="color: #0000FF;">in-ns</span> 'akvo.lumen.specs.visualisation<span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">def</span> <span style="color: #BA36A5;">data</span> <span style="color: #7388D6;">{</span><span style="color: #D0372D;">:name</span> <span style="color: #008000;">"Untitled visualisation"</span>,
           <span style="color: #D0372D;">:visualisationType</span> <span style="color: #008000;">"map"</span>,
           <span style="color: #D0372D;">:type</span> <span style="color: #008000;">"visualisation"</span>,
           <span style="color: #D0372D;">:created</span> 1528892610519,
           <span style="color: #D0372D;">:modified</span> 1528892610519,
           <span style="color: #D0372D;">:datasetId</span> <span style="color: #D0372D;">nil</span>,
           <span style="color: #D0372D;">:spec</span>
           <span style="color: #909183;">{</span><span style="color: #D0372D;">:version</span> 1,
            <span style="color: #D0372D;">:baseLayer</span> <span style="color: #008000;">"street"</span>,
            <span style="color: #D0372D;">:layers</span>
            <span style="color: #709870;">[</span><span style="color: #907373;">{</span><span style="color: #D0372D;">:aggregationMethod</span> <span style="color: #008000;">"avg"</span>,
              <span style="color: #D0372D;">:popup</span> <span style="color: #6276BA;">[]</span>,
              <span style="color: #D0372D;">:filters</span> <span style="color: #6276BA;">[]</span>,
              <span style="color: #D0372D;">:layerType</span> <span style="color: #008000;">"geo-location"</span>,
              <span style="color: #D0372D;">:legend</span> <span style="color: #6276BA;">{</span><span style="color: #D0372D;">:title</span> <span style="color: #D0372D;">nil</span>, <span style="color: #D0372D;">:visible</span> <span style="color: #D0372D;">true</span><span style="color: #6276BA;">}</span>,
              <span style="color: #D0372D;">:rasterId</span> <span style="color: #D0372D;">nil</span>,
              <span style="color: #D0372D;">:pointSize</span> 3,
              <span style="color: #D0372D;">:pointColorMapping</span> <span style="color: #6276BA;">[]</span>,
              <span style="color: #D0372D;">:longitude</span> <span style="color: #D0372D;">nil</span>,
              <span style="color: #D0372D;">:datasetId</span> <span style="color: #008000;">"5b210c21-fa20-4f93-a9ba-6ec75c9ce5ae"</span>,
              <span style="color: #D0372D;">:title</span> <span style="color: #008000;">"jor"</span>,
              <span style="color: #D0372D;">:geom</span> <span style="color: #008000;">"d1"</span>,
              <span style="color: #D0372D;">:pointColorColumn</span> <span style="color: #D0372D;">nil</span>,
              <span style="color: #D0372D;">:latitude</span> <span style="color: #D0372D;">nil</span>,
              <span style="color: #D0372D;">:visible</span> <span style="color: #D0372D;">true</span><span style="color: #907373;">}</span><span style="color: #709870;">]</span><span style="color: #909183;">}</span>,
           <span style="color: #D0372D;">:status</span> <span style="color: #008000;">"OK"</span>,
           <span style="color: #D0372D;">:id</span> <span style="color: #008000;">"5b210cc2-6430-4b81-b68a-d89b9d045048"</span><span style="color: #7388D6;">}</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span>assert <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/valid? <span style="color: #D0372D;">::</span><span style="color: #6434A3;">lib.visualisation</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">body</span> data<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>



<div class="org-src-container">
<pre class="src src-clojure">


</pre>
</div>

<pre class="example">
{:spec
 {:layer
  {:aggregationMethod "avg",
   :popup
   [:*S4uv-XE.?-FUJ.d!svfJ6+?Z!4w?QT5_OW*M_?df3_F4c.Dzs-?TS*yh7?cF8f+.DzKM4-TSwV+G_C*u-y_._!9L8A-J1U9l?+.++!.E/?2+-70?*?_17??zc14dqy3b-3k_
    -29/27
    :-e5Io!*tp*D:Qw:E_27N25F*TlX4*FJI9-*5!:e0*?XI8F_1*VIZ?0+Ord1_9bT:-T5_?+lE_Lp:3H!8_?lA!HL*yJa-FX1_?y5Vg_vZw:QHKX_9+c_X4Qi**e+KU!Q-+?d+3-_:98uX_F2ju7?A7i1oby!522ZJ11?*!:91Mt0fb!2md-Fd8_h-0**q!K:s+-2z6h792?x8:v4!dpM7__p2sc9a_Z*U7+8+d*2c5:pI!J7oo*M6q*!:4bRh2U-nb__3u_0!-!jc5:_2him5bacrw9_YiH*:4!k*w9*_5x!K-!PPNZ*3w+6*:o6qYm-S19-k?YG?*_2Mz60*dNyT+H3:!f-0_W*xX?I1:6*1g:*4*8?E2G_*Y7y7*7!odB*7Qg9H:!761TeY:rXc**e+R?-71?587??3m43dyf4??hfP:_W+yH_h:YxInr19V?74gr3x9*92!h9M*vt??7?:8*3?w63KiY-h-c+Tc5L_r42_cz:0C?MH-!?-B_!*9WQLh:J_AR_0_!_P??zX9?W!6563D!*958-uj:X_iH686ppq8D!SP-HsU3Yu34-RWdpr+:g_6?w:-5a5_81
    :s-Y-rK_-VL?!_CNb76M8F-0_41!P?5:!+H:zRSVi+x0*j9E?EZlU1CH95+x1*W!-6D:rr8T35tzW+1b*+EM+_?:v+7-a!xi1t4f!!7D-Z5e5?Z-W0+2C:+X*EGP1?s4uBFzY+_!+_9:!-7b1jo_?GSLes9TW!Hl19D!v+Rb?+*:3-!+4:d+Ug6brb!-Fq*mn53ce_w5mri7x+:eJjZE--T6sn!-XA9_++:aQZF*k*3Of*m*jACkR40-_v:+74vl!pEXL_kUL_:bd-4EQ*:*?X_2-C4?*_7+Z++5G:z4L41:m2*a9d-*mv?C**9g8_M4d:Hp0*B5uO!*Bq5T?6c?3Y65B*-1:+S7__hu?6fO08AB4lWDiq:D22y1*0+*dZ5+NaxO120a!k!Y0oS_?+:5i6Ikp?-NDox:wx6*lVs*Jt!V4s+x*:YCs-7w4+r4bk0*QhSsReaG3*f_-b:SD-kTZ9a8-!q:9:*Sm4G7aO16ILh0?C8cJ:_s__z:2:G+!4_*Q:+Vr1?*!+*8z+x!O4vB1_:cg9w?6_Zi4k?5-p4-
    #uuid "08d63881-786a-4011-9b40-681310498e09"],
   :filters
   (\D
    #uuid "8ec3d450-aaab-4d30-a751-60e19b7fa7c3"
    9/8
    true
    20/7
    O0RvC35
    false
    oe.X_1H?5--542J6Bg0G4.D!2_Mo!YpC?!K8x-TN55*9.W3rO35Q!!Do*w?_+8-_!.D6m+_-7P.Wtb8*J6q-N_g*ln!K!*20.f+5*__5+__7B.Q7/*07n.
    -32.0
    *rZ7T?U0u9-.Jt718*+ycN+26oe_-1Xp.I7CE!!cc?n-gg80*.!!?U.vzL1_h*E++Ir!.p620-9_rDsj!!RpV.+-aICSDJ-W-+-ABAqHklh!a8f!.iRo_q??5K67?Bw9*7jSQh_k?k-bSdx6.yJqJrzMuae9v!!+S7g2!W1.CNbu*WkM8!YOT4M_HOJ154go.y--!sXD97m02k6.jS!X50rvp*h+q!okwl.M!+2g!_pTsh39-*6!4yUf.q*-a5Fv*JRg++?z+1B6/*5?p
    4
    -0.9995212554931641
    -3.6495819091796875
    -8
    0.007313174690352753
    "1\")q&lt;3${o|E~O"
    true
    6213369),
   :layerType "geo-location",
   :legend {:title "GPrAxMHK0ozE4RlO4S2J84", :visible true},
   :rasterId #uuid "a3e3b73d-bfc4-4756-a00e-90aede93a515",
   :pointSize 0,
   :pointColorMapping
   [#uuid "8911f740-aacb-4c88-8dff-8991f7dbb20f"
    #uuid "c91746fc-2d96-4585-9949-0d26e608a54b"
    9/29
    Y0*i1-9],
   :longitude {},
   :datasetId #uuid "dd130b00-eacf-4989-badb-6b48b4978a19",
   :title "LGSSncNf5r",
   :geom "b89854H",
   :pointColorColumn nil,
   :latitude {},
   :visible true},
  :version 684,
  :baseLayer "h"},
 :name "",
 :type "5uWx737inZjGJ66NO1",
 :visualisationType "map",
 :created -4,
 :modified 130,
 :datasetId nil,
 :status "OK",
 :id #uuid "ff6b361a-5170-40d8-9f08-0e32603720f8"}
</pre>
</div>
</li>
</ol>
</div>




<div id="outline-container-org828739b" class="outline-4">
<h4 id="org828739b"><span class="section-number-4">1.3.7</span> data sample</h4>
<div class="outline-text-4" id="text-1-3-7">
</div>
<ol class="org-ol">
<li><a id="orgdaac1e6"></a>visualisation&#xa0;&#xa0;&#xa0;<span class="tag"><span class="visualisation">visualisation</span></span><br />
<div class="outline-text-5" id="text-1-3-7-1">
<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #707183;">(</span>remove-ns 'my.data.vis<span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">ns</span> <span style="color: #6434A3;">my.data.vis</span>
  <span style="color: #7388D6;">(</span><span style="color: #D0372D;">:require</span> <span style="color: #909183;">[</span>clojure.data <span style="color: #D0372D;">:refer</span> <span style="color: #709870;">(</span>diff<span style="color: #709870;">)</span><span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>akvo.lumen.lib.visualisation <span style="color: #D0372D;">:as</span> lib.visualisation<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>akvo.lumen.specs.visualisation<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>akvo.lumen.specs.visualisation.layer<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>akvo.lumen.specs.core <span style="color: #D0372D;">:as</span> lumen.s<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>clojure.spec.alpha <span style="color: #D0372D;">:as</span> s<span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">vis data samples</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">defn</span> <span style="color: #006699;">d*</span> <span style="color: #7388D6;">[</span>a b<span style="color: #7388D6;">]</span>
  <span style="color: #7388D6;">(</span>butlast <span style="color: #909183;">(</span>diff a b<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">defn</span> <span style="color: #006699;">c*</span>
  <span style="color: #036A07;">"i'd like to use s/conform to validate and return but conform restructure data depending spec conditions</span>
<span style="color: #036A07;">  like s/or ..."</span>
  <span style="color: #7388D6;">[</span>spec data<span style="color: #7388D6;">]</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">if</span> <span style="color: #909183;">(</span><span style="color: #6434A3;">s</span>/valid? spec data<span style="color: #909183;">)</span>
    data
    <span style="color: #909183;">(</span><span style="color: #0000FF;">let</span> <span style="color: #709870;">[</span>s <span style="color: #907373;">(</span>with-out-str <span style="color: #6276BA;">(</span><span style="color: #6434A3;">s</span>/explain spec data<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">]</span>
      <span style="color: #709870;">(</span><span style="color: #0000FF;">throw</span> <span style="color: #907373;">(</span>ex-info s <span style="color: #6276BA;">{}</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">create new vis</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">def</span> <span style="color: #BA36A5;">a</span> <span style="color: #7388D6;">(</span>c*
        <span style="color: #D0372D;">::</span><span style="color: #6434A3;">lib.visualisation</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">body</span>
        <span style="color: #909183;">{</span><span style="color: #D0372D;">:datasetId</span> <span style="color: #008000;">"5b224983-5d13-4538-8044-6ffd7c2410ae"</span>,
         <span style="color: #D0372D;">:name</span> <span style="color: #008000;">"Untitled visualisation"</span>,
         <span style="color: #D0372D;">:spec</span> <span style="color: #709870;">{</span><span style="color: #D0372D;">:baseLayer</span> <span style="color: #008000;">"street"</span>, <span style="color: #D0372D;">:layers</span> <span style="color: #907373;">[]</span>, <span style="color: #D0372D;">:version</span> 1<span style="color: #709870;">}</span>,
         <span style="color: #D0372D;">:type</span> <span style="color: #008000;">"visualisation"</span>,
         <span style="color: #D0372D;">:visualisationType</span> <span style="color: #008000;">"map"</span><span style="color: #909183;">}</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">add layer </span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">def</span> <span style="color: #BA36A5;">b</span> <span style="color: #7388D6;">(</span>c*
        <span style="color: #D0372D;">::</span><span style="color: #6434A3;">lib.visualisation</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">body</span>
        <span style="color: #909183;">{</span><span style="color: #D0372D;">:created</span> 1528973714897,
         <span style="color: #D0372D;">:datasetId</span> <span style="color: #008000;">"5b224983-5d13-4538-8044-6ffd7c2410ae"</span>,
         <span style="color: #D0372D;">:id</span> <span style="color: #008000;">"5b224992-6a9b-4ad2-89a6-07a1549be7b2"</span>,
         <span style="color: #D0372D;">:modified</span> 1528973714897,
         <span style="color: #D0372D;">:name</span> <span style="color: #008000;">"Untitled visualisation"</span>,
         <span style="color: #D0372D;">:spec</span>
         <span style="color: #709870;">{</span><span style="color: #D0372D;">:baseLayer</span> <span style="color: #008000;">"street"</span>,
          <span style="color: #D0372D;">:layers</span>
          <span style="color: #907373;">[</span><span style="color: #6276BA;">{</span><span style="color: #D0372D;">:aggregationMethod</span> <span style="color: #008000;">"avg"</span>,
            <span style="color: #D0372D;">:datasetId</span> <span style="color: #D0372D;">nil</span>,
            <span style="color: #D0372D;">:filters</span> <span style="color: #858580;">[]</span>,
            <span style="color: #D0372D;">:geom</span> <span style="color: #D0372D;">nil</span>,
            <span style="color: #D0372D;">:latitude</span> <span style="color: #D0372D;">nil</span>,
            <span style="color: #D0372D;">:layerType</span> <span style="color: #008000;">"geo-location"</span>,
            <span style="color: #D0372D;">:legend</span> <span style="color: #858580;">{</span><span style="color: #D0372D;">:title</span> <span style="color: #D0372D;">nil</span>, <span style="color: #D0372D;">:visible</span> <span style="color: #D0372D;">true</span><span style="color: #858580;">}</span>,
            <span style="color: #D0372D;">:longitude</span> <span style="color: #D0372D;">nil</span>,
            <span style="color: #D0372D;">:pointColorColumn</span> <span style="color: #D0372D;">nil</span>,
            <span style="color: #D0372D;">:pointColorMapping</span> <span style="color: #858580;">[]</span>,
            <span style="color: #D0372D;">:pointSize</span> 3,
            <span style="color: #D0372D;">:popup</span> <span style="color: #858580;">[]</span>,
            <span style="color: #D0372D;">:title</span> <span style="color: #008000;">"Untitled Layer 1"</span>,
            <span style="color: #D0372D;">:visible</span> <span style="color: #D0372D;">true</span><span style="color: #6276BA;">}</span><span style="color: #907373;">]</span>,
          <span style="color: #D0372D;">:version</span> 1<span style="color: #709870;">}</span>,
         <span style="color: #D0372D;">:status</span> <span style="color: #008000;">"OK"</span>,
         <span style="color: #D0372D;">:type</span> <span style="color: #008000;">"visualisation"</span>,
         <span style="color: #D0372D;">:visualisationType</span> <span style="color: #008000;">"map"</span><span style="color: #909183;">}</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span>d* a b<span style="color: #707183;">)</span>
<span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">=&gt; [{:spec {:layers nil}}</span>
<span style="color: #8D8D84;">;;     </span><span style="color: #8D8D84; font-style: italic;">{:created 1528973714897,</span>
<span style="color: #8D8D84;">;;      </span><span style="color: #8D8D84; font-style: italic;">:id "5b224992-6a9b-4ad2-89a6-07a1549be7b2",</span>
<span style="color: #8D8D84;">;;      </span><span style="color: #8D8D84; font-style: italic;">:modified 1528973714897,</span>
<span style="color: #8D8D84;">;;      </span><span style="color: #8D8D84; font-style: italic;">:spec</span>
<span style="color: #8D8D84;">;;      </span><span style="color: #8D8D84; font-style: italic;">{:layers</span>
<span style="color: #8D8D84;">;;       </span><span style="color: #8D8D84; font-style: italic;">[{:aggregationMethod "avg",</span>
<span style="color: #8D8D84;">;;         </span><span style="color: #8D8D84; font-style: italic;">:datasetId [:n nil],</span>
<span style="color: #8D8D84;">;;         </span><span style="color: #8D8D84; font-style: italic;">:filters [],</span>
<span style="color: #8D8D84;">;;         </span><span style="color: #8D8D84; font-style: italic;">:geom [:n nil],</span>
<span style="color: #8D8D84;">;;         </span><span style="color: #8D8D84; font-style: italic;">:latitude [:v nil],</span>
<span style="color: #8D8D84;">;;         </span><span style="color: #8D8D84; font-style: italic;">:layerType "geo-location",</span>
<span style="color: #8D8D84;">;;         </span><span style="color: #8D8D84; font-style: italic;">:legend {:title [:n nil], :visible true},</span>
<span style="color: #8D8D84;">;;         </span><span style="color: #8D8D84; font-style: italic;">:longitude [:v nil],</span>
<span style="color: #8D8D84;">;;         </span><span style="color: #8D8D84; font-style: italic;">:pointColorColumn [:v nil],</span>
<span style="color: #8D8D84;">;;         </span><span style="color: #8D8D84; font-style: italic;">:pointColorMapping [],</span>
<span style="color: #8D8D84;">;;         </span><span style="color: #8D8D84; font-style: italic;">:pointSize 3,</span>
<span style="color: #8D8D84;">;;         </span><span style="color: #8D8D84; font-style: italic;">:popup [],</span>
<span style="color: #8D8D84;">;;         </span><span style="color: #8D8D84; font-style: italic;">:title "Untitled Layer 1",</span>
<span style="color: #8D8D84;">;;         </span><span style="color: #8D8D84; font-style: italic;">:visible true}]},</span>
<span style="color: #8D8D84;">;;      </span><span style="color: #8D8D84; font-style: italic;">:status "OK"}]</span>


<span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">add dataset</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">def</span> <span style="color: #BA36A5;">c</span> <span style="color: #7388D6;">(</span>c*
        <span style="color: #D0372D;">::</span><span style="color: #6434A3;">lib.visualisation</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">body</span>
        <span style="color: #909183;">{</span><span style="color: #D0372D;">:created</span> 1528973714897,
         <span style="color: #D0372D;">:datasetId</span> <span style="color: #008000;">"5b224983-5d13-4538-8044-6ffd7c2410ae"</span>,
         <span style="color: #D0372D;">:id</span> <span style="color: #008000;">"5b224992-6a9b-4ad2-89a6-07a1549be7b2"</span>,
         <span style="color: #D0372D;">:modified</span> 1528973714897,
         <span style="color: #D0372D;">:name</span> <span style="color: #008000;">"Untitled visualisation"</span>,
         <span style="color: #D0372D;">:spec</span>
         <span style="color: #709870;">{</span><span style="color: #D0372D;">:baseLayer</span> <span style="color: #008000;">"street"</span>,
          <span style="color: #D0372D;">:layers</span>
          <span style="color: #907373;">[</span><span style="color: #6276BA;">{</span><span style="color: #D0372D;">:aggregationMethod</span> <span style="color: #008000;">"avg"</span>,
            <span style="color: #D0372D;">:datasetId</span> <span style="color: #008000;">"5b224983-5d13-4538-8044-6ffd7c2410ae"</span>,
            <span style="color: #D0372D;">:filters</span> <span style="color: #858580;">[]</span>,
            <span style="color: #D0372D;">:geom</span> <span style="color: #D0372D;">nil</span>,
            <span style="color: #D0372D;">:latitude</span> <span style="color: #D0372D;">nil</span>,
            <span style="color: #D0372D;">:layerType</span> <span style="color: #008000;">"geo-location"</span>,
            <span style="color: #D0372D;">:legend</span> <span style="color: #858580;">{</span><span style="color: #D0372D;">:title</span> <span style="color: #D0372D;">nil</span>, <span style="color: #D0372D;">:visible</span> <span style="color: #D0372D;">true</span><span style="color: #858580;">}</span>,
            <span style="color: #D0372D;">:longitude</span> <span style="color: #D0372D;">nil</span>,
            <span style="color: #D0372D;">:pointColorColumn</span> <span style="color: #D0372D;">nil</span>,
            <span style="color: #D0372D;">:pointColorMapping</span> <span style="color: #858580;">[]</span>,
            <span style="color: #D0372D;">:pointSize</span> 3,
            <span style="color: #D0372D;">:popup</span> <span style="color: #858580;">[]</span>,
            <span style="color: #D0372D;">:rasterId</span> <span style="color: #D0372D;">nil</span>,
            <span style="color: #D0372D;">:title</span> <span style="color: #008000;">"Untitled Layer 1"</span>,
            <span style="color: #D0372D;">:visible</span> <span style="color: #D0372D;">true</span><span style="color: #6276BA;">}</span><span style="color: #907373;">]</span>,
          <span style="color: #D0372D;">:version</span> 1<span style="color: #709870;">}</span>,
         <span style="color: #D0372D;">:status</span> <span style="color: #008000;">"OK"</span>,
         <span style="color: #D0372D;">:type</span> <span style="color: #008000;">"visualisation"</span>,
         <span style="color: #D0372D;">:visualisationType</span> <span style="color: #008000;">"map"</span><span style="color: #909183;">}</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span>d* b c<span style="color: #707183;">)</span>
<span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">=&gt; [{:spec {:layers [{:datasetId nil}]}}</span>
<span style="color: #8D8D84;">;;     </span><span style="color: #8D8D84; font-style: italic;">{:spec</span>
<span style="color: #8D8D84;">;;      </span><span style="color: #8D8D84; font-style: italic;">{:layers</span>
<span style="color: #8D8D84;">;;       </span><span style="color: #8D8D84; font-style: italic;">[{:datasetId "5b224983-5d13-4538-8044-6ffd7c2410ae",</span>
<span style="color: #8D8D84;">;;         </span><span style="color: #8D8D84; font-style: italic;">:rasterId nil}]}}]</span>
<span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">select geopoint ... =&gt; set geom!</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">def</span> <span style="color: #BA36A5;">d</span> <span style="color: #7388D6;">(</span>c*
        <span style="color: #D0372D;">::</span><span style="color: #6434A3;">lib.visualisation</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">body</span>
        <span style="color: #909183;">{</span><span style="color: #D0372D;">:created</span> 1528973714897,
         <span style="color: #D0372D;">:datasetId</span> <span style="color: #008000;">"5b224983-5d13-4538-8044-6ffd7c2410ae"</span>,
         <span style="color: #D0372D;">:id</span> <span style="color: #008000;">"5b224992-6a9b-4ad2-89a6-07a1549be7b2"</span>,
         <span style="color: #D0372D;">:modified</span> 1528973714897,
         <span style="color: #D0372D;">:name</span> <span style="color: #008000;">"Untitled visualisation"</span>,
         <span style="color: #D0372D;">:spec</span>
         <span style="color: #709870;">{</span><span style="color: #D0372D;">:baseLayer</span> <span style="color: #008000;">"street"</span>,
          <span style="color: #D0372D;">:layers</span>
          <span style="color: #907373;">[</span><span style="color: #6276BA;">{</span><span style="color: #D0372D;">:aggregationMethod</span> <span style="color: #008000;">"avg"</span>,
            <span style="color: #D0372D;">:datasetId</span> <span style="color: #008000;">"5b224983-5d13-4538-8044-6ffd7c2410ae"</span>,
            <span style="color: #D0372D;">:filters</span> <span style="color: #858580;">[]</span>,
            <span style="color: #D0372D;">:geom</span> <span style="color: #008000;">"d1"</span>,
            <span style="color: #D0372D;">:latitude</span> <span style="color: #D0372D;">nil</span>,
            <span style="color: #D0372D;">:layerType</span> <span style="color: #008000;">"geo-location"</span>,
            <span style="color: #D0372D;">:legend</span> <span style="color: #858580;">{</span><span style="color: #D0372D;">:title</span> <span style="color: #D0372D;">nil</span>, <span style="color: #D0372D;">:visible</span> <span style="color: #D0372D;">true</span><span style="color: #858580;">}</span>,
            <span style="color: #D0372D;">:longitude</span> <span style="color: #D0372D;">nil</span>,
            <span style="color: #D0372D;">:pointColorColumn</span> <span style="color: #D0372D;">nil</span>,
            <span style="color: #D0372D;">:pointColorMapping</span> <span style="color: #858580;">[]</span>,
            <span style="color: #D0372D;">:pointSize</span> 3,
            <span style="color: #D0372D;">:popup</span> <span style="color: #858580;">[]</span>,
            <span style="color: #D0372D;">:rasterId</span> <span style="color: #D0372D;">nil</span>,
            <span style="color: #D0372D;">:title</span> <span style="color: #008000;">"Untitled Layer 1"</span>,
            <span style="color: #D0372D;">:visible</span> <span style="color: #D0372D;">true</span><span style="color: #6276BA;">}</span><span style="color: #907373;">]</span>,
          <span style="color: #D0372D;">:version</span> 1<span style="color: #709870;">}</span>,
         <span style="color: #D0372D;">:status</span> <span style="color: #008000;">"OK"</span>,
         <span style="color: #D0372D;">:type</span> <span style="color: #008000;">"visualisation"</span>,
         <span style="color: #D0372D;">:visualisationType</span> <span style="color: #008000;">"map"</span><span style="color: #909183;">}</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span>d* c d<span style="color: #707183;">)</span>
<span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">=&gt; [{:spec {:layers [{:geom nil}]}} {:spec {:layers [{:geom "d1"}]}}]</span>

<span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">select color coding column =&gt; lattitude</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">def</span> <span style="color: #BA36A5;">e</span> <span style="color: #7388D6;">(</span>c*
        <span style="color: #D0372D;">::</span><span style="color: #6434A3;">lib.visualisation</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">body</span>
        <span style="color: #909183;">{</span><span style="color: #D0372D;">:created</span> 1528973714897,
         <span style="color: #D0372D;">:datasetId</span> <span style="color: #008000;">"5b224983-5d13-4538-8044-6ffd7c2410ae"</span>,
         <span style="color: #D0372D;">:id</span> <span style="color: #008000;">"5b224992-6a9b-4ad2-89a6-07a1549be7b2"</span>,
         <span style="color: #D0372D;">:modified</span> 1528973714897,
         <span style="color: #D0372D;">:name</span> <span style="color: #008000;">"Untitled visualisation"</span>,
         <span style="color: #D0372D;">:spec</span>
         <span style="color: #709870;">{</span><span style="color: #D0372D;">:baseLayer</span> <span style="color: #008000;">"street"</span>,
          <span style="color: #D0372D;">:layers</span>
          <span style="color: #907373;">[</span><span style="color: #6276BA;">{</span><span style="color: #D0372D;">:aggregationMethod</span> <span style="color: #008000;">"avg"</span>,
            <span style="color: #D0372D;">:datasetId</span> <span style="color: #008000;">"5b224983-5d13-4538-8044-6ffd7c2410ae"</span>,
            <span style="color: #D0372D;">:filters</span> <span style="color: #858580;">[]</span>,
            <span style="color: #D0372D;">:geom</span> <span style="color: #008000;">"d1"</span>,
            <span style="color: #D0372D;">:latitude</span> <span style="color: #D0372D;">nil</span>,
            <span style="color: #D0372D;">:layerType</span> <span style="color: #008000;">"geo-location"</span>,
            <span style="color: #D0372D;">:legend</span> <span style="color: #858580;">{</span><span style="color: #D0372D;">:title</span> <span style="color: #008000;">"latitude"</span>, <span style="color: #D0372D;">:visible</span> <span style="color: #D0372D;">true</span><span style="color: #858580;">}</span>,
            <span style="color: #D0372D;">:longitude</span> <span style="color: #D0372D;">nil</span>,
            <span style="color: #D0372D;">:pointColorColumn</span> <span style="color: #008000;">"c2"</span>,
            <span style="color: #D0372D;">:pointColorMapping</span> <span style="color: #858580;">[]</span>,
            <span style="color: #D0372D;">:pointSize</span> 3,
            <span style="color: #D0372D;">:popup</span> <span style="color: #858580;">[]</span>,
            <span style="color: #D0372D;">:rasterId</span> <span style="color: #D0372D;">nil</span>,
            <span style="color: #D0372D;">:title</span> <span style="color: #008000;">"Untitled Layer 1"</span>,
            <span style="color: #D0372D;">:visible</span> <span style="color: #D0372D;">true</span><span style="color: #6276BA;">}</span><span style="color: #907373;">]</span>,
          <span style="color: #D0372D;">:version</span> 1<span style="color: #709870;">}</span>,
         <span style="color: #D0372D;">:status</span> <span style="color: #008000;">"OK"</span>,
         <span style="color: #D0372D;">:type</span> <span style="color: #008000;">"visualisation"</span>,
         <span style="color: #D0372D;">:visualisationType</span> <span style="color: #008000;">"map"</span><span style="color: #909183;">}</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span>d* d e<span style="color: #707183;">)</span>
<span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">=&gt; [{:spec {:layers [{:legend {:title nil}, :pointColorColumn nil}]}}</span>
<span style="color: #8D8D84;">;;     </span><span style="color: #8D8D84; font-style: italic;">{:spec</span>
<span style="color: #8D8D84;">;;      </span><span style="color: #8D8D84; font-style: italic;">{:layers [{:legend {:title "latitude"}, :pointColorColumn "c2"}]}}]</span>


<span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">select color coding column =&gt; city (text)</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">def</span> <span style="color: #BA36A5;">e</span> <span style="color: #7388D6;">(</span>c*
        <span style="color: #D0372D;">::</span><span style="color: #6434A3;">lib.visualisation</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">body</span>
        <span style="color: #909183;">{</span><span style="color: #D0372D;">:created</span> 1528973714897,
         <span style="color: #D0372D;">:datasetId</span> <span style="color: #008000;">"5b224983-5d13-4538-8044-6ffd7c2410ae"</span>,
         <span style="color: #D0372D;">:id</span> <span style="color: #008000;">"5b224992-6a9b-4ad2-89a6-07a1549be7b2"</span>,
         <span style="color: #D0372D;">:modified</span> 1528973714897,
         <span style="color: #D0372D;">:name</span> <span style="color: #008000;">"Untitled visualisation"</span>,
         <span style="color: #D0372D;">:spec</span>
         <span style="color: #709870;">{</span><span style="color: #D0372D;">:baseLayer</span> <span style="color: #008000;">"street"</span>,
          <span style="color: #D0372D;">:layers</span>
          <span style="color: #907373;">[</span><span style="color: #6276BA;">{</span><span style="color: #D0372D;">:aggregationMethod</span> <span style="color: #008000;">"avg"</span>,
            <span style="color: #D0372D;">:datasetId</span> <span style="color: #008000;">"5b224983-5d13-4538-8044-6ffd7c2410ae"</span>,
            <span style="color: #D0372D;">:filters</span> <span style="color: #858580;">[]</span>,
            <span style="color: #D0372D;">:geom</span> <span style="color: #008000;">"d1"</span>,
            <span style="color: #D0372D;">:latitude</span> <span style="color: #D0372D;">nil</span>,
            <span style="color: #D0372D;">:layerType</span> <span style="color: #008000;">"geo-location"</span>,
            <span style="color: #D0372D;">:legend</span> <span style="color: #858580;">{</span><span style="color: #D0372D;">:title</span> <span style="color: #008000;">"city"</span>, <span style="color: #D0372D;">:visible</span> <span style="color: #D0372D;">true</span><span style="color: #858580;">}</span>,
            <span style="color: #D0372D;">:longitude</span> <span style="color: #D0372D;">nil</span>,
            <span style="color: #D0372D;">:pointColorColumn</span> <span style="color: #008000;">"c1"</span>,
            <span style="color: #D0372D;">:pointColorMapping</span> <span style="color: #858580;">[]</span>,
            <span style="color: #D0372D;">:pointSize</span> 3,
            <span style="color: #D0372D;">:popup</span> <span style="color: #858580;">[]</span>,
            <span style="color: #D0372D;">:rasterId</span> <span style="color: #D0372D;">nil</span>,
            <span style="color: #D0372D;">:title</span> <span style="color: #008000;">"Untitled Layer 1"</span>,
            <span style="color: #D0372D;">:visible</span> <span style="color: #D0372D;">true</span><span style="color: #6276BA;">}</span><span style="color: #907373;">]</span>,
          <span style="color: #D0372D;">:version</span> 1<span style="color: #709870;">}</span>,
         <span style="color: #D0372D;">:status</span> <span style="color: #008000;">"OK"</span>,
         <span style="color: #D0372D;">:type</span> <span style="color: #008000;">"visualisation"</span>,
         <span style="color: #D0372D;">:visualisationType</span> <span style="color: #008000;">"map"</span><span style="color: #909183;">}</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span>d* d e<span style="color: #707183;">)</span>
<span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">=&gt; [{:spec {:layers [{:legend {:title nil}, :pointColorColumn nil}]}}</span>
<span style="color: #8D8D84;">;;     </span><span style="color: #8D8D84; font-style: italic;">{:spec</span>
<span style="color: #8D8D84;">;;      </span><span style="color: #8D8D84; font-style: italic;">{:layers [{:legend {:title "city"}, :pointColorColumn "c1"}]}}]</span>


<span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">show legend =&gt; false</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">def</span> <span style="color: #BA36A5;">f</span> <span style="color: #7388D6;">(</span>c*
        <span style="color: #D0372D;">::</span><span style="color: #6434A3;">lib.visualisation</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">body</span>
        <span style="color: #909183;">{</span><span style="color: #D0372D;">:created</span> 1528973714897,
         <span style="color: #D0372D;">:datasetId</span> <span style="color: #008000;">"5b224983-5d13-4538-8044-6ffd7c2410ae"</span>,
         <span style="color: #D0372D;">:id</span> <span style="color: #008000;">"5b224992-6a9b-4ad2-89a6-07a1549be7b2"</span>,
         <span style="color: #D0372D;">:modified</span> 1528973714897,
         <span style="color: #D0372D;">:name</span> <span style="color: #008000;">"Untitled visualisation"</span>,
         <span style="color: #D0372D;">:spec</span>
         <span style="color: #709870;">{</span><span style="color: #D0372D;">:baseLayer</span> <span style="color: #008000;">"street"</span>,
          <span style="color: #D0372D;">:layers</span>
          <span style="color: #907373;">[</span><span style="color: #6276BA;">{</span><span style="color: #D0372D;">:aggregationMethod</span> <span style="color: #008000;">"avg"</span>,
            <span style="color: #D0372D;">:datasetId</span> <span style="color: #008000;">"5b224983-5d13-4538-8044-6ffd7c2410ae"</span>,
            <span style="color: #D0372D;">:filters</span> <span style="color: #858580;">[]</span>,
            <span style="color: #D0372D;">:geom</span> <span style="color: #008000;">"d1"</span>,
            <span style="color: #D0372D;">:latitude</span> <span style="color: #D0372D;">nil</span>,
            <span style="color: #D0372D;">:layerType</span> <span style="color: #008000;">"geo-location"</span>,
            <span style="color: #D0372D;">:legend</span> <span style="color: #858580;">{</span><span style="color: #D0372D;">:title</span> <span style="color: #008000;">"city"</span>, <span style="color: #D0372D;">:visible</span> <span style="color: #D0372D;">false</span><span style="color: #858580;">}</span>,
            <span style="color: #D0372D;">:longitude</span> <span style="color: #D0372D;">nil</span>,
            <span style="color: #D0372D;">:pointColorColumn</span> <span style="color: #008000;">"c1"</span>,
            <span style="color: #D0372D;">:pointColorMapping</span> <span style="color: #858580;">[]</span>,
            <span style="color: #D0372D;">:pointSize</span> 3,
            <span style="color: #D0372D;">:popup</span> <span style="color: #858580;">[]</span>,
            <span style="color: #D0372D;">:rasterId</span> <span style="color: #D0372D;">nil</span>,
            <span style="color: #D0372D;">:title</span> <span style="color: #008000;">"Untitled Layer 1"</span>,
            <span style="color: #D0372D;">:visible</span> <span style="color: #D0372D;">true</span><span style="color: #6276BA;">}</span><span style="color: #907373;">]</span>,
          <span style="color: #D0372D;">:version</span> 1<span style="color: #709870;">}</span>,
         <span style="color: #D0372D;">:status</span> <span style="color: #008000;">"OK"</span>,
         <span style="color: #D0372D;">:type</span> <span style="color: #008000;">"visualisation"</span>,
         <span style="color: #D0372D;">:visualisationType</span> <span style="color: #008000;">"map"</span><span style="color: #909183;">}</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span>d* e f<span style="color: #707183;">)</span>
<span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">=&gt; [{:spec {:layers [{:legend {:visible true}}]}}</span>
<span style="color: #8D8D84;">;;     </span><span style="color: #8D8D84; font-style: italic;">{:spec {:layers [{:legend {:visible false}}]}}]</span>


<span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">pop up city(text)</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">def</span> <span style="color: #BA36A5;">g</span> <span style="color: #7388D6;">(</span>c*
        <span style="color: #D0372D;">::</span><span style="color: #6434A3;">lib.visualisation</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">body</span>
        <span style="color: #909183;">{</span><span style="color: #D0372D;">:created</span> 1528973714897,
         <span style="color: #D0372D;">:datasetId</span> <span style="color: #008000;">"5b224983-5d13-4538-8044-6ffd7c2410ae"</span>,
         <span style="color: #D0372D;">:id</span> <span style="color: #008000;">"5b224992-6a9b-4ad2-89a6-07a1549be7b2"</span>,
         <span style="color: #D0372D;">:modified</span> 1528973714897,
         <span style="color: #D0372D;">:name</span> <span style="color: #008000;">"Untitled visualisation"</span>,
         <span style="color: #D0372D;">:spec</span>
         <span style="color: #709870;">{</span><span style="color: #D0372D;">:baseLayer</span> <span style="color: #008000;">"street"</span>,
          <span style="color: #D0372D;">:layers</span>
          <span style="color: #907373;">[</span><span style="color: #6276BA;">{</span><span style="color: #D0372D;">:aggregationMethod</span> <span style="color: #008000;">"avg"</span>,
            <span style="color: #D0372D;">:datasetId</span> <span style="color: #008000;">"5b224983-5d13-4538-8044-6ffd7c2410ae"</span>,
            <span style="color: #D0372D;">:filters</span> <span style="color: #858580;">[]</span>,
            <span style="color: #D0372D;">:geom</span> <span style="color: #008000;">"d1"</span>,
            <span style="color: #D0372D;">:latitude</span> <span style="color: #D0372D;">nil</span>,
            <span style="color: #D0372D;">:layerType</span> <span style="color: #008000;">"geo-location"</span>,
            <span style="color: #D0372D;">:legend</span> <span style="color: #858580;">{</span><span style="color: #D0372D;">:title</span> <span style="color: #008000;">"city"</span>, <span style="color: #D0372D;">:visible</span> <span style="color: #D0372D;">true</span><span style="color: #858580;">}</span>,
            <span style="color: #D0372D;">:longitude</span> <span style="color: #D0372D;">nil</span>,
            <span style="color: #D0372D;">:pointColorColumn</span> <span style="color: #008000;">"c1"</span>,
            <span style="color: #D0372D;">:pointColorMapping</span> <span style="color: #858580;">[]</span>,
            <span style="color: #D0372D;">:pointSize</span> 3,
            <span style="color: #D0372D;">:popup</span> <span style="color: #858580;">[</span><span style="color: #80A880;">{</span><span style="color: #D0372D;">:column</span> <span style="color: #008000;">"c1"</span><span style="color: #80A880;">}</span><span style="color: #858580;">]</span>,
            <span style="color: #D0372D;">:rasterId</span> <span style="color: #D0372D;">nil</span>,
            <span style="color: #D0372D;">:title</span> <span style="color: #008000;">"Untitled Layer 1"</span>,
            <span style="color: #D0372D;">:visible</span> <span style="color: #D0372D;">true</span><span style="color: #6276BA;">}</span><span style="color: #907373;">]</span>,
          <span style="color: #D0372D;">:version</span> 1<span style="color: #709870;">}</span>,
         <span style="color: #D0372D;">:status</span> <span style="color: #008000;">"OK"</span>,
         <span style="color: #D0372D;">:type</span> <span style="color: #008000;">"visualisation"</span>,
         <span style="color: #D0372D;">:visualisationType</span> <span style="color: #008000;">"map"</span><span style="color: #909183;">}</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span>d* f g<span style="color: #707183;">)</span>
<span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">=&gt; [{:spec {:layers [{:legend {:visible false}, :popup nil}]}}</span>
<span style="color: #8D8D84;">;;     </span><span style="color: #8D8D84; font-style: italic;">{:spec</span>
<span style="color: #8D8D84;">;;      </span><span style="color: #8D8D84; font-style: italic;">{:layers [{:legend {:visible true}, :popup [{:column "c1"}]}]}}]</span>

<span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">theme change point size</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">def</span> <span style="color: #BA36A5;">h</span> <span style="color: #7388D6;">(</span>c*
        <span style="color: #D0372D;">::</span><span style="color: #6434A3;">lib.visualisation</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">body</span>
        <span style="color: #909183;">{</span><span style="color: #D0372D;">:created</span> 1528973714897,
         <span style="color: #D0372D;">:datasetId</span> <span style="color: #008000;">"5b224983-5d13-4538-8044-6ffd7c2410ae"</span>,
         <span style="color: #D0372D;">:id</span> <span style="color: #008000;">"5b224992-6a9b-4ad2-89a6-07a1549be7b2"</span>,
         <span style="color: #D0372D;">:modified</span> 1528973714897,
         <span style="color: #D0372D;">:name</span> <span style="color: #008000;">"Untitled visualisation"</span>,
         <span style="color: #D0372D;">:spec</span>
         <span style="color: #709870;">{</span><span style="color: #D0372D;">:baseLayer</span> <span style="color: #008000;">"street"</span>,
          <span style="color: #D0372D;">:layers</span>
          <span style="color: #907373;">[</span><span style="color: #6276BA;">{</span><span style="color: #D0372D;">:aggregationMethod</span> <span style="color: #008000;">"avg"</span>,
            <span style="color: #D0372D;">:datasetId</span> <span style="color: #008000;">"5b224983-5d13-4538-8044-6ffd7c2410ae"</span>,
            <span style="color: #D0372D;">:filters</span> <span style="color: #858580;">[]</span>,
            <span style="color: #D0372D;">:geom</span> <span style="color: #008000;">"d1"</span>,
            <span style="color: #D0372D;">:latitude</span> <span style="color: #D0372D;">nil</span>,
            <span style="color: #D0372D;">:layerType</span> <span style="color: #008000;">"geo-location"</span>,
            <span style="color: #D0372D;">:legend</span> <span style="color: #858580;">{</span><span style="color: #D0372D;">:title</span> <span style="color: #008000;">"city"</span>, <span style="color: #D0372D;">:visible</span> <span style="color: #D0372D;">true</span><span style="color: #858580;">}</span>,
            <span style="color: #D0372D;">:longitude</span> <span style="color: #D0372D;">nil</span>,
            <span style="color: #D0372D;">:pointColorColumn</span> <span style="color: #008000;">"c1"</span>,
            <span style="color: #D0372D;">:pointColorMapping</span> <span style="color: #858580;">[]</span>,
            <span style="color: #D0372D;">:pointSize</span> <span style="color: #008000;">"5"</span>,
            <span style="color: #D0372D;">:popup</span> <span style="color: #858580;">[</span><span style="color: #80A880;">{</span><span style="color: #D0372D;">:column</span> <span style="color: #008000;">"c1"</span><span style="color: #80A880;">}</span><span style="color: #858580;">]</span>,
            <span style="color: #D0372D;">:rasterId</span> <span style="color: #D0372D;">nil</span>,
            <span style="color: #D0372D;">:title</span> <span style="color: #008000;">"Untitled Layer 1"</span>,
            <span style="color: #D0372D;">:visible</span> <span style="color: #D0372D;">true</span><span style="color: #6276BA;">}</span><span style="color: #907373;">]</span>,
          <span style="color: #D0372D;">:version</span> 1<span style="color: #709870;">}</span>,
         <span style="color: #D0372D;">:status</span> <span style="color: #008000;">"OK"</span>,
         <span style="color: #D0372D;">:type</span> <span style="color: #008000;">"visualisation"</span>,
         <span style="color: #D0372D;">:visualisationType</span> <span style="color: #008000;">"map"</span><span style="color: #909183;">}</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span>d* g h<span style="color: #707183;">)</span>
<span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">=&gt; [{:spec {:layers [{:pointSize 3}]}}</span>
<span style="color: #8D8D84;">;;     </span><span style="color: #8D8D84; font-style: italic;">{:spec {:layers [{:pointSize "5"}]}}]</span>


<span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">theme change color</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">def</span> <span style="color: #BA36A5;">i</span> <span style="color: #7388D6;">(</span>c*
        <span style="color: #D0372D;">::</span><span style="color: #6434A3;">lib.visualisation</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">body</span>
        <span style="color: #909183;">{</span><span style="color: #D0372D;">:created</span> 1528973714897,
         <span style="color: #D0372D;">:datasetId</span> <span style="color: #008000;">"5b224983-5d13-4538-8044-6ffd7c2410ae"</span>,
         <span style="color: #D0372D;">:id</span> <span style="color: #008000;">"5b224992-6a9b-4ad2-89a6-07a1549be7b2"</span>,
         <span style="color: #D0372D;">:modified</span> 1528973714897,
         <span style="color: #D0372D;">:name</span> <span style="color: #008000;">"Untitled visualisation"</span>,
         <span style="color: #D0372D;">:spec</span>
         <span style="color: #709870;">{</span><span style="color: #D0372D;">:baseLayer</span> <span style="color: #008000;">"street"</span>,
          <span style="color: #D0372D;">:layers</span>
          <span style="color: #907373;">[</span><span style="color: #6276BA;">{</span><span style="color: #D0372D;">:aggregationMethod</span> <span style="color: #008000;">"avg"</span>,
            <span style="color: #D0372D;">:datasetId</span> <span style="color: #008000;">"5b224983-5d13-4538-8044-6ffd7c2410ae"</span>,
            <span style="color: #D0372D;">:filters</span> <span style="color: #858580;">[]</span>,
            <span style="color: #D0372D;">:geom</span> <span style="color: #008000;">"d1"</span>,
            <span style="color: #D0372D;">:latitude</span> <span style="color: #D0372D;">nil</span>,
            <span style="color: #D0372D;">:layerType</span> <span style="color: #008000;">"geo-location"</span>,
            <span style="color: #D0372D;">:legend</span> <span style="color: #858580;">{</span><span style="color: #D0372D;">:title</span> <span style="color: #008000;">"city"</span>, <span style="color: #D0372D;">:visible</span> <span style="color: #D0372D;">true</span><span style="color: #858580;">}</span>,
            <span style="color: #D0372D;">:longitude</span> <span style="color: #D0372D;">nil</span>,
            <span style="color: #D0372D;">:pointColorColumn</span> <span style="color: #008000;">"c1"</span>,
            <span style="color: #D0372D;">:pointColorMapping</span>
            <span style="color: #858580;">[</span><span style="color: #80A880;">{</span><span style="color: #D0372D;">:color</span> <span style="color: #008000;">"#c799ae"</span>, <span style="color: #D0372D;">:op</span> <span style="color: #008000;">"equals"</span>, <span style="color: #D0372D;">:value</span> <span style="color: #008000;">"Amsterdam"</span><span style="color: #80A880;">}</span>
             <span style="color: #80A880;">{</span><span style="color: #D0372D;">:color</span> <span style="color: #008000;">"#c799ae"</span>, <span style="color: #D0372D;">:op</span> <span style="color: #008000;">"equals"</span>, <span style="color: #D0372D;">:value</span> <span style="color: #008000;">"Stockholm"</span><span style="color: #80A880;">}</span><span style="color: #858580;">]</span>,
            <span style="color: #D0372D;">:pointSize</span> <span style="color: #008000;">"5"</span>,
            <span style="color: #D0372D;">:popup</span> <span style="color: #858580;">[</span><span style="color: #80A880;">{</span><span style="color: #D0372D;">:column</span> <span style="color: #008000;">"c1"</span><span style="color: #80A880;">}</span><span style="color: #858580;">]</span>,
            <span style="color: #D0372D;">:rasterId</span> <span style="color: #D0372D;">nil</span>,
            <span style="color: #D0372D;">:title</span> <span style="color: #008000;">"Untitled Layer 1"</span>,
            <span style="color: #D0372D;">:visible</span> <span style="color: #D0372D;">true</span><span style="color: #6276BA;">}</span><span style="color: #907373;">]</span>,
          <span style="color: #D0372D;">:version</span> 1<span style="color: #709870;">}</span>,
         <span style="color: #D0372D;">:status</span> <span style="color: #008000;">"OK"</span>,
         <span style="color: #D0372D;">:type</span> <span style="color: #008000;">"visualisation"</span>,
         <span style="color: #D0372D;">:visualisationType</span> <span style="color: #008000;">"map"</span><span style="color: #909183;">}</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span>d* h i<span style="color: #707183;">)</span>
<span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">=&gt; [{:spec {:layers [{:pointColorMapping nil}]}}</span>
<span style="color: #8D8D84;">;;     </span><span style="color: #8D8D84; font-style: italic;">{:spec</span>
<span style="color: #8D8D84;">;;      </span><span style="color: #8D8D84; font-style: italic;">{:layers</span>
<span style="color: #8D8D84;">;;       </span><span style="color: #8D8D84; font-style: italic;">[{:pointColorMapping</span>
<span style="color: #8D8D84;">;;         </span><span style="color: #8D8D84; font-style: italic;">[{:color "#c799ae", :op "equals", :value "Amsterdam"}</span>
<span style="color: #8D8D84;">;;          </span><span style="color: #8D8D84; font-style: italic;">{:color "#c799ae", :op "equals", :value "Stockholm"}]}]}}]</span>


<span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">filtering</span>
<span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">add filter</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">def</span> <span style="color: #BA36A5;">j</span> <span style="color: #7388D6;">(</span>c*
        <span style="color: #D0372D;">::</span><span style="color: #6434A3;">lib.visualisation</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">body</span>
        <span style="color: #909183;">{</span><span style="color: #D0372D;">:created</span> 1528973714897,
         <span style="color: #D0372D;">:datasetId</span> <span style="color: #008000;">"5b224983-5d13-4538-8044-6ffd7c2410ae"</span>,
         <span style="color: #D0372D;">:id</span> <span style="color: #008000;">"5b224992-6a9b-4ad2-89a6-07a1549be7b2"</span>,
         <span style="color: #D0372D;">:modified</span> 1528973714897,
         <span style="color: #D0372D;">:name</span> <span style="color: #008000;">"Untitled visualisation"</span>,
         <span style="color: #D0372D;">:spec</span>
         <span style="color: #709870;">{</span><span style="color: #D0372D;">:baseLayer</span> <span style="color: #008000;">"street"</span>,
          <span style="color: #D0372D;">:layers</span>
          <span style="color: #907373;">[</span><span style="color: #6276BA;">{</span><span style="color: #D0372D;">:aggregationMethod</span> <span style="color: #008000;">"avg"</span>,
            <span style="color: #D0372D;">:datasetId</span> <span style="color: #008000;">"5b224983-5d13-4538-8044-6ffd7c2410ae"</span>,
            <span style="color: #D0372D;">:filters</span>
            <span style="color: #858580;">[</span><span style="color: #80A880;">{</span><span style="color: #D0372D;">:column</span> <span style="color: #008000;">"c2"</span>,
              <span style="color: #D0372D;">:columnType</span> <span style="color: #008000;">"number"</span>,
              <span style="color: #D0372D;">:operation</span> <span style="color: #008000;">"keep"</span>,
              <span style="color: #D0372D;">:origin</span> <span style="color: #008000;">"filterMenu"</span>,
              <span style="color: #D0372D;">:strategy</span> <span style="color: #008000;">"isLower"</span>,
              <span style="color: #D0372D;">:value</span> <span style="color: #008000;">"100000"</span><span style="color: #80A880;">}</span><span style="color: #858580;">]</span>,
            <span style="color: #D0372D;">:geom</span> <span style="color: #008000;">"d1"</span>,
            <span style="color: #D0372D;">:latitude</span> <span style="color: #D0372D;">nil</span>,
            <span style="color: #D0372D;">:layerType</span> <span style="color: #008000;">"geo-location"</span>,
            <span style="color: #D0372D;">:legend</span> <span style="color: #858580;">{</span><span style="color: #D0372D;">:title</span> <span style="color: #008000;">"city"</span>, <span style="color: #D0372D;">:visible</span> <span style="color: #D0372D;">true</span><span style="color: #858580;">}</span>,
            <span style="color: #D0372D;">:longitude</span> <span style="color: #D0372D;">nil</span>,
            <span style="color: #D0372D;">:pointColorColumn</span> <span style="color: #008000;">"c1"</span>,
            <span style="color: #D0372D;">:pointColorMapping</span>
            <span style="color: #858580;">[</span><span style="color: #80A880;">{</span><span style="color: #D0372D;">:color</span> <span style="color: #008000;">"#c799ae"</span>, <span style="color: #D0372D;">:op</span> <span style="color: #008000;">"equals"</span>, <span style="color: #D0372D;">:value</span> <span style="color: #008000;">"Amsterdam"</span><span style="color: #80A880;">}</span>
             <span style="color: #80A880;">{</span><span style="color: #D0372D;">:color</span> <span style="color: #008000;">"#c799ae"</span>, <span style="color: #D0372D;">:op</span> <span style="color: #008000;">"equals"</span>, <span style="color: #D0372D;">:value</span> <span style="color: #008000;">"Stockholm"</span><span style="color: #80A880;">}</span><span style="color: #858580;">]</span>,
            <span style="color: #D0372D;">:pointSize</span> <span style="color: #008000;">"5"</span>,
            <span style="color: #D0372D;">:popup</span> <span style="color: #858580;">[</span><span style="color: #80A880;">{</span><span style="color: #D0372D;">:column</span> <span style="color: #008000;">"c1"</span><span style="color: #80A880;">}</span><span style="color: #858580;">]</span>,
            <span style="color: #D0372D;">:rasterId</span> <span style="color: #D0372D;">nil</span>,
            <span style="color: #D0372D;">:title</span> <span style="color: #008000;">"Untitled Layer 1"</span>,
            <span style="color: #D0372D;">:visible</span> <span style="color: #D0372D;">true</span><span style="color: #6276BA;">}</span><span style="color: #907373;">]</span>,
          <span style="color: #D0372D;">:version</span> 1<span style="color: #709870;">}</span>,
         <span style="color: #D0372D;">:status</span> <span style="color: #008000;">"OK"</span>,
         <span style="color: #D0372D;">:type</span> <span style="color: #008000;">"visualisation"</span>,
         <span style="color: #D0372D;">:visualisationType</span> <span style="color: #008000;">"map"</span><span style="color: #909183;">}</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span>d* i j<span style="color: #707183;">)</span>
<span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">=&gt; [{:spec {:layers [{:filters nil}]}}</span>
<span style="color: #8D8D84;">;;     </span><span style="color: #8D8D84; font-style: italic;">{:spec</span>
<span style="color: #8D8D84;">;;      </span><span style="color: #8D8D84; font-style: italic;">{:layers</span>
<span style="color: #8D8D84;">;;       </span><span style="color: #8D8D84; font-style: italic;">[{:filters</span>
<span style="color: #8D8D84;">;;         </span><span style="color: #8D8D84; font-style: italic;">[{:column "c2",</span>
<span style="color: #8D8D84;">;;           </span><span style="color: #8D8D84; font-style: italic;">:columnType "number",</span>
<span style="color: #8D8D84;">;;           </span><span style="color: #8D8D84; font-style: italic;">:operation "keep",</span>
<span style="color: #8D8D84;">;;           </span><span style="color: #8D8D84; font-style: italic;">:origin "filterMenu",</span>
<span style="color: #8D8D84;">;;           </span><span style="color: #8D8D84; font-style: italic;">:strategy "isLower",</span>
<span style="color: #8D8D84;">;;           </span><span style="color: #8D8D84; font-style: italic;">:value "100000"}]}]}}]</span>


<span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">another filter example after removing preovious one</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">def</span> <span style="color: #BA36A5;">k</span> <span style="color: #7388D6;">(</span>c*
        <span style="color: #D0372D;">::</span><span style="color: #6434A3;">lib.visualisation</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">body</span>
        <span style="color: #909183;">{</span><span style="color: #D0372D;">:created</span> 1528973714897,
         <span style="color: #D0372D;">:datasetId</span> <span style="color: #008000;">"5b224983-5d13-4538-8044-6ffd7c2410ae"</span>,
         <span style="color: #D0372D;">:id</span> <span style="color: #008000;">"5b224992-6a9b-4ad2-89a6-07a1549be7b2"</span>,
         <span style="color: #D0372D;">:modified</span> 1528973714897,
         <span style="color: #D0372D;">:name</span> <span style="color: #008000;">"Untitled visualisation"</span>,
         <span style="color: #D0372D;">:spec</span>
         <span style="color: #709870;">{</span><span style="color: #D0372D;">:baseLayer</span> <span style="color: #008000;">"street"</span>,
          <span style="color: #D0372D;">:layers</span>
          <span style="color: #907373;">[</span><span style="color: #6276BA;">{</span><span style="color: #D0372D;">:aggregationMethod</span> <span style="color: #008000;">"avg"</span>,
            <span style="color: #D0372D;">:datasetId</span> <span style="color: #008000;">"5b224983-5d13-4538-8044-6ffd7c2410ae"</span>,
            <span style="color: #D0372D;">:filters</span>
            <span style="color: #858580;">[</span><span style="color: #80A880;">{</span><span style="color: #D0372D;">:column</span> <span style="color: #008000;">"c2"</span>,
              <span style="color: #D0372D;">:columnType</span> <span style="color: #008000;">"number"</span>,
              <span style="color: #D0372D;">:operation</span> <span style="color: #008000;">"remove"</span>,
              <span style="color: #D0372D;">:origin</span> <span style="color: #008000;">"filterMenu"</span>,
              <span style="color: #D0372D;">:strategy</span> <span style="color: #008000;">"is"</span>,
              <span style="color: #D0372D;">:value</span> <span style="color: #008000;">"78"</span><span style="color: #80A880;">}</span><span style="color: #858580;">]</span>,
            <span style="color: #D0372D;">:geom</span> <span style="color: #008000;">"d1"</span>,
            <span style="color: #D0372D;">:latitude</span> <span style="color: #D0372D;">nil</span>,
            <span style="color: #D0372D;">:layerType</span> <span style="color: #008000;">"geo-location"</span>,
            <span style="color: #D0372D;">:legend</span> <span style="color: #858580;">{</span><span style="color: #D0372D;">:title</span> <span style="color: #008000;">"city"</span>, <span style="color: #D0372D;">:visible</span> <span style="color: #D0372D;">true</span><span style="color: #858580;">}</span>,
            <span style="color: #D0372D;">:longitude</span> <span style="color: #D0372D;">nil</span>,
            <span style="color: #D0372D;">:pointColorColumn</span> <span style="color: #008000;">"c1"</span>,
            <span style="color: #D0372D;">:pointColorMapping</span>
            <span style="color: #858580;">[</span><span style="color: #80A880;">{</span><span style="color: #D0372D;">:color</span> <span style="color: #008000;">"#c799ae"</span>, <span style="color: #D0372D;">:op</span> <span style="color: #008000;">"equals"</span>, <span style="color: #D0372D;">:value</span> <span style="color: #008000;">"Amsterdam"</span><span style="color: #80A880;">}</span>
             <span style="color: #80A880;">{</span><span style="color: #D0372D;">:color</span> <span style="color: #008000;">"#c799ae"</span>, <span style="color: #D0372D;">:op</span> <span style="color: #008000;">"equals"</span>, <span style="color: #D0372D;">:value</span> <span style="color: #008000;">"Stockholm"</span><span style="color: #80A880;">}</span><span style="color: #858580;">]</span>,
            <span style="color: #D0372D;">:pointSize</span> <span style="color: #008000;">"5"</span>,
            <span style="color: #D0372D;">:popup</span> <span style="color: #858580;">[</span><span style="color: #80A880;">{</span><span style="color: #D0372D;">:column</span> <span style="color: #008000;">"c1"</span><span style="color: #80A880;">}</span><span style="color: #858580;">]</span>,
            <span style="color: #D0372D;">:rasterId</span> <span style="color: #D0372D;">nil</span>,
            <span style="color: #D0372D;">:title</span> <span style="color: #008000;">"Untitled Layer 1"</span>,
            <span style="color: #D0372D;">:visible</span> <span style="color: #D0372D;">true</span><span style="color: #6276BA;">}</span><span style="color: #907373;">]</span>,
          <span style="color: #D0372D;">:version</span> 1<span style="color: #709870;">}</span>,
         <span style="color: #D0372D;">:status</span> <span style="color: #008000;">"OK"</span>,
         <span style="color: #D0372D;">:type</span> <span style="color: #008000;">"visualisation"</span>,
         <span style="color: #D0372D;">:visualisationType</span> <span style="color: #008000;">"map"</span><span style="color: #909183;">}</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span>d* i k<span style="color: #707183;">)</span>
<span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">=&gt; [{:spec {:layers [{:filters nil}]}}</span>
<span style="color: #8D8D84;">;;     </span><span style="color: #8D8D84; font-style: italic;">{:spec</span>
<span style="color: #8D8D84;">;;      </span><span style="color: #8D8D84; font-style: italic;">{:layers</span>
<span style="color: #8D8D84;">;;       </span><span style="color: #8D8D84; font-style: italic;">[{:filters</span>
<span style="color: #8D8D84;">;;         </span><span style="color: #8D8D84; font-style: italic;">[{:column "c2",</span>
<span style="color: #8D8D84;">;;           </span><span style="color: #8D8D84; font-style: italic;">:columnType "number",</span>
<span style="color: #8D8D84;">;;           </span><span style="color: #8D8D84; font-style: italic;">:operation "remove",</span>
<span style="color: #8D8D84;">;;           </span><span style="color: #8D8D84; font-style: italic;">:origin "filterMenu",</span>
<span style="color: #8D8D84;">;;           </span><span style="color: #8D8D84; font-style: italic;">:strategy "is",</span>
<span style="color: #8D8D84;">;;           </span><span style="color: #8D8D84; font-style: italic;">:value "78"}]}]}}]</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #707183;">(</span>remove-ns 'my.data.transformation<span style="color: #707183;">)</span> 
<span style="color: #707183;">(</span><span style="color: #0000FF;">ns</span> <span style="color: #6434A3;">my.data.transformation</span>
  <span style="color: #7388D6;">(</span><span style="color: #D0372D;">:require</span> <span style="color: #909183;">[</span>clojure.data <span style="color: #D0372D;">:refer</span> <span style="color: #709870;">(</span>diff<span style="color: #709870;">)</span><span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>akvo.lumen.specs.core <span style="color: #D0372D;">:as</span> lumen.s<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>akvo.lumen.transformation <span style="color: #D0372D;">:as</span> transformation<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>akvo.lumen.transformation.engine <span style="color: #D0372D;">:as</span> transformation.engine<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>clojure.walk <span style="color: #D0372D;">:refer</span> <span style="color: #709870;">(</span>keywordize-keys<span style="color: #709870;">)</span><span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>clojure.spec.alpha <span style="color: #D0372D;">:as</span> s<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>akvo.lumen.specs.transformations<span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">defn</span> <span style="color: #006699;">d*</span> <span style="color: #7388D6;">[</span>a b<span style="color: #7388D6;">]</span>
  <span style="color: #7388D6;">(</span>butlast <span style="color: #909183;">(</span>diff a b<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">defn</span> <span style="color: #006699;">c*</span>
  <span style="color: #036A07;">"i'd like to use s/conform to validate and return but conform restructure data depending spec conditions</span>
<span style="color: #036A07;">  like s/or ..."</span>
  <span style="color: #7388D6;">[</span>spec data<span style="color: #7388D6;">]</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">if</span> <span style="color: #909183;">(</span><span style="color: #6434A3;">s</span>/valid? spec data<span style="color: #909183;">)</span>
    data
    <span style="color: #909183;">(</span><span style="color: #0000FF;">let</span> <span style="color: #709870;">[</span>s <span style="color: #907373;">(</span>with-out-str <span style="color: #6276BA;">(</span><span style="color: #6434A3;">s</span>/explain spec data<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">]</span>
      <span style="color: #709870;">(</span><span style="color: #0000FF;">throw</span> <span style="color: #907373;">(</span>ex-info s <span style="color: #6276BA;">{}</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">generate-geopoints</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">def</span> <span style="color: #BA36A5;">a</span> <span style="color: #7388D6;">{</span><span style="color: #D0372D;">:transformation</span>
        <span style="color: #909183;">{</span><span style="color: #D0372D;">:args</span>
         <span style="color: #709870;">{</span><span style="color: #D0372D;">:ColumnTitleGeo</span> <span style="color: #008000;">""</span>,
          <span style="color: #D0372D;">:columnNameLat</span> <span style="color: #008000;">"c2"</span>,
          <span style="color: #D0372D;">:columnNameLong</span> <span style="color: #008000;">"c3"</span>,
          <span style="color: #D0372D;">:columnTitleGeo</span> <span style="color: #008000;">"asdasd"</span><span style="color: #709870;">}</span>,
         <span style="color: #D0372D;">:onError</span> <span style="color: #008000;">"fail"</span>,
         <span style="color: #D0372D;">:op</span> <span style="color: #008000;">"core/generate-geopoints"</span><span style="color: #909183;">}</span>,
        <span style="color: #D0372D;">:type</span> <span style="color: #D0372D;">:transformation</span><span style="color: #7388D6;">}</span><span style="color: #707183;">)</span>

<span style="color: #D0372D;">::</span><span style="color: #6434A3;">transformation.engine</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">op-spec</span>
<span style="color: #707183;">(</span><span style="color: #6434A3;">transformation.engine</span>/valid? <span style="color: #7388D6;">(</span><span style="color: #D0372D;">:transformation</span> a<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span>c* <span style="color: #D0372D;">::</span><span style="color: #6434A3;">transformation.engine</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">op-spec</span> <span style="color: #7388D6;">(</span><span style="color: #D0372D;">:transformation</span> a<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span>c* <span style="color: #D0372D;">::</span><span style="color: #6434A3;">transformation</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">command</span> a<span style="color: #707183;">)</span>
<span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">=&gt; {:transformation</span>
<span style="color: #8D8D84;">;;     </span><span style="color: #8D8D84; font-style: italic;">{"args"</span>
<span style="color: #8D8D84;">;;      </span><span style="color: #8D8D84; font-style: italic;">{"ColumnTitleGeo" "",</span>
<span style="color: #8D8D84;">;;       </span><span style="color: #8D8D84; font-style: italic;">"columnNameLat" "c2",</span>
<span style="color: #8D8D84;">;;       </span><span style="color: #8D8D84; font-style: italic;">"columnNameLong" "c3",</span>
<span style="color: #8D8D84;">;;       </span><span style="color: #8D8D84; font-style: italic;">"columnTitleGeo" "asdasd"},</span>
<span style="color: #8D8D84;">;;      </span><span style="color: #8D8D84; font-style: italic;">"onError" "fail",</span>
<span style="color: #8D8D84;">;;      </span><span style="color: #8D8D84; font-style: italic;">"op" "core/generate-geopoints"},</span>
<span style="color: #8D8D84;">;;     </span><span style="color: #8D8D84; font-style: italic;">:type :transformation}</span>



<span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">core/combine</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">def</span> <span style="color: #BA36A5;">b</span> <span style="color: #7388D6;">{</span><span style="color: #D0372D;">:transformation</span>
        <span style="color: #909183;">{</span><span style="color: #D0372D;">:args</span>
         <span style="color: #709870;">{</span><span style="color: #D0372D;">:columnNames</span> <span style="color: #907373;">[</span><span style="color: #008000;">"c1"</span> <span style="color: #008000;">"c1"</span><span style="color: #907373;">]</span>, <span style="color: #D0372D;">:newColumnTitle</span> <span style="color: #008000;">"yupie"</span>, <span style="color: #D0372D;">:separator</span> <span style="color: #008000;">","</span><span style="color: #709870;">}</span>,
         <span style="color: #D0372D;">:onError</span> <span style="color: #008000;">"fail"</span>,
         <span style="color: #D0372D;">:op</span> <span style="color: #008000;">"core/combine"</span><span style="color: #909183;">}</span>,
        <span style="color: #D0372D;">:type</span> <span style="color: #D0372D;">:transformation</span><span style="color: #7388D6;">}</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span>c* <span style="color: #D0372D;">::</span><span style="color: #6434A3;">transformation</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">command</span> b<span style="color: #707183;">)</span>
<span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">=&gt; {:transformation</span>
<span style="color: #8D8D84;">;;     </span><span style="color: #8D8D84; font-style: italic;">{"args"</span>
<span style="color: #8D8D84;">;;      </span><span style="color: #8D8D84; font-style: italic;">{"columnNames" ["c1" "c1"],</span>
<span style="color: #8D8D84;">;;       </span><span style="color: #8D8D84; font-style: italic;">"newColumnTitle" "yupie",</span>
<span style="color: #8D8D84;">;;       </span><span style="color: #8D8D84; font-style: italic;">"separator" ","},</span>
<span style="color: #8D8D84;">;;      </span><span style="color: #8D8D84; font-style: italic;">"onError" "fail",</span>
<span style="color: #8D8D84;">;;      </span><span style="color: #8D8D84; font-style: italic;">"op" "core/combine"},</span>
<span style="color: #8D8D84;">;;     </span><span style="color: #8D8D84; font-style: italic;">:type :transformation}</span>
</pre>
</div>

<pre class="example">
#namespace[my.data.transformation]nil#'my.data.transformation/d*#'my.data.transformation/c*#'my.data.transformation/a{:transformation {"args" {"ColumnTitleGeo" "", "columnNameLat" "c2", "columnNameLong" "c3", "columnTitleGeo" "asdasd"}, "onError" "fail", "op" "core/generate-geopoints"}, :type :transformation}

</pre>
</div>
</li>
</ol>
</div>


<div id="outline-container-org8f8ff2e" class="outline-4">
<h4 id="org8f8ff2e"><span class="section-number-4">1.3.8</span> db</h4>
<div class="outline-text-4" id="text-1-3-8">
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #0000FF;">select</span> * <span style="color: #0000FF;">from</span> dashboard
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">id</td>
<td class="org-left">title</td>
<td class="org-left">spec</td>
<td class="org-left">created</td>
<td class="org-left">modified</td>
</tr>
</tbody>
</table>
</div>


<ol class="org-ol">
<li><a id="org461583d"></a>dashboard table<br />
<div class="outline-text-5" id="text-1-3-8-1">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Table "public.dashboard"</th>
<th scope="col" class="org-left">&#xa0;</th>
<th scope="col" class="org-left">&#xa0;</th>
<th scope="col" class="org-left">&#xa0;</th>
<th scope="col" class="org-left">&#xa0;</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Column</td>
<td class="org-left">Type</td>
<td class="org-left">Collation</td>
<td class="org-left">Nullable</td>
<td class="org-left">Default</td>
</tr>

<tr>
<td class="org-left">id</td>
<td class="org-left">text</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">not null</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">title</td>
<td class="org-left">text</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">not null</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">spec</td>
<td class="org-left">jsonb</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">created</td>
<td class="org-left">timestamp with time zone</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">not null</td>
<td class="org-left">now()</td>
</tr>

<tr>
<td class="org-left">modified</td>
<td class="org-left">timestamp with time zone</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">not null</td>
<td class="org-left">now()</td>
</tr>
</tbody>
</table>
</div>
</li>


<li><a id="org18e86aa"></a>visualisation table<br />
<div class="outline-text-5" id="text-1-3-8-2">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Table "public.visualisation"</th>
<th scope="col" class="org-left">&#xa0;</th>
<th scope="col" class="org-left">&#xa0;</th>
<th scope="col" class="org-left">&#xa0;</th>
<th scope="col" class="org-left">&#xa0;</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Column</td>
<td class="org-left">Type</td>
<td class="org-left">Collation</td>
<td class="org-left">Nullable</td>
<td class="org-left">Default</td>
</tr>

<tr>
<td class="org-left">id</td>
<td class="org-left">text</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">not null</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">dataset<sub>id</sub></td>
<td class="org-left">text</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">name</td>
<td class="org-left">text</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">not null</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">type</td>
<td class="org-left">text</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">not null</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">spec</td>
<td class="org-left">jsonb</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">not null</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">author</td>
<td class="org-left">jsonb</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">created</td>
<td class="org-left">timestamp with time zone</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">now()</td>
</tr>

<tr>
<td class="org-left">modified</td>
<td class="org-left">timestamp with time zone</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">now()</td>
</tr>
</tbody>
</table>




<div class="org-src-container">
<pre class="src src-elisp">cider-eval-last-sexp-and-replace        
</pre>
</div>
</div>
</li>
</ol>
</div>


<div id="outline-container-orgc68928f" class="outline-4">
<h4 id="orgc68928f"><span class="section-number-4">1.3.9</span> <span class="todo TODO">TODO</span> keep working with libs/maps</h4>
<div class="outline-text-4" id="text-1-3-9">
<p>
where layers are spec=&gt; layers
<a href="file:///Users/tangrammer/git/akvo/akvo-lumen/backend/src/akvo/lumen/endpoint/visualisation.clj#MissingReference">/Users/tangrammer/git/akvo/akvo-lumen/backend/src/akvo/lumen/endpoint/visualisation.clj::21</a>
</p>
</div>
</div>
</div>
<div id="outline-container-org4902016" class="outline-3">
<h3 id="org4902016"><span class="section-number-3">1.4</span> components&#xa0;&#xa0;&#xa0;<span class="tag"><span class="components">components</span></span></h3>
<div class="outline-text-3" id="text-1-4">
<p>
Lumen is a Component Oriented System, it uses <a href="https://github.com/duct-framework/duct">duct framework</a> that follows <a href="https://github.com/stuartsierra/component">component</a> library patterns
Main idea behind component is <code>Managed lifecycle of stateful objects in Clojure</code> (IoC or DI)
</p>
</div>

<div id="outline-container-org003ae84" class="outline-4">
<h4 id="org003ae84"><span class="section-number-4">1.4.1</span> specs.components</h4>
<div class="outline-text-4" id="text-1-4-1">
<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #707183;">(</span><span style="color: #0000FF;">ns</span> <span style="color: #6434A3;">akvo.lumen.specs.components</span>
  <span style="color: #7388D6;">(</span><span style="color: #D0372D;">:require</span> <span style="color: #909183;">[</span>clojure.spec.alpha <span style="color: #D0372D;">:as</span> s<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>akvo.lumen.specs.core <span style="color: #D0372D;">:as</span> lumen.s<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>akvo.lumen.specs.config <span style="color: #D0372D;">:as</span> config.s<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>akvo.lumen.component.tenant-manager <span style="color: #D0372D;">:as</span> tenant-manager<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>akvo.lumen.specs.db <span style="color: #D0372D;">:as</span> db.s<span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::tenant-manager</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/keys <span style="color: #D0372D;">:req-un</span> <span style="color: #909183;">[</span><span style="color: #D0372D;">::</span><span style="color: #6434A3;">db.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">db</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">config.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">config</span><span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::tenant-label</span> string?<span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/fdef <span style="color: #6434A3;">tenant-manager</span>/connection
  <span style="color: #D0372D;">:args</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/cat <span style="color: #D0372D;">:this</span> <span style="color: #D0372D;">::tenant-manager</span>  <span style="color: #D0372D;">:label</span> <span style="color: #D0372D;">::tenant-label</span><span style="color: #7388D6;">)</span>
  <span style="color: #D0372D;">:ret</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">db.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">spec</span><span style="color: #707183;">)</span>




</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org4d9020c" class="outline-3">
<h3 id="org4d9020c"><span class="section-number-3">1.5</span> config&#xa0;&#xa0;&#xa0;<span class="tag"><span class="config">config</span></span></h3>
<div class="outline-text-3" id="text-1-5">
<p>
Configuration of lumen backend is done through <a href="https://github.com/akvo/akvo-lumen/blob/specs-lp/backend/resources/akvo/lumen/system.edn#L1">system.edn</a>
</p>
</div>

<div id="outline-container-orgefa7fe8" class="outline-4">
<h4 id="orgefa7fe8"><span class="section-number-4">1.5.1</span> specs.config</h4>
<div class="outline-text-4" id="text-1-5-1">
<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #707183;">(</span><span style="color: #0000FF;">ns</span> <span style="color: #6434A3;">akvo.lumen.specs.config</span>
      <span style="color: #7388D6;">(</span><span style="color: #D0372D;">:require</span> <span style="color: #909183;">[</span>clojure.spec.alpha <span style="color: #D0372D;">:as</span> s<span style="color: #909183;">]</span>
                <span style="color: #909183;">[</span>akvo.lumen.specs.core <span style="color: #D0372D;">:as</span> lumen.s<span style="color: #909183;">]</span>
                <span style="color: #909183;">[</span>akvo.lumen.specs.db <span style="color: #D0372D;">:as</span> db.s<span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
   <span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::db-uri</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">db.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">uri</span><span style="color: #707183;">)</span>

   <span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::db</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/keys <span style="color: #D0372D;">:req-un</span> <span style="color: #909183;">[</span><span style="color: #D0372D;">::db-uri</span><span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

   <span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::config</span>
     <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/keys <span style="color: #D0372D;">:req-un</span> <span style="color: #909183;">[</span><span style="color: #D0372D;">::db</span><span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

</pre>
</div>


<p>
<b>conforming specs</b>&#x2026;
</p>

<div class="org-src-container">
<pre class="src src-clojure">
<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/conform <span style="color: #D0372D;">::config</span> <span style="color: #7388D6;">{</span><span style="color: #D0372D;">:db</span> <span style="color: #909183;">{</span><span style="color: #D0372D;">:db-uri</span> <span style="color: #008000;">"jdbc:postgresql://postgres/lumen?user=lumen&amp;password=password"</span><span style="color: #909183;">}</span><span style="color: #7388D6;">}</span><span style="color: #707183;">)</span>

</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">:db</td>
<td class="org-left">(:db-uri jdbc:postgresql://postgres/lumen?user=lumen&amp;password=password)</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div id="outline-container-orgdaac2a9" class="outline-3">
<h3 id="orgdaac2a9"><span class="section-number-3">1.6</span> db&#xa0;&#xa0;&#xa0;<span class="tag"><span class="db">db</span></span></h3>
<div class="outline-text-3" id="text-1-6">
</div>

<div id="outline-container-org7e55d00" class="outline-4">
<h4 id="org7e55d00"><span class="section-number-4">1.6.1</span> specs.db</h4>
<div class="outline-text-4" id="text-1-6-1">
<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #707183;">(</span><span style="color: #0000FF;">ns</span> <span style="color: #6434A3;">akvo.lumen.specs.db</span>
  <span style="color: #7388D6;">(</span><span style="color: #D0372D;">:require</span> <span style="color: #909183;">[</span>clojure.spec.alpha <span style="color: #D0372D;">:as</span> s<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>akvo.lumen.specs.core <span style="color: #D0372D;">:as</span> lumen.s<span style="color: #909183;">]</span><span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #D0372D;">:import</span> com.zaxxer.hikari.HikariDataSource<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::uri</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/with-gen string?
               #<span style="color: #909183;">(</span><span style="color: #6434A3;">s</span>/gen #<span style="color: #709870;">{</span><span style="color: #008000;">"jdbc:postgresql://postgres/lumen?user=lumen&amp;password=password&amp;ssl=true"</span><span style="color: #709870;">}</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::datasource</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/with-gen <span style="color: #909183;">(</span>partial instance? HikariDataSource<span style="color: #909183;">)</span>
                      #<span style="color: #909183;">(</span><span style="color: #6434A3;">s</span>/gen #<span style="color: #709870;">{</span><span style="color: #907373;">(</span>HikariDataSource.<span style="color: #907373;">)</span><span style="color: #709870;">}</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::spec</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/keys <span style="color: #D0372D;">:req-un</span> <span style="color: #909183;">[</span><span style="color: #D0372D;">::datasource</span><span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::db</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/keys <span style="color: #D0372D;">:req-un</span> <span style="color: #909183;">[</span><span style="color: #D0372D;">::datasource</span><span style="color: #909183;">]</span>
                    <span style="color: #D0372D;">:opt-un</span> <span style="color: #909183;">[</span><span style="color: #D0372D;">::uri</span><span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::tenant-connection</span> <span style="color: #D0372D;">::spec</span><span style="color: #707183;">)</span>


</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orged87778" class="outline-3">
<h3 id="orged87778"><span class="section-number-3">1.7</span> endpoints&#xa0;&#xa0;&#xa0;<span class="tag"><span class="endpoints">endpoints</span></span></h3>
<div class="outline-text-3" id="text-1-7">
</div>

<div id="outline-container-orgc26f5ce" class="outline-4">
<h4 id="orgc26f5ce"><span class="section-number-4">1.7.1</span> specs.endpoints</h4>
<div class="outline-text-4" id="text-1-7-1">
<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #707183;">(</span><span style="color: #0000FF;">ns</span> <span style="color: #6434A3;">akvo.lumen.specs.endpoints</span>
  <span style="color: #7388D6;">(</span><span style="color: #D0372D;">:require</span> <span style="color: #909183;">[</span>clojure.spec.alpha <span style="color: #D0372D;">:as</span> s<span style="color: #909183;">]</span>

            <span style="color: #909183;">[</span>akvo.lumen.specs.core <span style="color: #D0372D;">:as</span> lumen.s<span style="color: #909183;">]</span>

            <span style="color: #909183;">[</span>akvo.lumen.specs.config <span style="color: #D0372D;">:as</span> config.s<span style="color: #909183;">]</span>

            <span style="color: #909183;">[</span>akvo.lumen.component.tenant-manager <span style="color: #D0372D;">:as</span> tenant-manager<span style="color: #909183;">]</span>

            <span style="color: #909183;">[</span>akvo.lumen.endpoint.collection <span style="color: #D0372D;">:as</span> collection<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>akvo.lumen.endpoint.dashboard <span style="color: #D0372D;">:as</span> dashboard<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>akvo.lumen.endpoint.dataset <span style="color: #D0372D;">:as</span> dataset<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>akvo.lumen.endpoint.env <span style="color: #D0372D;">:as</span> env<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>akvo.lumen.endpoint.files <span style="color: #D0372D;">:as</span> files<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>akvo.lumen.endpoint.healthz <span style="color: #D0372D;">:as</span> healthz<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>akvo.lumen.endpoint.invite <span style="color: #D0372D;">:as</span> invite<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>akvo.lumen.endpoint.job-execution <span style="color: #D0372D;">:as</span> job-execution<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>akvo.lumen.endpoint.library <span style="color: #D0372D;">:as</span> library<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>akvo.lumen.endpoint.public <span style="color: #D0372D;">:as</span> public<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>akvo.lumen.endpoint.raster <span style="color: #D0372D;">:as</span> raster<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>akvo.lumen.endpoint.resource <span style="color: #D0372D;">:as</span> resource<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>akvo.lumen.endpoint.root <span style="color: #D0372D;">:as</span> root<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>akvo.lumen.endpoint.share <span style="color: #D0372D;">:as</span> share<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>akvo.lumen.endpoint.tier <span style="color: #D0372D;">:as</span> tier<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>akvo.lumen.endpoint.transformation <span style="color: #D0372D;">:as</span> transformation<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>akvo.lumen.endpoint.user <span style="color: #D0372D;">:as</span> user<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>akvo.lumen.endpoint.visualisation <span style="color: #D0372D;">:as</span> visualisation<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>akvo.lumen.endpoint <span style="color: #D0372D;">:as</span> endpoint<span style="color: #909183;">]</span>
            <span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/fdef <span style="color: #6434A3;">collection</span>/endpoint
  <span style="color: #D0372D;">:args</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/keys <span style="color: #D0372D;">:req-un</span> <span style="color: #909183;">[</span><span style="color: #D0372D;">::</span><span style="color: #6434A3;">tenant-manager</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">tenant-manager</span><span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/fdef <span style="color: #6434A3;">dashboard</span>/endpoint
  <span style="color: #D0372D;">:args</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/keys <span style="color: #D0372D;">:req-un</span> <span style="color: #909183;">[</span><span style="color: #D0372D;">::</span><span style="color: #6434A3;">tenant-manager</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">tenant-manager</span><span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #8D8D84;">;;</span><span style="color: #8D8D84; font-style: italic;">          [akvo.lumen.endpoint.dataset :as dataset] ;; [config error-tracker tenant-manager]</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/fdef <span style="color: #6434A3;">env</span>/endpoint
  <span style="color: #D0372D;">:args</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/keys <span style="color: #D0372D;">:req-un</span> <span style="color: #909183;">[</span><span style="color: #D0372D;">::</span><span style="color: #6434A3;">config.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">config</span><span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #8D8D84;">;;</span><span style="color: #8D8D84; font-style: italic;">          [akvo.lumen.endpoint.files :as files] {{:keys [file-upload-path max-upload-size]} :config}</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/fdef <span style="color: #6434A3;">healthz</span>/endpoint
  <span style="color: #D0372D;">:args</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/keys <span style="color: #D0372D;">:req-un</span> <span style="color: #909183;">[</span><span style="color: #D0372D;">::</span><span style="color: #6434A3;">lumen.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">any</span><span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">(s/fdef invite/endpoint ;; [config emailer keycloak tenant-manager]</span>
<span style="color: #8D8D84;">;;   </span><span style="color: #8D8D84; font-style: italic;">:args (s/keys :req-un [::lumen.s/any]))</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/fdef <span style="color: #6434A3;">job-execution</span>/endpoint
  <span style="color: #D0372D;">:args</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/keys <span style="color: #D0372D;">:req-un</span> <span style="color: #909183;">[</span><span style="color: #D0372D;">::</span><span style="color: #6434A3;">tenant-manager</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">tenant-manager</span><span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/fdef <span style="color: #6434A3;">library</span>/endpoint
  <span style="color: #D0372D;">:args</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/keys <span style="color: #D0372D;">:req-un</span> <span style="color: #909183;">[</span><span style="color: #D0372D;">::</span><span style="color: #6434A3;">tenant-manager</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">tenant-manager</span><span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/fdef <span style="color: #6434A3;">public</span>/endpoint
  <span style="color: #D0372D;">:args</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/keys <span style="color: #D0372D;">:req-un</span> <span style="color: #909183;">[</span><span style="color: #D0372D;">::</span><span style="color: #6434A3;">tenant-manager</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">tenant-manager</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">config.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">config</span><span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/fdef <span style="color: #6434A3;">raster</span>/endpoint
  <span style="color: #D0372D;">:args</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/keys <span style="color: #D0372D;">:req-un</span> <span style="color: #909183;">[</span><span style="color: #D0372D;">::</span><span style="color: #6434A3;">tenant-manager</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">tenant-manager</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">config.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">config</span><span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/fdef <span style="color: #6434A3;">resource</span>/endpoint
  <span style="color: #D0372D;">:args</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/keys <span style="color: #D0372D;">:req-un</span> <span style="color: #909183;">[</span><span style="color: #D0372D;">::</span><span style="color: #6434A3;">tenant-manager</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">tenant-manager</span><span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/fdef <span style="color: #6434A3;">root</span>/endpoint
  <span style="color: #D0372D;">:args</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/keys <span style="color: #D0372D;">:req-un</span> <span style="color: #909183;">[</span><span style="color: #D0372D;">::</span><span style="color: #6434A3;">config.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">config</span><span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/fdef <span style="color: #6434A3;">share</span>/endpoint
  <span style="color: #D0372D;">:args</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/keys <span style="color: #D0372D;">:req-un</span> <span style="color: #909183;">[</span><span style="color: #D0372D;">::</span><span style="color: #6434A3;">tenant-manager</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">tenant-manager</span><span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/fdef <span style="color: #6434A3;">tier</span>/endpoint
  <span style="color: #D0372D;">:args</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/keys <span style="color: #D0372D;">:req-un</span> <span style="color: #909183;">[</span><span style="color: #D0372D;">::</span><span style="color: #6434A3;">tenant-manager</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">tenant-manager</span><span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/fdef <span style="color: #6434A3;">transformation</span>/endpoint
  <span style="color: #D0372D;">:args</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/keys <span style="color: #D0372D;">:req-un</span> <span style="color: #909183;">[</span><span style="color: #D0372D;">::</span><span style="color: #6434A3;">tenant-manager</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">tenant-manager</span><span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>


<span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">(s/fdef user/endpoint ;; keycloak</span>
<span style="color: #8D8D84;">;;   </span><span style="color: #8D8D84; font-style: italic;">:args (s/keys :req-un [::tenant-manager/tenant-manager]))</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/fdef <span style="color: #6434A3;">visualisation</span>/endpoint
  <span style="color: #D0372D;">:args</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/keys <span style="color: #D0372D;">:req-un</span> <span style="color: #909183;">[</span><span style="color: #D0372D;">::</span><span style="color: #6434A3;">tenant-manager</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">tenant-manager</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">config.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">config</span><span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org48dc5e2" class="outline-3">
<h3 id="org48dc5e2"><span class="section-number-3">1.8</span> imports&#xa0;&#xa0;&#xa0;<span class="tag"><span class="imports">imports</span></span></h3>
<div class="outline-text-3" id="text-1-8">
</div>

<div id="outline-container-org9d1c492" class="outline-4">
<h4 id="org9d1c492"><span class="section-number-4">1.8.1</span> specs.imports</h4>
<div class="outline-text-4" id="text-1-8-1">
<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #707183;">(</span><span style="color: #0000FF;">ns</span> <span style="color: #6434A3;">akvo.lumen.specs.imports</span>
      <span style="color: #7388D6;">(</span><span style="color: #D0372D;">:require</span> <span style="color: #909183;">[</span>clojure.spec.alpha <span style="color: #D0372D;">:as</span> s<span style="color: #909183;">]</span>
                <span style="color: #909183;">[</span>akvo.lumen.specs.core <span style="color: #D0372D;">:as</span> lumen.s<span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>
</div>

<ol class="org-ol">
<li><a id="org14cae70"></a>flow-common<br />
<div class="outline-text-5" id="text-1-8-1-1">
<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #707183;">(</span>require '<span style="color: #7388D6;">[</span>akvo.lumen.import.flow-common <span style="color: #D0372D;">:as</span> flow-common<span style="color: #7388D6;">]</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">defn</span> <span style="color: #006699;">parse-int</span> <span style="color: #7388D6;">[</span>s<span style="color: #7388D6;">]</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">try</span>
    <span style="color: #909183;">(</span>Integer. s<span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #0000FF;">catch</span> Exception e <span style="color: #D0372D;">nil</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">def</span> <span style="color: #BA36A5;">flow-id-data</span> <span style="color: #7388D6;">(</span>set <span style="color: #909183;">(</span>repeatedly 100 <span style="color: #709870;">(</span><span style="color: #0000FF;">fn</span> <span style="color: #907373;">[]</span> <span style="color: #907373;">(</span>apply str <span style="color: #6276BA;">(</span>repeatedly 9 #<span style="color: #858580;">(</span>rand-int 9<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::flow-common/flow-id</span>
  <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/with-gen
    <span style="color: #909183;">(</span><span style="color: #6434A3;">s</span>/and string? <span style="color: #709870;">(</span><span style="color: #0000FF;">fn</span> <span style="color: #907373;">[</span>s<span style="color: #907373;">]</span> <span style="color: #907373;">(</span><span style="color: #0000FF;">and</span> <span style="color: #6276BA;">(</span>= <span style="color: #858580;">(</span>count s<span style="color: #858580;">)</span> 9<span style="color: #6276BA;">)</span>
                                <span style="color: #6276BA;">(</span>parse-int s<span style="color: #6276BA;">)</span>
                                <span style="color: #6276BA;">(</span>&lt;= 0 <span style="color: #858580;">(</span>parse-int s<span style="color: #858580;">)</span> 999999999<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    #<span style="color: #909183;">(</span><span style="color: #6434A3;">s</span>/gen flow-id-data<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #8D8D84;">;;     </span><span style="color: #8D8D84; font-style: italic;">(s/exercise ::flow-id)</span>


<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::flow-common/question-group-id</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">flow-common</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">flow-id</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::flow-common/question-id</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">flow-common</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">flow-id</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::flow-common/responses</span>
  <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/map-of <span style="color: #D0372D;">::</span><span style="color: #6434A3;">flow-common</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">question-group-id</span> <span style="color: #909183;">(</span><span style="color: #6434A3;">s</span>/coll-of
                                             <span style="color: #709870;">(</span><span style="color: #6434A3;">s</span>/map-of <span style="color: #D0372D;">::</span><span style="color: #6434A3;">flow-common</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">question-id</span>
                                                       <span style="color: #D0372D;">::</span><span style="color: #6434A3;">lumen.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">any</span>
                                                       <span style="color: #D0372D;">:gen-max</span> 3<span style="color: #709870;">)</span> <span style="color: #D0372D;">:gen-max</span> 3<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>



<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/fdef <span style="color: #6434A3;">flow-common</span>/question-responses
  <span style="color: #D0372D;">:args</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/keys <span style="color: #D0372D;">:req</span> <span style="color: #909183;">[</span><span style="color: #D0372D;">::</span><span style="color: #6434A3;">flow-common</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">responses</span><span style="color: #909183;">]</span><span style="color: #7388D6;">)</span>
  <span style="color: #D0372D;">:ret</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/map-of <span style="color: #D0372D;">::</span><span style="color: #6434A3;">flow-common</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">question-id</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">lumen.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">any</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>


</pre>
</div>
</div>


<ol class="org-ol">
<li><a id="orge35268f"></a>example/exercise data<br />
<div class="outline-text-7" id="text-1-8-1-1-0-1">
<p>
<a href="https://clojure.org/guides/spec#_custom_generators">https://clojure.org/guides/spec#_custom_generators</a>
</p>
<div class="org-src-container">
<pre class="src src-clojure">
<span style="color: #707183;">(</span>ffirst <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/exercise <span style="color: #D0372D;">::</span><span style="color: #6434A3;">flow-common</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">responses</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span> 

</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-left" />

<col  class="org-right" />

<col  class="org-left" />

<col  class="org-right" />

<col  class="org-left" />

<col  class="org-right" />

<col  class="org-left" />

<col  class="org-right" />

<col  class="org-left" />

<col  class="org-right" />

<col  class="org-left" />

<col  class="org-right" />

<col  class="org-left" />

<col  class="org-right" />

<col  class="org-left" />

<col  class="org-right" />

<col  class="org-left" />

<col  class="org-right" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-right">261334557</td>
<td class="org-left">((028463255 nil 146283337 nil) nil)</td>
<td class="org-right">018511368</td>
<td class="org-left">nil</td>
<td class="org-right">400668080</td>
<td class="org-left">nil</td>
<td class="org-right">318375370</td>
<td class="org-left">nil</td>
<td class="org-right">106732608</td>
<td class="org-left">((110756161 nil))</td>
<td class="org-right">137080300</td>
<td class="org-left">nil</td>
<td class="org-right">351805035</td>
<td class="org-left">nil</td>
<td class="org-right">164387401</td>
<td class="org-left">((155032558 nil 088610352 nil) (087865741 nil 788663082 nil 088610352 nil) (068062771 nil))</td>
<td class="org-right">788663082</td>
<td class="org-left">((080747160 nil 015263766 nil 584841168 nil))</td>
<td class="org-right">338337786</td>
<td class="org-left">((006161615 nil 248722763 nil 011522633 nil) (147714708 nil 166057126 nil 217246440 nil) (150220158 nil 763725617 nil 261334557 nil))</td>
</tr>
</tbody>
</table>


<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/valid? <span style="color: #D0372D;">::</span><span style="color: #6434A3;">flow-common</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">responses</span> <span style="color: #7388D6;">{</span> <span style="color: #008000;">"665994009"</span> <span style="color: #909183;">[</span><span style="color: #709870;">{</span><span style="color: #008000;">"665994009"</span> <span style="color: #008000;">"3"</span><span style="color: #709870;">}</span><span style="color: #909183;">]</span><span style="color: #7388D6;">}</span><span style="color: #707183;">)</span>
</pre>
</div>

<pre class="example">
true

</pre>
</div>
</li>
</ol>
</li>
</ol>
</div>
</div>
<div id="outline-container-org8cfdae5" class="outline-3">
<h3 id="org8cfdae5"><span class="section-number-3">1.9</span> libs&#xa0;&#xa0;&#xa0;<span class="tag"><span class="libs">libs</span></span></h3>
<div class="outline-text-3" id="text-1-9">
</div>

<div id="outline-container-org7b51de6" class="outline-4">
<h4 id="org7b51de6"><span class="section-number-4">1.9.1</span> specs.libs</h4>
<div class="outline-text-4" id="text-1-9-1">
<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #707183;">(</span><span style="color: #0000FF;">ns</span> <span style="color: #6434A3;">akvo.lumen.specs.libs</span>
  <span style="color: #7388D6;">(</span><span style="color: #D0372D;">:require</span> <span style="color: #909183;">[</span>clojure.spec.alpha <span style="color: #D0372D;">:as</span> s<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>akvo.lumen.lib <span style="color: #D0372D;">:as</span> lib<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>akvo.lumen.specs.core <span style="color: #D0372D;">:as</span> lumen.s<span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::lib/val</span> #<span style="color: #7388D6;">{</span><span style="color: #D0372D;">::</span><span style="color: #6434A3;">lib</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">created</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">lib</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">not-implemented</span>
                   <span style="color: #D0372D;">::</span><span style="color: #6434A3;">lib</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">no-content</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">lib</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">unprocessable-entity</span>
                   <span style="color: #D0372D;">::</span><span style="color: #6434A3;">lib</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">redirect</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">lib</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">internal-server-error</span>
                   <span style="color: #D0372D;">::</span><span style="color: #6434A3;">lib</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">not-authenticated</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">lib</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">ok</span>
                   <span style="color: #D0372D;">::</span><span style="color: #6434A3;">lib</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">bad-request</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">lib</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">gone</span>
                   <span style="color: #D0372D;">::</span><span style="color: #6434A3;">lib</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">not-authorized</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">lib</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">conflict</span>
                   <span style="color: #D0372D;">::</span><span style="color: #6434A3;">lib</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">not-found</span><span style="color: #7388D6;">}</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::lib/response</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/tuple <span style="color: #D0372D;">::val</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">lumen.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">any</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org0cffe99" class="outline-3">
<h3 id="org0cffe99"><span class="section-number-3">1.10</span> transformations&#xa0;&#xa0;&#xa0;<span class="tag"><span class="transformations">transformations</span></span></h3>
<div class="outline-text-3" id="text-1-10">
</div>


<div id="outline-container-org34333d9" class="outline-4">
<h4 id="org34333d9"><span class="section-number-4">1.10.1</span> <span class="done DONE">DONE</span> multimethod transformation/transformation</h4>
<div class="outline-text-4" id="text-1-10-1">
<p>
in relation to transformation/type <code>undo</code> OR <code>transformation</code>
</p>
</div>

<ol class="org-ol">
<li><a id="orgcbce17c"></a><span class="done DONE">DONE</span> then depending of ::transformation.engine/op we need to have a different ::transformation.engine/args<br />
<div class="outline-text-5" id="text-1-10-1-1">
</div>
</li>

<li><a id="org7d71d12"></a><span class="todo TODO">TODO</span> error-strategy could be specified<br />
<div class="outline-text-5" id="text-1-10-1-2">
<p>
<a href="file:///Users/tangrammer/git/akvo/akvo-lumen/backend/src/akvo/lumen/transformation/combine.clj#MissingReference">example-combine</a> <a href="file:///Users/tangrammer/git/akvo/akvo-lumen/backend/src/akvo/lumen/transformation/derive.clj#MissingReference">example-derive</a>
</p>
</div>
</li>
</ol>
</div>


<div id="outline-container-orgb69f096" class="outline-4">
<h4 id="orgb69f096"><span class="section-number-4">1.10.2</span> specs</h4>
<div class="outline-text-4" id="text-1-10-2">
</div>
<ol class="org-ol">
<li><a id="orga2c8c82"></a>akvo.lumen.specs.transformations.trim-doublespace<br />
<div class="outline-text-5" id="text-1-10-2-1">
<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #707183;">(</span><span style="color: #0000FF;">ns</span> <span style="color: #6434A3;">akvo.lumen.specs.transformations.trim-doublespace</span>
    <span style="color: #7388D6;">(</span><span style="color: #D0372D;">:require</span> <span style="color: #909183;">[</span>akvo.lumen.specs.dataset.column <span style="color: #D0372D;">:as</span> dataset.column.s<span style="color: #909183;">]</span>
              <span style="color: #909183;">[</span>clojure.spec.alpha <span style="color: #D0372D;">:as</span> s<span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::columnName</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">dataset.column.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">columnName</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::args</span>
  <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/keys <span style="color: #D0372D;">:req-un</span> <span style="color: #909183;">[</span><span style="color: #D0372D;">::columnName</span><span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>
</div>
</li>

<li><a id="org41a9889"></a>akvo.lumen.specs.transformations.to-titlecase<br />
<div class="outline-text-5" id="text-1-10-2-2">
<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #707183;">(</span><span style="color: #0000FF;">ns</span> <span style="color: #6434A3;">akvo.lumen.specs.transformations.to-titlecase</span>
    <span style="color: #7388D6;">(</span><span style="color: #D0372D;">:require</span> <span style="color: #909183;">[</span>akvo.lumen.specs.dataset.column <span style="color: #D0372D;">:as</span> dataset.column.s<span style="color: #909183;">]</span>
              <span style="color: #909183;">[</span>clojure.spec.alpha <span style="color: #D0372D;">:as</span> s<span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::columnName</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">dataset.column.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">columnName</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::args</span>
  <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/keys <span style="color: #D0372D;">:req-un</span> <span style="color: #909183;">[</span><span style="color: #D0372D;">::columnName</span><span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>
</div>
</li>

<li><a id="orge645e71"></a>akvo.lumen.specs.transformations.to-uppercase<br />
<div class="outline-text-5" id="text-1-10-2-3">
<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #707183;">(</span><span style="color: #0000FF;">ns</span> <span style="color: #6434A3;">akvo.lumen.specs.transformations.to-uppercase</span>
    <span style="color: #7388D6;">(</span><span style="color: #D0372D;">:require</span> <span style="color: #909183;">[</span>akvo.lumen.specs.dataset.column <span style="color: #D0372D;">:as</span> dataset.column.s<span style="color: #909183;">]</span>
              <span style="color: #909183;">[</span>clojure.spec.alpha <span style="color: #D0372D;">:as</span> s<span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::columnName</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">dataset.column.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">columnName</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::args</span>
  <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/keys <span style="color: #D0372D;">:req-un</span> <span style="color: #909183;">[</span><span style="color: #D0372D;">::columnName</span><span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>
</div>
</li>

<li><a id="org5684f30"></a>akvo.lumen.specs.transformations.to-lowercase<br />
<div class="outline-text-5" id="text-1-10-2-4">
<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #707183;">(</span><span style="color: #0000FF;">ns</span> <span style="color: #6434A3;">akvo.lumen.specs.transformations.to-lowercase</span>
    <span style="color: #7388D6;">(</span><span style="color: #D0372D;">:require</span> <span style="color: #909183;">[</span>akvo.lumen.specs.dataset.column <span style="color: #D0372D;">:as</span> dataset.column.s<span style="color: #909183;">]</span>
              <span style="color: #909183;">[</span>clojure.spec.alpha <span style="color: #D0372D;">:as</span> s<span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::columnName</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">dataset.column.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">columnName</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::args</span>
  <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/keys <span style="color: #D0372D;">:req-un</span> <span style="color: #909183;">[</span><span style="color: #D0372D;">::columnName</span><span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>
</div>
</li>

<li><a id="orgabdc528"></a>akvo.lumen.specs.transformations.trim<br />
<div class="outline-text-5" id="text-1-10-2-5">
<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #707183;">(</span><span style="color: #0000FF;">ns</span> <span style="color: #6434A3;">akvo.lumen.specs.transformations.trim</span>
    <span style="color: #7388D6;">(</span><span style="color: #D0372D;">:require</span> <span style="color: #909183;">[</span>akvo.lumen.specs.dataset.column <span style="color: #D0372D;">:as</span> dataset.column.s<span style="color: #909183;">]</span>
              <span style="color: #909183;">[</span>clojure.spec.alpha <span style="color: #D0372D;">:as</span> s<span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::columnName</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">dataset.column.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">columnName</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::args</span>
  <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/keys <span style="color: #D0372D;">:req-un</span> <span style="color: #909183;">[</span><span style="color: #D0372D;">::columnName</span><span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>
</div>
</li>

<li><a id="orgd10af20"></a>akvo.lumen.specs.transformations.remove-sort<br />
<div class="outline-text-5" id="text-1-10-2-6">
<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #707183;">(</span><span style="color: #0000FF;">ns</span> <span style="color: #6434A3;">akvo.lumen.specs.transformations.remove-sort</span>
    <span style="color: #7388D6;">(</span><span style="color: #D0372D;">:require</span> <span style="color: #909183;">[</span>akvo.lumen.specs.dataset.column <span style="color: #D0372D;">:as</span> dataset.column.s<span style="color: #909183;">]</span>
              <span style="color: #909183;">[</span>clojure.spec.alpha <span style="color: #D0372D;">:as</span> s<span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::columnName</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">dataset.column.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">columnName</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::args</span>
  <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/keys <span style="color: #D0372D;">:req-un</span> <span style="color: #909183;">[</span><span style="color: #D0372D;">::columnName</span><span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>
</div>
</li>

<li><a id="org902c5de"></a>akvo.lumen.specs.transformations.merge-dataset.source<br />
<div class="outline-text-5" id="text-1-10-2-7">
<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #707183;">(</span><span style="color: #0000FF;">ns</span> <span style="color: #6434A3;">akvo.lumen.specs.transformations.merge-dataset.source</span>
  <span style="color: #7388D6;">(</span><span style="color: #D0372D;">:require</span> <span style="color: #909183;">[</span>akvo.lumen.specs.dataset.column <span style="color: #D0372D;">:as</span> dataset.column.s<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>akvo.lumen.specs.core <span style="color: #D0372D;">:as</span> lumen.s<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>clojure.spec.alpha <span style="color: #D0372D;">:as</span> s<span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::mergeColumn</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">dataset.column.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">columnName</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::mergeColumns</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/coll-of <span style="color: #D0372D;">::mergeColumn</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::datasetId</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">lumen.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">str-uuid</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::aggregationColumn</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/or <span style="color: #D0372D;">:n</span> nil?
                                 <span style="color: #D0372D;">:v</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">dataset.column.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">columnName</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::aggregationDirection</span> #<span style="color: #7388D6;">{</span><span style="color: #008000;">"ASC"</span> <span style="color: #008000;">"DESC"</span><span style="color: #7388D6;">}</span><span style="color: #707183;">)</span>

</pre>
</div>
<p>
en/specs/transformations/merge<sub>dataset</sub>/source.clj
    (ns akvo.lumen.specs.transformations.merge-dataset.source
	(:require [akvo.lumen.specs.dataset.column :as dataset.column.s]
		  [clojure.spec.alpha :as s]))
</p>


<p>
#_(defmethod engine/valid? :core/merge-datasets
    [op-spec]
    (let [source (get-in op-spec [:args :source])
	  target (get-in op-spec [:args :target])]
      (and (engine/valid-column-name? (get source :mergeColumn))
	   (every? engine/valid-column-name? (get source :mergeColumns))
	   (engine/valid-dataset-id? (get source :datasetId))
	   (let [aggregation-column (get source :aggregationColumn)]
	     (or (nil? aggregation-column)
		 (engine/valid-column-name? aggregation-column)))
	   (#{"ASC" "DESC"} (get source :aggregationDirection))
	   (engine/valid-column-name? (get target :mergeColumn)))))
</p>



<p>
#+END<sub>SRC</sub>
</p>
</div>
</li>
<li><a id="orga8e77f2"></a>akvo.lumen.specs.transformations.merge-dataset.target<br />
<div class="outline-text-5" id="text-1-10-2-8">
<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #707183;">(</span><span style="color: #0000FF;">ns</span> <span style="color: #6434A3;">akvo.lumen.specs.transformations.merge-dataset.target</span>
  <span style="color: #7388D6;">(</span><span style="color: #D0372D;">:require</span> <span style="color: #909183;">[</span>akvo.lumen.specs.dataset.column <span style="color: #D0372D;">:as</span> dataset.column.s<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>clojure.spec.alpha <span style="color: #D0372D;">:as</span> s<span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::mergeColumn</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">dataset.column.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">columnName</span><span style="color: #707183;">)</span>


</pre>
</div>
</div>
</li>

<li><a id="orgb22c1a4"></a>akvo.lumen.specs.transformations<br />
<div class="outline-text-5" id="text-1-10-2-9">
<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #707183;">(</span><span style="color: #0000FF;">ns</span> <span style="color: #6434A3;">akvo.lumen.specs.transformations</span>
  <span style="color: #7388D6;">(</span><span style="color: #D0372D;">:require</span> <span style="color: #909183;">[</span>akvo.lumen.lib <span style="color: #D0372D;">:as</span> lib<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>akvo.lumen.lib.dataset <span style="color: #D0372D;">:as</span> lib.dataset<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>akvo.lumen.specs.core <span style="color: #D0372D;">:as</span> lumen.s<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>akvo.lumen.specs.dataset <span style="color: #D0372D;">:as</span> dataset.s<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>akvo.lumen.specs.dataset.column <span style="color: #D0372D;">:as</span> dataset.column.s<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>akvo.lumen.specs.transformations.remove-sort <span style="color: #D0372D;">:as</span> transformations.remove-sort.s<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>akvo.lumen.specs.transformations.trim <span style="color: #D0372D;">:as</span> transformations.trim.s<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>akvo.lumen.specs.transformations.to-lowercase <span style="color: #D0372D;">:as</span> transformations.to-lowercase.s<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>akvo.lumen.specs.transformations.to-uppercase <span style="color: #D0372D;">:as</span> transformations.to-uppercase.s<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>akvo.lumen.specs.transformations.to-titlecase <span style="color: #D0372D;">:as</span> transformations.to-titlecase.s<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>akvo.lumen.specs.transformations.trim-doublespace <span style="color: #D0372D;">:as</span> transformations.trim-doublespace.s<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>akvo.lumen.specs.transformations.merge-dataset.source <span style="color: #D0372D;">:as</span> t.merge-dataset.source.s<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>akvo.lumen.specs.transformations.merge-dataset.target <span style="color: #D0372D;">:as</span> t.merge-dataset.target.s<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>akvo.lumen.specs.db <span style="color: #D0372D;">:as</span> db.s<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>akvo.lumen.specs.libs<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>akvo.lumen.transformation <span style="color: #D0372D;">:as</span> transformation<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>akvo.lumen.transformation.derive <span style="color: #D0372D;">:as</span> transformation.derive<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>akvo.lumen.transformation.filter-column <span style="color: #D0372D;">:as</span> transformation.filter-column<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>akvo.lumen.transformation.engine <span style="color: #D0372D;">:as</span> transformation.engine<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>akvo.lumen.transformation.geo <span style="color: #D0372D;">:as</span> transformation.geo<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>akvo.lumen.transformation.derive.js-engine <span style="color: #D0372D;">:as</span> t.derive.js-engine<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>akvo.lumen.transformation.change-datatype <span style="color: #D0372D;">:as</span> transformation.change-datatype<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>akvo.lumen.transformation.combine <span style="color: #D0372D;">:as</span> transformation.combine<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>akvo.lumen.transformation.delete-column <span style="color: #D0372D;">:as</span> transformation.delete-column<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>akvo.lumen.transformation.merge-datasets <span style="color: #D0372D;">:as</span> transformation.merge-datasets<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>akvo.lumen.transformation.sort-column <span style="color: #D0372D;">:as</span> transformation.sort-column<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>akvo.lumen.transformation.rename-column <span style="color: #D0372D;">:as</span> transformation.rename-column<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>akvo.lumen.transformation.reverse-geocode <span style="color: #D0372D;">:as</span> transformation.reverse-geocode<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span>clojure.spec.alpha <span style="color: #D0372D;">:as</span> s<span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>


<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::transformation.engine/js-value-types</span> #<span style="color: #7388D6;">{</span><span style="color: #008000;">"number"</span> <span style="color: #008000;">"text"</span> <span style="color: #008000;">"date"</span><span style="color: #7388D6;">}</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::transformation.engine/onError</span> #<span style="color: #7388D6;">{</span><span style="color: #008000;">"leave-empty"</span> <span style="color: #008000;">"fail"</span> <span style="color: #008000;">"delete-row"</span> <span style="color: #008000;">"default-value"</span><span style="color: #7388D6;">}</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::transformation.engine/op</span> #<span style="color: #7388D6;">{</span><span style="color: #008000;">"core/change-datatype"</span>
                                    <span style="color: #008000;">"core/combine"</span>
                                    <span style="color: #008000;">"core/delete-column"</span>
                                    <span style="color: #008000;">"core/derive"</span>
                                    <span style="color: #008000;">"core/filter-column"</span>
                                    <span style="color: #008000;">"core/generate-geopoints"</span>
                                    <span style="color: #008000;">"core/merge-datasets"</span>
                                    <span style="color: #008000;">"core/remove-sort"</span>
                                    <span style="color: #008000;">"core/rename-column"</span>
                                    <span style="color: #008000;">"core/reverse-geocode"</span>
                                    <span style="color: #008000;">"core/sort-column"</span>
                                    <span style="color: #008000;">"core/to-lowercase"</span>
                                    <span style="color: #008000;">"core/to-titlecase"</span>
                                    <span style="color: #008000;">"core/to-uppercase"</span>
                                    <span style="color: #008000;">"core/trim"</span>
                                    <span style="color: #008000;">"core/trim-doublespace"</span><span style="color: #7388D6;">}</span><span style="color: #707183;">)</span>


<span style="color: #707183;">(</span><span style="color: #0000FF;">defmulti</span> <span style="color: #006699;">op-spec-type</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">transformation.engine</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">op</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::transformation.change-datatype/columnName</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">dataset.column.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">columnName</span> <span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::transformation.change-datatype/newType</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">dataset.column.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">type</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::transformation.change-datatype/parseFormat</span> string?<span style="color: #707183;">)</span> <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">TODO: review it</span>
<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::transformation.change-datatype/args</span>
  <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/keys <span style="color: #D0372D;">:req-un</span> <span style="color: #909183;">[</span><span style="color: #D0372D;">::</span><span style="color: #6434A3;">transformation.change-datatype</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">columnName</span>
                   <span style="color: #D0372D;">::</span><span style="color: #6434A3;">transformation.change-datatype</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">newType</span><span style="color: #909183;">]</span>
          <span style="color: #D0372D;">:opt-un</span> <span style="color: #909183;">[</span><span style="color: #D0372D;">::</span><span style="color: #6434A3;">transformation.change-datatype</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">parseFormat</span><span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">defmethod</span> <span style="color: #006699;">op-spec-type</span> <span style="color: #008000;">"core/change-datatype"</span>  <span style="color: #7388D6;">[</span>_<span style="color: #7388D6;">]</span>
  <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/keys
   <span style="color: #D0372D;">:req-un</span> <span style="color: #909183;">[</span><span style="color: #D0372D;">::</span><span style="color: #6434A3;">transformation.change-datatype</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">args</span>
            <span style="color: #D0372D;">::</span><span style="color: #6434A3;">transformation.engine</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">onError</span><span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::transformation.combine/columnNames</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/tuple <span style="color: #D0372D;">::</span><span style="color: #6434A3;">dataset.column.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">columnName</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">dataset.column.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">columnName</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::transformation.combine/newColumnTitle</span> string?<span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::transformation.combine/separator</span> string?<span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::transformation.combine/args</span>
  <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/keys <span style="color: #D0372D;">:req-un</span> <span style="color: #909183;">[</span><span style="color: #D0372D;">::</span><span style="color: #6434A3;">transformation.combine</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">columnNames</span>
                   <span style="color: #D0372D;">::</span><span style="color: #6434A3;">transformation.combine</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">newColumnTitle</span>
                   <span style="color: #D0372D;">::</span><span style="color: #6434A3;">transformation.combine</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">separator</span><span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">defmethod</span> <span style="color: #006699;">op-spec-type</span> <span style="color: #008000;">"core/combine"</span>  <span style="color: #7388D6;">[</span>_<span style="color: #7388D6;">]</span>
  <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/keys
   <span style="color: #D0372D;">:req-un</span> <span style="color: #909183;">[</span><span style="color: #D0372D;">::</span><span style="color: #6434A3;">transformation.combine</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">args</span>
            <span style="color: #D0372D;">::</span><span style="color: #6434A3;">transformation.engine</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">onError</span><span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::transformation.delete-column/columnName</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">dataset.column.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">columnName</span><span style="color: #707183;">)</span>


<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::transformation.delete-column/args</span>
  <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/keys <span style="color: #D0372D;">:req-un</span> <span style="color: #909183;">[</span><span style="color: #D0372D;">::</span><span style="color: #6434A3;">transformation.delete-column</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">columnName</span><span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">defmethod</span> <span style="color: #006699;">op-spec-type</span> <span style="color: #008000;">"core/delete-column"</span>  <span style="color: #7388D6;">[</span>_<span style="color: #7388D6;">]</span>
  <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/keys
   <span style="color: #D0372D;">:req-un</span> <span style="color: #909183;">[</span><span style="color: #D0372D;">::</span><span style="color: #6434A3;">transformation.delete-column</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">args</span>
            <span style="color: #D0372D;">::</span><span style="color: #6434A3;">transformation.engine</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">onError</span><span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>


<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::transformation.derive/code</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/with-gen
                                      <span style="color: #909183;">(</span><span style="color: #6434A3;">s</span>/and string? <span style="color: #6434A3;">t.derive.js-engine</span>/evaluable?<span style="color: #909183;">)</span>
                                      #<span style="color: #909183;">(</span><span style="color: #6434A3;">s</span>/gen #<span style="color: #709870;">{</span><span style="color: #008000;">"x=1"</span><span style="color: #709870;">}</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::transformation.derive/newColumnTitle</span> string?<span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::transformation.derive/newColumnType</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">dataset.column.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">type</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::transformation.derive/args</span>
  <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/keys <span style="color: #D0372D;">:req-un</span> <span style="color: #909183;">[</span><span style="color: #D0372D;">::</span><span style="color: #6434A3;">transformation.derive</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">code</span>
                   <span style="color: #D0372D;">::</span><span style="color: #6434A3;">transformation.derive</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">newColumnTitle</span>
                   <span style="color: #D0372D;">::</span><span style="color: #6434A3;">transformation.derive</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">newColumnType</span><span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">defmethod</span> <span style="color: #006699;">op-spec-type</span> <span style="color: #008000;">"core/derive"</span>  <span style="color: #7388D6;">[</span>_<span style="color: #7388D6;">]</span>
  <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/keys
   <span style="color: #D0372D;">:req-un</span> <span style="color: #909183;">[</span><span style="color: #D0372D;">::</span><span style="color: #6434A3;">transformation.derive</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">args</span>
            <span style="color: #D0372D;">::</span><span style="color: #6434A3;">transformation.engine</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">onError</span><span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::transformation.filter-column/is</span> string?<span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::transformation.filter-column/contains</span> string?<span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::transformation.filter-column/expression</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/keys <span style="color: #D0372D;">:opt-un</span> <span style="color: #909183;">[</span><span style="color: #D0372D;">::</span><span style="color: #6434A3;">transformation.filter-column</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">is</span>
                                                                  <span style="color: #D0372D;">::</span><span style="color: #6434A3;">transformation.filter-column</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">contains</span><span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::transformation.filter-column/columnName</span> string?<span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::transformation.filter-column/args</span>
  <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/keys <span style="color: #D0372D;">:req-un</span> <span style="color: #909183;">[</span><span style="color: #D0372D;">::</span><span style="color: #6434A3;">transformation.filter-column</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">expression</span>
                   <span style="color: #D0372D;">::</span><span style="color: #6434A3;">transformation.filter-column</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">columnName</span><span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">defmethod</span> <span style="color: #006699;">op-spec-type</span> <span style="color: #008000;">"core/filter-column"</span>  <span style="color: #7388D6;">[</span>_<span style="color: #7388D6;">]</span>
  <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/keys
   <span style="color: #D0372D;">:req-un</span> <span style="color: #909183;">[</span><span style="color: #D0372D;">::</span><span style="color: #6434A3;">transformation.filter-column</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">args</span>
            <span style="color: #D0372D;">::</span><span style="color: #6434A3;">transformation.engine</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">onError</span><span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::transformation.geo/columnNameLat</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">dataset.column.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">columnName</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::transformation.geo/columnNameLong</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">dataset.column.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">columnName</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::transformation.geo/columnTitleGeo</span> string?<span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::transformation.geo/ColumnTitleGeo</span> string?<span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::transformation.geo/args</span>
  <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/keys <span style="color: #D0372D;">:req-un</span> <span style="color: #909183;">[</span><span style="color: #D0372D;">::</span><span style="color: #6434A3;">transformation.geo</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">columnNameLat</span>
                   <span style="color: #D0372D;">::</span><span style="color: #6434A3;">transformation.geo</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">columnNameLong</span><span style="color: #909183;">]</span>
          <span style="color: #D0372D;">:opt-un</span> <span style="color: #909183;">[</span><span style="color: #D0372D;">::</span><span style="color: #6434A3;">transformation.geo</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">columnTitleGeo</span>
                   <span style="color: #D0372D;">::</span><span style="color: #6434A3;">transformation.geo</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">ColumnTitleGeo</span><span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">defmethod</span> <span style="color: #006699;">op-spec-type</span> <span style="color: #008000;">"core/generate-geopoints"</span>  <span style="color: #7388D6;">[</span>_<span style="color: #7388D6;">]</span>
  <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/keys
   <span style="color: #D0372D;">:req-un</span> <span style="color: #909183;">[</span><span style="color: #D0372D;">::</span><span style="color: #6434A3;">transformation.geo</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">args</span>
            <span style="color: #D0372D;">::</span><span style="color: #6434A3;">transformation.engine</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">onError</span><span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::transformation.merge-datasets/source</span>
  <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/keys <span style="color: #D0372D;">:req-un</span> <span style="color: #909183;">[</span><span style="color: #D0372D;">::</span><span style="color: #6434A3;">t.merge-dataset.source.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">mergeColumn</span> 
                   <span style="color: #D0372D;">::</span><span style="color: #6434A3;">t.merge-dataset.source.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">mergeColumns</span>
                   <span style="color: #D0372D;">::</span><span style="color: #6434A3;">t.merge-dataset.source.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">datasetId</span> 
                   <span style="color: #D0372D;">::</span><span style="color: #6434A3;">t.merge-dataset.source.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">aggregationColumn</span><span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::transformation.merge-datasets/target</span>
  <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/keys <span style="color: #D0372D;">:req-un</span> <span style="color: #909183;">[</span><span style="color: #D0372D;">::</span><span style="color: #6434A3;">t.merge-dataset.source.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">mergeColumn</span><span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::transformation.merge-datasets/args</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/keys <span style="color: #D0372D;">:req-un</span> <span style="color: #909183;">[</span><span style="color: #D0372D;">::</span><span style="color: #6434A3;">transformation.merge-datasets</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">source</span>
                                                             <span style="color: #D0372D;">::</span><span style="color: #6434A3;">transformation.merge-datasets</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">target</span><span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">defmethod</span> <span style="color: #006699;">op-spec-type</span> <span style="color: #008000;">"core/merge-datasets"</span>  <span style="color: #7388D6;">[</span>_<span style="color: #7388D6;">]</span>
  <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/keys
   <span style="color: #D0372D;">:req-un</span> <span style="color: #909183;">[</span><span style="color: #D0372D;">::</span><span style="color: #6434A3;">transformation.merge-datasets</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">args</span><span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::transformation.sort-column/columnName</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">dataset.column.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">columnName</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::transformation.sort-column/sortDirection</span> #<span style="color: #7388D6;">{</span><span style="color: #008000;">"ASC"</span> <span style="color: #008000;">"DESC"</span><span style="color: #7388D6;">}</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::transformation.sort-column/args</span>
  <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/keys <span style="color: #D0372D;">:req-un</span> <span style="color: #909183;">[</span><span style="color: #D0372D;">::</span><span style="color: #6434A3;">transformation.sort-column</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">columnName</span>
                   <span style="color: #D0372D;">::</span><span style="color: #6434A3;">transformation.sort-column</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">sortDirection</span><span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">defmethod</span> <span style="color: #006699;">op-spec-type</span> <span style="color: #008000;">"core/sort-column"</span>  <span style="color: #7388D6;">[</span>_<span style="color: #7388D6;">]</span>
  <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/keys
   <span style="color: #D0372D;">:req-un</span> <span style="color: #909183;">[</span><span style="color: #D0372D;">::</span><span style="color: #6434A3;">transformation.sort-column</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">args</span>
            <span style="color: #D0372D;">::</span><span style="color: #6434A3;">transformation.engine</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">onError</span><span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">defmethod</span> <span style="color: #006699;">op-spec-type</span> <span style="color: #008000;">"core/remove-sort"</span>  <span style="color: #7388D6;">[</span>_<span style="color: #7388D6;">]</span>
  <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/keys
   <span style="color: #D0372D;">:req-un</span> <span style="color: #909183;">[</span><span style="color: #D0372D;">::</span><span style="color: #6434A3;">transformations.remove-sort.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">args</span>
            <span style="color: #D0372D;">::</span><span style="color: #6434A3;">transformation.engine</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">onError</span><span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::transformation.rename-column/columnName</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">dataset.column.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">columnName</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::transformation.rename-column/newColumnTitle</span> string?<span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::transformation.rename-column/args</span>
  <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/keys <span style="color: #D0372D;">:req-un</span> <span style="color: #909183;">[</span><span style="color: #D0372D;">::</span><span style="color: #6434A3;">transformation.rename-column</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">columnName</span>
                   <span style="color: #D0372D;">::</span><span style="color: #6434A3;">transformation.rename-column</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">newColumnTitle</span><span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">defmethod</span> <span style="color: #006699;">op-spec-type</span> <span style="color: #008000;">"core/rename-column"</span> <span style="color: #7388D6;">[</span>_<span style="color: #7388D6;">]</span>
  <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/keys
   <span style="color: #D0372D;">:req-un</span> <span style="color: #909183;">[</span><span style="color: #D0372D;">::</span><span style="color: #6434A3;">transformation.rename-column</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">args</span>
            <span style="color: #D0372D;">::</span><span style="color: #6434A3;">transformation.engine</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">onError</span><span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::transformation.reverse-geocode/title</span> string?<span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::transformation.reverse-geocode/geopointColumn</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">dataset.column.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">columnName</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::transformation.reverse-geocode/target</span>
  <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/keys <span style="color: #D0372D;">:req-un</span> <span style="color: #909183;">[</span><span style="color: #D0372D;">::</span><span style="color: #6434A3;">transformation.reverse-geocode</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">title</span>
                   <span style="color: #D0372D;">::</span><span style="color: #6434A3;">transformation.reverse-geocode</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">geopointColumn</span><span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::transformation.reverse-geocode/datasetId</span> string?<span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::transformation.reverse-geocode/geoshapeColumn</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">dataset.column.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">columnName</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::transformation.reverse-geocode/mergeColumn</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">dataset.column.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">columnName</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::transformation.reverse-geocode/source</span>
  <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/keys <span style="color: #D0372D;">:req-un</span> <span style="color: #909183;">[</span><span style="color: #D0372D;">::</span><span style="color: #6434A3;">transformation.reverse-geocode</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">datasetId</span>
                   <span style="color: #D0372D;">::</span><span style="color: #6434A3;">transformation.reverse-geocode</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">geoshapeColumn</span>
                   <span style="color: #D0372D;">::</span><span style="color: #6434A3;">transformation.reverse-geocode</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">mergeColumn</span><span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::transformation.reverse-geocode/args</span>
  <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/keys <span style="color: #D0372D;">:req-un</span> <span style="color: #909183;">[</span><span style="color: #D0372D;">::</span><span style="color: #6434A3;">transformation.reverse-geocode</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">target</span>
                   <span style="color: #D0372D;">::</span><span style="color: #6434A3;">transformation.reverse-geocode</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">source</span><span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">defmethod</span> <span style="color: #006699;">op-spec-type</span> <span style="color: #008000;">"core/reverse-geocode"</span> <span style="color: #7388D6;">[</span>_<span style="color: #7388D6;">]</span>
  <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/keys
   <span style="color: #D0372D;">:req-un</span> <span style="color: #909183;">[</span><span style="color: #D0372D;">::</span><span style="color: #6434A3;">transformation.reverse-geocode</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">args</span>
            <span style="color: #D0372D;">::</span><span style="color: #6434A3;">transformation.engine</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">onError</span><span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">defmethod</span> <span style="color: #006699;">op-spec-type</span> <span style="color: #008000;">"core/to-lowercase"</span> <span style="color: #7388D6;">[</span>_<span style="color: #7388D6;">]</span>
  <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/keys
   <span style="color: #D0372D;">:req-un</span> <span style="color: #909183;">[</span><span style="color: #D0372D;">::</span><span style="color: #6434A3;">transformations.to-lowercase.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">args</span>
            <span style="color: #D0372D;">::</span><span style="color: #6434A3;">transformation.engine</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">onError</span><span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">defmethod</span> <span style="color: #006699;">op-spec-type</span> <span style="color: #008000;">"core/to-uppercase"</span> <span style="color: #7388D6;">[</span>_<span style="color: #7388D6;">]</span>
  <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/keys
   <span style="color: #D0372D;">:req-un</span> <span style="color: #909183;">[</span><span style="color: #D0372D;">::</span><span style="color: #6434A3;">transformations.to-uppercase.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">args</span>
            <span style="color: #D0372D;">::</span><span style="color: #6434A3;">transformation.engine</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">onError</span><span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">defmethod</span> <span style="color: #006699;">op-spec-type</span> <span style="color: #008000;">"core/to-titlecase"</span> <span style="color: #7388D6;">[</span>_<span style="color: #7388D6;">]</span>
  <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/keys
   <span style="color: #D0372D;">:req-un</span> <span style="color: #909183;">[</span><span style="color: #D0372D;">::</span><span style="color: #6434A3;">transformations.to-titlecase.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">args</span>
            <span style="color: #D0372D;">::</span><span style="color: #6434A3;">transformation.engine</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">onError</span><span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">defmethod</span> <span style="color: #006699;">op-spec-type</span> <span style="color: #008000;">"core/trim"</span> <span style="color: #7388D6;">[</span>_<span style="color: #7388D6;">]</span>
  <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/keys
   <span style="color: #D0372D;">:req-un</span> <span style="color: #909183;">[</span><span style="color: #D0372D;">::</span><span style="color: #6434A3;">transformations.trim.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">args</span>
            <span style="color: #D0372D;">::</span><span style="color: #6434A3;">transformation.engine</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">onError</span><span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">defmethod</span> <span style="color: #006699;">op-spec-type</span> <span style="color: #008000;">"core/trim-doublespace"</span> <span style="color: #7388D6;">[</span>_<span style="color: #7388D6;">]</span>
  <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/keys
   <span style="color: #D0372D;">:req-un</span> <span style="color: #909183;">[</span><span style="color: #D0372D;">::</span><span style="color: #6434A3;">transformations.trim.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">args</span>
            <span style="color: #D0372D;">::</span><span style="color: #6434A3;">transformation.engine</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">onError</span><span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::transformation.engine/op-spec</span>
  <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/multi-spec op-spec-type <span style="color: #D0372D;">::</span><span style="color: #6434A3;">transformation.engine</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">op</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::transformation.engine/try-apply-operation-args</span>
  <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/cat <span style="color: #D0372D;">:tenant-conn</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">db.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">spec</span>
         <span style="color: #D0372D;">:table-name</span> string?
         <span style="color: #D0372D;">:columns</span> <span style="color: #909183;">(</span><span style="color: #6434A3;">s</span>/coll-of <span style="color: #D0372D;">::</span><span style="color: #6434A3;">dataset.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">column</span> <span style="color: #D0372D;">:gen-max</span> 3<span style="color: #909183;">)</span>
         <span style="color: #D0372D;">:op-spec</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">transformation.engine</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">op-spec</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::transformation.engine/success?</span> boolean?<span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::transformation.engine/message</span> string?<span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::transformation.engine/columns</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/coll-of <span style="color: #D0372D;">::</span><span style="color: #6434A3;">lib.dataset</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">column</span> <span style="color: #D0372D;">:gen-max</span> 3<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::transformation.engine/execution-log</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/tuple string?<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::transformation.engine/try-apply-operation-ret</span>
  <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/keys <span style="color: #D0372D;">:req-un</span> <span style="color: #909183;">[</span><span style="color: #D0372D;">::</span><span style="color: #6434A3;">transformation.engine</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">success?</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">transformation.engine</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">message</span> <span style="color: #909183;">]</span>
          <span style="color: #D0372D;">:opt-un</span> <span style="color: #909183;">[</span><span style="color: #D0372D;">::</span><span style="color: #6434A3;">transformation.engine</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">columns</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">transformation.engine</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">execution-log</span> <span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>


<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::transformation.engine/execute-transformation-args</span>
  <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/cat <span style="color: #D0372D;">:tenant-conn</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">db.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">spec</span>
         <span style="color: #D0372D;">:dataset-id</span> string?
         <span style="color: #D0372D;">:job-execution-id</span> string?
         <span style="color: #D0372D;">:transformation</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">transformation</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">transformation</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::transformation.engine/execute-undo-args</span>
  <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/cat <span style="color: #D0372D;">:tenant-conn</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">db.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">spec</span>
         <span style="color: #D0372D;">:dataset-id</span> string?
         <span style="color: #D0372D;">:job-execution-id</span> string?<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>


<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::transformation.engine/next-column-name-args</span>
  <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/coll-of <span style="color: #D0372D;">::</span><span style="color: #6434A3;">dataset.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">column</span> <span style="color: #D0372D;">:gen-max</span> 3<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::transformation/transformation</span>
  <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/with-gen
    <span style="color: #909183;">(</span><span style="color: #6434A3;">s</span>/and <span style="color: #D0372D;">::</span><span style="color: #6434A3;">transformation.engine</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">op-spec</span> <span style="color: #6434A3;">transformation.engine</span>/valid?<span style="color: #909183;">)</span> 
    #<span style="color: #909183;">(</span><span style="color: #6434A3;">s</span>/gen #<span style="color: #709870;">{</span><span style="color: #907373;">{</span><span style="color: #D0372D;">:op</span> <span style="color: #008000;">"core/trim"</span>
               <span style="color: #D0372D;">:args</span> <span style="color: #6276BA;">{</span><span style="color: #008000;">"columnName"</span> <span style="color: #008000;">"a"</span><span style="color: #6276BA;">}</span>
               <span style="color: #D0372D;">:onError</span> <span style="color: #008000;">"leave-empty"</span><span style="color: #907373;">}</span><span style="color: #709870;">}</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::transformation/type</span> #<span style="color: #7388D6;">{</span><span style="color: #D0372D;">:transformation</span> <span style="color: #D0372D;">:undo</span><span style="color: #7388D6;">}</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">defmulti</span> <span style="color: #006699;">transformation-type</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">transformation</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">type</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">defmethod</span> <span style="color: #006699;">transformation-type</span> <span style="color: #D0372D;">:undo</span> <span style="color: #7388D6;">[</span>_<span style="color: #7388D6;">]</span>
  <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/keys <span style="color: #D0372D;">:req</span> <span style="color: #909183;">[</span><span style="color: #D0372D;">::</span><span style="color: #6434A3;">transformation</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">type</span><span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">defmethod</span> <span style="color: #006699;">transformation-type</span> <span style="color: #D0372D;">:transformation</span> <span style="color: #7388D6;">[</span>_<span style="color: #7388D6;">]</span>
  <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/keys <span style="color: #D0372D;">:req-un</span> <span style="color: #909183;">[</span><span style="color: #D0372D;">::</span><span style="color: #6434A3;">transformation</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">transformation</span><span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::transformation/command</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/multi-spec transformation-type <span style="color: #D0372D;">::</span><span style="color: #6434A3;">transformation</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">type</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::transformation/apply-args</span>
  <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/cat <span style="color: #D0372D;">:tenant-conn</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">db.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">spec</span>
         <span style="color: #D0372D;">:dataset-id</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">lumen.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">str-uuid</span>
         <span style="color: #D0372D;">:command</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">transformation</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">command</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>
</div>
</li>
</ol>
</div>

<div id="outline-container-org6dbc774" class="outline-4">
<h4 id="org6dbc774"><span class="section-number-4">1.10.3</span> funs</h4>
<div class="outline-text-4" id="text-1-10-3">
<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/fdef <span style="color: #6434A3;">transformation.engine</span>/error-strategy
  <span style="color: #D0372D;">:ret</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">transformation.engine</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">onError</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/fdef <span style="color: #6434A3;">engine</span>/try-apply-operation
  <span style="color: #D0372D;">:args</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">transformation.engine</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">try-apply-operation-args</span>
  <span style="color: #D0372D;">:ret</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">transformation.engine</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">try-apply-operation-ret</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/fdef <span style="color: #6434A3;">engine</span>/execute-transformation
  <span style="color: #D0372D;">:args</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">transformation.engine</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">execute-transformation-args</span>
  <span style="color: #D0372D;">:ret</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">lib</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">response</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/fdef <span style="color: #6434A3;">engine</span>/execute-undo
  <span style="color: #D0372D;">:args</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">transformation.engine</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">execute-undo-args</span>
  <span style="color: #D0372D;">:ret</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">lib</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">response</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/fdef <span style="color: #6434A3;">engine</span>/next-column-name
  <span style="color: #D0372D;">:args</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/cat <span style="color: #D0372D;">:columns</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">transformation.engine</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">next-column-name-args</span><span style="color: #7388D6;">)</span>
  <span style="color: #D0372D;">:ret</span> string?<span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/fdef <span style="color: #6434A3;">transformation</span>/apply
  <span style="color: #D0372D;">:args</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">transformation</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">apply-args</span><span style="color: #707183;">)</span>


</pre>
</div>
</div>
</div>



<div id="outline-container-org9768a4f" class="outline-4">
<h4 id="org9768a4f"><span class="section-number-4">1.10.4</span> derive</h4>
<div class="outline-text-4" id="text-1-10-4">
<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::transformation.derive/code</span> string?<span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::transformation.derive/column-title</span> string?<span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::transformation.derive/column-type</span> #<span style="color: #7388D6;">{</span><span style="color: #008000;">"text"</span> <span style="color: #008000;">"number"</span> <span style="color: #008000;">"date"</span> <span style="color: #008000;">"geopoint"</span><span style="color: #7388D6;">}</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/<span style="color: #0000FF;">def</span> <span style="color: #006699;">::transformation.derive/args</span>
  <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/keys <span style="color: #D0372D;">:req</span> <span style="color: #909183;">[</span><span style="color: #D0372D;">::</span><span style="color: #6434A3;">transformation.derive</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">code</span>
                <span style="color: #D0372D;">::</span><span style="color: #6434A3;">transformation.derive</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">column-title</span>
                <span style="color: #D0372D;">::</span><span style="color: #6434A3;">transformation.derive</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">column-type</span><span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/fdef <span style="color: #6434A3;">derive</span>/args <span style="color: #D0372D;">:ret</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">transformation.derive</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">args</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/fdef <span style="color: #6434A3;">derive</span>/handle-transform-exception
  <span style="color: #D0372D;">:args</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/cat <span style="color: #D0372D;">:exn</span> <span style="color: #6434A3;">lumen.s</span>/exception? <span style="color: #D0372D;">:conn</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">db.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">spec</span>
               <span style="color: #D0372D;">:on-error</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">engine</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">error-strategy</span>
               <span style="color: #D0372D;">:table-name</span> string?
               <span style="color: #D0372D;">:column-name</span> string?
               <span style="color: #D0372D;">:rnum</span> int?<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>


<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/valid? <span style="color: #D0372D;">::</span><span style="color: #6434A3;">transformation.engine</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">next-column-name-args</span> <span style="color: #7388D6;">[</span><span style="color: #909183;">{</span><span style="color: #D0372D;">:type</span> <span style="color: #008000;">"number"</span>, <span style="color: #D0372D;">:title</span> <span style="color: #008000;">"Xft5k37h5k9q030Y2dy87"</span>, <span style="color: #D0372D;">:hidden</span> <span style="color: #D0372D;">true</span>, <span style="color: #D0372D;">:direction</span> <span style="color: #D0372D;">nil</span>, <span style="color: #D0372D;">:columnName</span> <span style="color: #008000;">"d2"</span>, <span style="color: #D0372D;">:sort</span> <span style="color: #D0372D;">nil</span><span style="color: #909183;">}</span><span style="color: #7388D6;">]</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #6434A3;">transformation.engine</span>/next-column-name <span style="color: #7388D6;">[</span><span style="color: #909183;">{</span><span style="color: #D0372D;">:type</span> <span style="color: #008000;">"number"</span>, <span style="color: #D0372D;">:title</span> <span style="color: #008000;">"Xft5k37h5k9q030Y2dy87"</span>, <span style="color: #D0372D;">:hidden</span> <span style="color: #D0372D;">true</span>, <span style="color: #D0372D;">:direction</span> <span style="color: #D0372D;">nil</span>, <span style="color: #D0372D;">:columnName</span> <span style="color: #008000;">"d2"</span>, <span style="color: #D0372D;">:sort</span> <span style="color: #D0372D;">nil</span><span style="color: #909183;">}</span><span style="color: #7388D6;">]</span><span style="color: #707183;">)</span>

</pre>
</div>
</div>
</div>


<div id="outline-container-org26b4dc1" class="outline-4">
<h4 id="org26b4dc1"><span class="section-number-4">1.10.5</span> js-engine</h4>
<div class="outline-text-4" id="text-1-10-5">
<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #707183;">(</span>require '<span style="color: #7388D6;">[</span>akvo.lumen.transformation.derive.js-engine <span style="color: #D0372D;">:as</span> js-engine<span style="color: #7388D6;">]</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span>require '<span style="color: #7388D6;">[</span>akvo.lumen.transformation.engine <span style="color: #D0372D;">:as</span> engine<span style="color: #7388D6;">]</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #6434A3;">s</span>/fdef <span style="color: #6434A3;">js-engine</span>/valid-type? <span style="color: #D0372D;">:args</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">s</span>/cat
                                     <span style="color: #D0372D;">:value</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">lumen.s</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">any</span>
                                     <span style="color: #D0372D;">:type</span> <span style="color: #D0372D;">::</span><span style="color: #6434A3;">engine</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">js-value-types</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>


</pre>
</div>
</div>
</div>



<div id="outline-container-org94e6ecc" class="outline-4">
<h4 id="org94e6ecc"><span class="section-number-4">1.10.6</span> data sample</h4>
<div class="outline-text-4" id="text-1-10-6">
<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #707183;">(</span><span style="color: #0000FF;">in-ns</span> 'akvo.lumen.specs.transformations<span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">defn</span> <span style="color: #006699;">validate-cmd</span> <span style="color: #7388D6;">[</span>m<span style="color: #7388D6;">]</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">if</span> <span style="color: #909183;">(</span>not <span style="color: #709870;">(</span><span style="color: #6434A3;">s</span>/valid? <span style="color: #D0372D;">::</span><span style="color: #6434A3;">transformation</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">command</span> m<span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #6434A3;">s</span>/explain <span style="color: #D0372D;">::</span><span style="color: #6434A3;">transformation</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">command</span> m<span style="color: #909183;">)</span>
    <span style="color: #D0372D;">true</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #008000;">"core/sort-column"</span>
<span style="color: #707183;">(</span>validate-cmd <span style="color: #7388D6;">{</span><span style="color: #D0372D;">:</span><span style="color: #6434A3;">akvo.lumen.transformation</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">type</span> <span style="color: #D0372D;">:transformation</span>,
               <span style="color: #D0372D;">:transformation</span> <span style="color: #909183;">{</span><span style="color: #D0372D;">:args</span> <span style="color: #709870;">{</span><span style="color: #D0372D;">:columnName</span> <span style="color: #008000;">"c1"</span>, <span style="color: #D0372D;">:sortDirection</span> <span style="color: #008000;">"DESC"</span><span style="color: #709870;">}</span>,
                                <span style="color: #D0372D;">:onError</span> <span style="color: #008000;">"fail"</span>,
                                <span style="color: #D0372D;">:</span><span style="color: #6434A3;">akvo.lumen.transformation.engine</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">op</span> <span style="color: #008000;">"core/sort-column"</span><span style="color: #909183;">}</span><span style="color: #7388D6;">}</span><span style="color: #707183;">)</span>

<span style="color: #008000;">"core/remove-sort"</span>
<span style="color: #707183;">(</span>validate-cmd  <span style="color: #7388D6;">{</span><span style="color: #D0372D;">:transformation</span>
                <span style="color: #909183;">{</span><span style="color: #D0372D;">:args</span> <span style="color: #709870;">{</span><span style="color: #D0372D;">:columnName</span> <span style="color: #008000;">"c1"</span><span style="color: #709870;">}</span>,
                 <span style="color: #D0372D;">:onError</span> <span style="color: #008000;">"fail"</span>,
                 <span style="color: #D0372D;">:</span><span style="color: #6434A3;">akvo.lumen.transformation.engine</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">op</span> <span style="color: #008000;">"core/remove-sort"</span><span style="color: #909183;">}</span>,
                <span style="color: #D0372D;">:</span><span style="color: #6434A3;">akvo.lumen.transformation</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">type</span> <span style="color: #D0372D;">:transformation</span><span style="color: #7388D6;">}</span><span style="color: #707183;">)</span>

<span style="color: #008000;">"core/rename-column"</span>
<span style="color: #707183;">(</span>validate-cmd <span style="color: #7388D6;">{</span><span style="color: #D0372D;">:transformation</span>
               <span style="color: #909183;">{</span><span style="color: #D0372D;">:args</span> <span style="color: #709870;">{</span><span style="color: #D0372D;">:columnName</span> <span style="color: #008000;">"c1"</span>, <span style="color: #D0372D;">:newColumnTitle</span> <span style="color: #008000;">"col1bis"</span><span style="color: #709870;">}</span>,
                <span style="color: #D0372D;">:onError</span> <span style="color: #008000;">"fail"</span>,
                <span style="color: #D0372D;">:</span><span style="color: #6434A3;">akvo.lumen.transformation.engine</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">op</span> <span style="color: #008000;">"core/rename-column"</span><span style="color: #909183;">}</span>,
               <span style="color: #D0372D;">:</span><span style="color: #6434A3;">akvo.lumen.transformation</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">type</span> <span style="color: #D0372D;">:transformation</span><span style="color: #7388D6;">}</span><span style="color: #707183;">)</span>

<span style="color: #008000;">"core/delete-column"</span>
<span style="color: #707183;">(</span>validate-cmd <span style="color: #7388D6;">{</span><span style="color: #D0372D;">:transformation</span>
               <span style="color: #909183;">{</span><span style="color: #D0372D;">:args</span> <span style="color: #709870;">{</span><span style="color: #D0372D;">:columnName</span> <span style="color: #008000;">"c1"</span><span style="color: #709870;">}</span>,
                <span style="color: #D0372D;">:onError</span> <span style="color: #008000;">"fail"</span>,
                <span style="color: #D0372D;">:</span><span style="color: #6434A3;">akvo.lumen.transformation.engine</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">op</span> <span style="color: #008000;">"core/delete-column"</span><span style="color: #909183;">}</span>,
               <span style="color: #D0372D;">:</span><span style="color: #6434A3;">akvo.lumen.transformation</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">type</span> <span style="color: #D0372D;">:transformation</span><span style="color: #7388D6;">}</span><span style="color: #707183;">)</span>

<span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">undo</span>
<span style="color: #707183;">(</span>validate-cmd <span style="color: #7388D6;">{</span><span style="color: #D0372D;">:</span><span style="color: #6434A3;">akvo.lumen.transformation</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">type</span> <span style="color: #D0372D;">:undo</span>,
               <span style="color: #D0372D;">:transformation</span> <span style="color: #D0372D;">nil</span><span style="color: #7388D6;">}</span><span style="color: #707183;">)</span>

<span style="color: #008000;">"core/filter-column"</span>
<span style="color: #707183;">(</span>validate-cmd <span style="color: #7388D6;">{</span><span style="color: #D0372D;">:transformation</span>
               <span style="color: #909183;">{</span><span style="color: #D0372D;">:args</span> <span style="color: #709870;">{</span><span style="color: #D0372D;">:columnName</span> <span style="color: #008000;">"c1"</span>, <span style="color: #D0372D;">:expression</span> <span style="color: #907373;">{</span><span style="color: #D0372D;">:is</span> <span style="color: #008000;">"b"</span><span style="color: #907373;">}</span><span style="color: #709870;">}</span>,
                <span style="color: #D0372D;">:onError</span> <span style="color: #008000;">"fail"</span>,
                <span style="color: #D0372D;">:</span><span style="color: #6434A3;">akvo.lumen.transformation.engine</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">op</span> <span style="color: #008000;">"core/filter-column"</span><span style="color: #909183;">}</span>,
               <span style="color: #D0372D;">:</span><span style="color: #6434A3;">akvo.lumen.transformation</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">type</span> <span style="color: #D0372D;">:transformation</span><span style="color: #7388D6;">}</span><span style="color: #707183;">)</span>

<span style="color: #008000;">"core/trim"</span>
<span style="color: #707183;">(</span>validate-cmd <span style="color: #7388D6;">{</span><span style="color: #D0372D;">:transformation</span>
               <span style="color: #909183;">{</span><span style="color: #D0372D;">:args</span> <span style="color: #709870;">{</span><span style="color: #D0372D;">:columnName</span> <span style="color: #008000;">"c1"</span>, <span style="color: #D0372D;">:defaultValue</span> <span style="color: #D0372D;">nil</span><span style="color: #709870;">}</span>,
                <span style="color: #D0372D;">:onError</span> <span style="color: #008000;">"default-value"</span>,
                <span style="color: #D0372D;">:</span><span style="color: #6434A3;">akvo.lumen.transformation.engine</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">op</span> <span style="color: #008000;">"core/trim"</span><span style="color: #909183;">}</span>,
               <span style="color: #D0372D;">:</span><span style="color: #6434A3;">akvo.lumen.transformation</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">type</span> <span style="color: #D0372D;">:transformation</span><span style="color: #7388D6;">}</span><span style="color: #707183;">)</span>

<span style="color: #008000;">"core/trim-doublespace"</span>
<span style="color: #707183;">(</span>validate-cmd <span style="color: #7388D6;">{</span><span style="color: #D0372D;">:transformation</span>
               <span style="color: #909183;">{</span><span style="color: #D0372D;">:args</span> <span style="color: #709870;">{</span><span style="color: #D0372D;">:columnName</span> <span style="color: #008000;">"c1"</span>, <span style="color: #D0372D;">:defaultValue</span> <span style="color: #D0372D;">nil</span><span style="color: #709870;">}</span>,
                <span style="color: #D0372D;">:onError</span> <span style="color: #008000;">"default-value"</span>,
                <span style="color: #D0372D;">:</span><span style="color: #6434A3;">akvo.lumen.transformation.engine</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">op</span> <span style="color: #008000;">"core/trim-doublespace"</span><span style="color: #909183;">}</span>,
               <span style="color: #D0372D;">:</span><span style="color: #6434A3;">akvo.lumen.transformation</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">type</span> <span style="color: #D0372D;">:transformation</span><span style="color: #7388D6;">}</span><span style="color: #707183;">)</span>

<span style="color: #008000;">"core/to-uppercase"</span>
<span style="color: #707183;">(</span>validate-cmd <span style="color: #7388D6;">{</span><span style="color: #D0372D;">:transformation</span>
               <span style="color: #909183;">{</span><span style="color: #D0372D;">:args</span> <span style="color: #709870;">{</span><span style="color: #D0372D;">:columnName</span> <span style="color: #008000;">"c1"</span>, <span style="color: #D0372D;">:defaultValue</span> <span style="color: #D0372D;">nil</span><span style="color: #709870;">}</span>,
                <span style="color: #D0372D;">:onError</span> <span style="color: #008000;">"default-value"</span>,
                <span style="color: #D0372D;">:</span><span style="color: #6434A3;">akvo.lumen.transformation.engine</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">op</span> <span style="color: #008000;">"core/to-uppercase"</span><span style="color: #909183;">}</span>,
               <span style="color: #D0372D;">:</span><span style="color: #6434A3;">akvo.lumen.transformation</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">type</span> <span style="color: #D0372D;">:transformation</span><span style="color: #7388D6;">}</span><span style="color: #707183;">)</span>

<span style="color: #008000;">"core/to-lowercase"</span>
<span style="color: #707183;">(</span>validate-cmd <span style="color: #7388D6;">{</span><span style="color: #D0372D;">:transformation</span>
               <span style="color: #909183;">{</span><span style="color: #D0372D;">:args</span> <span style="color: #709870;">{</span><span style="color: #D0372D;">:columnName</span> <span style="color: #008000;">"c1"</span>, <span style="color: #D0372D;">:defaultValue</span> <span style="color: #D0372D;">nil</span><span style="color: #709870;">}</span>,
                <span style="color: #D0372D;">:onError</span> <span style="color: #008000;">"default-value"</span>,
                <span style="color: #D0372D;">:</span><span style="color: #6434A3;">akvo.lumen.transformation.engine</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">op</span> <span style="color: #008000;">"core/to-lowercase"</span><span style="color: #909183;">}</span>,
               <span style="color: #D0372D;">:</span><span style="color: #6434A3;">akvo.lumen.transformation</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">type</span> <span style="color: #D0372D;">:transformation</span><span style="color: #7388D6;">}</span><span style="color: #707183;">)</span>

<span style="color: #008000;">"core/to-titlecase"</span>
<span style="color: #707183;">(</span>validate-cmd <span style="color: #7388D6;">{</span><span style="color: #D0372D;">:transformation</span>
               <span style="color: #909183;">{</span><span style="color: #D0372D;">:args</span> <span style="color: #709870;">{</span><span style="color: #D0372D;">:columnName</span> <span style="color: #008000;">"c1"</span>, <span style="color: #D0372D;">:defaultValue</span> <span style="color: #D0372D;">nil</span><span style="color: #709870;">}</span>,
                <span style="color: #D0372D;">:onError</span> <span style="color: #008000;">"default-value"</span>,
                <span style="color: #D0372D;">:</span><span style="color: #6434A3;">akvo.lumen.transformation.engine</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">op</span> <span style="color: #008000;">"core/to-titlecase"</span><span style="color: #909183;">}</span>,
               <span style="color: #D0372D;">:</span><span style="color: #6434A3;">akvo.lumen.transformation</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">type</span> <span style="color: #D0372D;">:transformation</span><span style="color: #7388D6;">}</span><span style="color: #707183;">)</span>

<span style="color: #008000;">"core/combine"</span>
<span style="color: #707183;">(</span>validate-cmd <span style="color: #7388D6;">{</span><span style="color: #D0372D;">:transformation</span>
               <span style="color: #909183;">{</span><span style="color: #D0372D;">:args</span>
                <span style="color: #709870;">{</span><span style="color: #D0372D;">:columnNames</span> <span style="color: #907373;">[</span><span style="color: #008000;">"c1"</span> <span style="color: #008000;">"c2"</span><span style="color: #907373;">]</span>,
                 <span style="color: #D0372D;">:newColumnTitle</span> <span style="color: #008000;">"combination"</span>,
                 <span style="color: #D0372D;">:separator</span> <span style="color: #008000;">" "</span><span style="color: #709870;">}</span>,
                <span style="color: #D0372D;">:onError</span> <span style="color: #008000;">"fail"</span>,
                <span style="color: #D0372D;">:</span><span style="color: #6434A3;">akvo.lumen.transformation.engine</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">op</span> <span style="color: #008000;">"core/combine"</span><span style="color: #909183;">}</span>,
               <span style="color: #D0372D;">:</span><span style="color: #6434A3;">akvo.lumen.transformation</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">type</span> <span style="color: #D0372D;">:transformation</span><span style="color: #7388D6;">}</span><span style="color: #707183;">)</span>


<span style="color: #008000;">"core/derive"</span>
<span style="color: #707183;">(</span>validate-cmd <span style="color: #7388D6;">{</span><span style="color: #D0372D;">:transformation</span>
               <span style="color: #909183;">{</span><span style="color: #D0372D;">:args</span>
                <span style="color: #709870;">{</span><span style="color: #D0372D;">:code</span> <span style="color: #008000;">"row[</span><span style="color: #000000; font-weight: bold;">\"</span><span style="color: #008000;">col1bis</span><span style="color: #000000; font-weight: bold;">\"</span><span style="color: #008000;">]+</span><span style="color: #000000; font-weight: bold;">\"</span><span style="color: #008000;"> test </span><span style="color: #000000; font-weight: bold;">\"</span><span style="color: #008000;">+row[</span><span style="color: #000000; font-weight: bold;">\"</span><span style="color: #008000;">col3</span><span style="color: #000000; font-weight: bold;">\"</span><span style="color: #008000;">]"</span>,
                 <span style="color: #D0372D;">:newColumnTitle</span> <span style="color: #008000;">"d3"</span>,
                 <span style="color: #D0372D;">:newColumnType</span> <span style="color: #008000;">"text"</span><span style="color: #709870;">}</span>,
                <span style="color: #D0372D;">:onError</span> <span style="color: #008000;">"leave-empty"</span>,
                <span style="color: #D0372D;">:</span><span style="color: #6434A3;">akvo.lumen.transformation.engine</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">op</span> <span style="color: #008000;">"core/derive"</span><span style="color: #909183;">}</span>,
               <span style="color: #D0372D;">:</span><span style="color: #6434A3;">akvo.lumen.transformation</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">type</span> <span style="color: #D0372D;">:transformation</span><span style="color: #7388D6;">}</span><span style="color: #707183;">)</span>

<span style="color: #008000;">"core/generate-geopoints"</span>
<span style="color: #707183;">(</span>validate-cmd <span style="color: #7388D6;">{</span><span style="color: #D0372D;">:transformation</span>
               <span style="color: #909183;">{</span><span style="color: #D0372D;">:args</span>
                <span style="color: #709870;">{</span><span style="color: #D0372D;">:ColumnTitleGeo</span> <span style="color: #008000;">""</span>,
                 <span style="color: #D0372D;">:columnNameLat</span> <span style="color: #008000;">"c2"</span>,
                 <span style="color: #D0372D;">:columnNameLong</span> <span style="color: #008000;">"c3"</span>,
                 <span style="color: #D0372D;">:columnTitleGeo</span> <span style="color: #008000;">"gp1"</span><span style="color: #709870;">}</span>,
                <span style="color: #D0372D;">:onError</span> <span style="color: #008000;">"fail"</span>,
                <span style="color: #D0372D;">:</span><span style="color: #6434A3;">akvo.lumen.transformation.engine</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">op</span> <span style="color: #008000;">"core/generate-geopoints"</span><span style="color: #909183;">}</span>,
               <span style="color: #D0372D;">:</span><span style="color: #6434A3;">akvo.lumen.transformation</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">type</span> <span style="color: #D0372D;">:transformation</span><span style="color: #7388D6;">}</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span>validate-cmd <span style="color: #7388D6;">{</span><span style="color: #D0372D;">:transformation</span>
               <span style="color: #909183;">{</span><span style="color: #D0372D;">:args</span>
                <span style="color: #709870;">{</span><span style="color: #D0372D;">:source</span>
                 <span style="color: #907373;">{</span><span style="color: #D0372D;">:aggregationColumn</span> <span style="color: #008000;">"c1"</span>,
                  <span style="color: #D0372D;">:aggregationDirection</span> <span style="color: #008000;">"DESC"</span>,
                  <span style="color: #D0372D;">:datasetId</span> <span style="color: #008000;">"5b27ca89-221e-4e58-999f-da349713798b"</span>,
                  <span style="color: #D0372D;">:mergeColumn</span> <span style="color: #008000;">"c1"</span>,
                  <span style="color: #D0372D;">:mergeColumns</span> <span style="color: #6276BA;">[</span><span style="color: #008000;">"c1"</span><span style="color: #6276BA;">]</span><span style="color: #907373;">}</span>,
                 <span style="color: #D0372D;">:target</span> <span style="color: #907373;">{</span><span style="color: #D0372D;">:mergeColumn</span> <span style="color: #008000;">"c1"</span><span style="color: #907373;">}</span><span style="color: #709870;">}</span>,
                <span style="color: #D0372D;">:</span><span style="color: #6434A3;">akvo.lumen.transformation.engine</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">op</span> <span style="color: #008000;">"core/merge-datasets"</span><span style="color: #909183;">}</span>,
               <span style="color: #D0372D;">:</span><span style="color: #6434A3;">akvo.lumen.transformation</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #D0372D;">type</span> <span style="color: #D0372D;">:transformation</span><span style="color: #7388D6;">}</span><span style="color: #707183;">)</span>
</pre>
</div>
</div>
</div>
</div>
</div>

<div id="outline-container-org9657543" class="outline-2">
<h2 id="org9657543"><span class="section-number-2">2</span> <span class="todo TODO">TODO</span> specs problems to confront with</h2>
<div class="outline-text-2" id="text-2">
<ul class="org-ul">
<li class="off"><code>[&#xa0;]</code> how to naming alias pivot.row.s &#x2026; so far i've 2 kinds of nss specs ones and normal ones</li>
</ul>
<p>
specs ones ends in <code>.s</code> 
</p>

<p>
the other problem to think about is how long this alias should be &#x2026; and which pattern to apply when we need to reduce naming
</p>
</div>

<div id="outline-container-org13276df" class="outline-3">
<h3 id="org13276df"><span class="section-number-3">2.1</span> <span class="todo TODO">TODO</span> sort maps and connect to CIDER</h3>
<div class="outline-text-3" id="text-2-1">
<p>
<a href="https://github.com/bluekezza/clj-stable-pprint">https://github.com/bluekezza/clj-stable-pprint</a>
</p>
</div>
</div>

<div id="outline-container-orgb9b33b8" class="outline-3">
<h3 id="orgb9b33b8"><span class="section-number-3">2.2</span> <span class="todo TODO">TODO</span> visual diff of clojure data</h3>
</div>
</div>


<div id="outline-container-org8472d57" class="outline-2">
<h2 id="org8472d57"><span class="section-number-2">3</span> tools&#xa0;&#xa0;&#xa0;<span class="tag"><span class="index">index</span></span></h2>
<div class="outline-text-2" id="text-3">
</div>
<div id="outline-container-org1507368" class="outline-3">
<h3 id="org1507368"><span class="section-number-3">3.1</span> dev</h3>
<div class="outline-text-3" id="text-3-1">
</div>
<div id="outline-container-org681accd" class="outline-4">
<h4 id="org681accd"><span class="section-number-4">3.1.1</span> dev tasks</h4>
<div class="outline-text-4" id="text-3-1-1">
</div>
<ol class="org-ol">
<li><a id="orgb46862a"></a>list specs<br />
<div class="outline-text-5" id="text-3-1-1-1">
<div class="org-src-container">
<pre class="src src-shell" id="orgedf1c93">find ../src/akvo/lumen/specs -name <span style="color: #008000;">"*.clj"</span>
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">../src/akvo/lumen/specs/aggregation/pivot/row.clj</td>
</tr>

<tr>
<td class="org-left">../src/akvo/lumen/specs/aggregation/query.clj</td>
</tr>

<tr>
<td class="org-left">../src/akvo/lumen/specs/aggregation.clj</td>
</tr>

<tr>
<td class="org-left">../src/akvo/lumen/specs/config.clj</td>
</tr>

<tr>
<td class="org-left">../src/akvo/lumen/specs/core.clj</td>
</tr>

<tr>
<td class="org-left">../src/akvo/lumen/specs/dataset/column.clj</td>
</tr>

<tr>
<td class="org-left">../src/akvo/lumen/specs/dataset.clj</td>
</tr>

<tr>
<td class="org-left">../src/akvo/lumen/specs/db.clj</td>
</tr>

<tr>
<td class="org-left">../src/akvo/lumen/specs/libs.clj</td>
</tr>

<tr>
<td class="org-left">../src/akvo/lumen/specs/transformations/merge<sub>dataset</sub>/source.clj</td>
</tr>

<tr>
<td class="org-left">../src/akvo/lumen/specs/transformations/merge<sub>dataset</sub>/target.clj</td>
</tr>

<tr>
<td class="org-left">../src/akvo/lumen/specs/transformations/remove<sub>sort.clj</sub></td>
</tr>

<tr>
<td class="org-left">../src/akvo/lumen/specs/transformations/to<sub>lowercase.clj</sub></td>
</tr>

<tr>
<td class="org-left">../src/akvo/lumen/specs/transformations/to<sub>titlecase.clj</sub></td>
</tr>

<tr>
<td class="org-left">../src/akvo/lumen/specs/transformations/to<sub>uppercase.clj</sub></td>
</tr>

<tr>
<td class="org-left">../src/akvo/lumen/specs/transformations/trim.clj</td>
</tr>

<tr>
<td class="org-left">../src/akvo/lumen/specs/transformations/trim<sub>doublespace.clj</sub></td>
</tr>

<tr>
<td class="org-left">../src/akvo/lumen/specs/transformations.clj</td>
</tr>

<tr>
<td class="org-left">../src/akvo/lumen/specs/visualisation/layer/legend.clj</td>
</tr>

<tr>
<td class="org-left">../src/akvo/lumen/specs/visualisation/layer/spec.clj</td>
</tr>

<tr>
<td class="org-left">../src/akvo/lumen/specs/visualisation/layer.clj</td>
</tr>

<tr>
<td class="org-left">../src/akvo/lumen/specs/visualisation.clj</td>
</tr>
</tbody>
</table>



<div class="org-src-container">
<pre class="src src-elisp">
<span style="color: #707183;">(</span>mapcar <span style="color: #7388D6;">(</span><span style="color: #0000FF;">lambda</span> <span style="color: #909183;">(</span>file<span style="color: #909183;">)</span>
          <span style="color: #909183;">(</span><span style="color: #0000FF;">let*</span> <span style="color: #709870;">(</span><span style="color: #907373;">(</span>x <span style="color: #6276BA;">(</span>s-replace <span style="color: #008000;">"../src/akvo/lumen/specs/"</span> <span style="color: #008000;">""</span> <span style="color: #858580;">(</span>car file<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>
                 <span style="color: #907373;">(</span>y <span style="color: #6276BA;">(</span>s-replace <span style="color: #008000;">".clj"</span> <span style="color: #008000;">".org"</span> x <span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>
                 <span style="color: #907373;">(</span>z <span style="color: #6276BA;">(</span>concat <span style="color: #008000;">"#+INCLUDE: \""</span> y <span style="color: #008000;">"\""</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span>
                 z<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span> <span style="color: #ff0000; font-weight: bold;">res</span><span style="color: #707183; font-weight: bold;">)</span>



</pre>
</div>

<ul class="org-ul">
<li>#+INCLUDE: "config.org"</li>
<li>#+INCLUDE: "core.org"</li>
<li>#+INCLUDE: "db.org"</li>
<li>#+INCLUDE: "libs.org"</li>
<li>#+INCLUDE: "transformations.org"</li>
</ul>
</div>
</li>



<li><a id="orgd8477ba"></a>remove compiled specs<br />
<div class="outline-text-5" id="text-3-1-1-2">
<div class="org-src-container">
<pre class="src src-shell">find ../src/akvo/lumen/specs/*.clj | xargs rm

</pre>
</div>
</div>
</li>



<li><a id="org39f6bfd"></a>compile specs<br />
<div class="outline-text-5" id="text-3-1-1-3">
<p>
Taken from <a href="https://github.com/thi-ng/babel/blob/master/src/leiningen/new/thing_babel/tangle.sh">https://github.com/thi-ng/babel/blob/master/src/leiningen/new/thing_babel/tangle.sh</a>
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #707183;">(</span>mapc <span style="color: #7388D6;">(</span><span style="color: #0000FF;">lambda</span> <span style="color: #909183;">(</span>file<span style="color: #909183;">)</span>
            <span style="color: #909183;">(</span>find-file <span style="color: #709870;">(</span>expand-file-name file <span style="color: #008000;">"."</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
            <span style="color: #909183;">(</span>org-babel-tangle<span style="color: #909183;">)</span>
            <span style="color: #909183;">(</span>kill-buffer<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span> '<span style="color: #7388D6;">(</span><span style="color: #008000;">"db.org"</span> <span style="color: #008000;">"core.org"</span> <span style="color: #008000;">"config.org"</span>
                             <span style="color: #008000;">"libs.org"</span> <span style="color: #008000;">"endpoints.org"</span> <span style="color: #008000;">"transformations.org"</span>
                             <span style="color: #008000;">"imports.org"</span> <span style="color: #008000;">"components.org"</span> <span style="color: #008000;">"aggregation.org"</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span> 
</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>


<div id="outline-container-org3b6275d" class="outline-2">
<h2 id="org3b6275d"><span class="section-number-2">4</span> learning LP</h2>
<div class="outline-text-2" id="text-4">
</div>
<div id="outline-container-org98b693a" class="outline-3">
<h3 id="org98b693a"><span class="section-number-3">4.1</span> tagging by domain, keep generic/abstract</h3>
<div class="outline-text-3" id="text-4-1">
<p>
so instead of tag <code>tenant_manager</code> use <code>db</code>
</p>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: tangrammer</p>
<p class="date">Created: 2018-06-20 Wed 16:03</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
